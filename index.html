<!DOCTYPE html> 
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#007bff"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="StockWise">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
 
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #007BFF, #0056b3);
            --danger-color: #DC3545; --success-color: #28a745; --warning-color: #ffc107;
            --level-low-bg: #fff3cd; --level-very-low-bg: #f8d7da; --level-critical-bg: #e4000f;
            --level-critical-text: #ffffff; --dark-text: #212529; --light-text: #ffffff;
            --border-color: #e0e0e0; --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            --base-font-size: 12px;
        }
        body {
            font-family: 'Noto Sans Bengali', sans-serif; background-color: #f4f6f9;
            color: var(--dark-text); margin: 0; padding-top: 108px;
            font-size: var(--base-font-size);
        }
        .header {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
            background: var(--primary-gradient); color: var(--light-text);
            padding: 15px 20px; text-align: center; box-shadow: var(--shadow);
        }
        .header h1 { margin: 0; font-size: 18px; }
        .main-nav {
            position: fixed; top: 54px; left: 0; width: 100%; z-index: 999;
            display: flex; background-color: #ffffff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .nav-tab {
            flex: 1; padding: 14px 10px; text-align: center; cursor: pointer;
            font-weight: 500; border-bottom: 3px solid transparent; transition: all 0.3s ease;
        }
        .nav-tab.active { color: #0056b3; border-bottom-color: #0056b3; }
        .page { display: none; }
        .page.active { display: block; }

        .container { padding: 15px; max-width: 1200px; margin: 0 auto; }
        .action-bar { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .action-bar button { flex: 1; max-width: 250px; }

        .action-btn, .add-item-btn, .provide-item-btn {
            padding: 10px 20px; font-size: 14px; color: var(--light-text);
            border-radius: 8px; cursor: pointer; font-weight: 700; border: none;
        }
        .add-item-btn { background: #0056b3; }
        .provide-item-btn { background: var(--warning-color); color: var(--dark-text); }

        .card {
            background: #ffffff; border-radius: 12px; padding: 15px;
            margin-bottom: 15px; box-shadow: var(--shadow);
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { margin: 0; font-weight: 700; font-size: 16px; cursor: pointer; }
        .card-header h2:hover { color: #0056b3; }
        .delete-section-btn { background: none; border: none; color: var(--danger-color); cursor: pointer; font-size: 18px; }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        thead { background: #f1f3f5; }
        
        .level-low { background-color: var(--level-low-bg) !important; }
        .level-very-low { background-color: var(--level-very-low-bg) !important; }
        .level-critical { background-color: var(--level-critical-bg) !important; color: var(--level-critical-text); }
        .level-critical strong { color: var(--level-critical-text); }
        .item-name-cell, .stock-qty-cell { cursor: pointer; font-weight: 500; }
        .item-name-cell:hover, .stock-qty-cell:hover { color: #0056b3; }
        .stock-icon { margin-left: 8px; font-size: 14px; }

        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100vw; /* Viewport Width - ‡¶π‡¶∞‡¶ø‡¶ú‡¶®‡ßç‡¶ü‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤‡¶¨‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∞‡ßã‡¶ß ‡¶ï‡¶∞‡ßá */
            height: 100vh; /* Viewport Height */
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            padding: 15px;
            box-sizing: border-box;
        }

        .modal-overlay.show { display: flex; }
        .modal-content {
            background: #f4f6f9; border-radius: 12px; box-shadow: var(--shadow);
            width: 100%; max-width: 500px; max-height: 90vh;
            display: flex; flex-direction: column;
            animation: modal-pop 0.3s ease-out;
            height: fit-content;
        }
        @keyframes modal-pop {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-header {
            background: white; padding: 12px 15px; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
            border-top-left-radius: 12px; border-top-right-radius: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        .modal-header h2 { margin: 0; font-size: 16px; cursor: pointer; }
        .modal-header h2:hover { color: #0056b3; }
        .close-btn { font-size: 24px; font-weight: bold; cursor: pointer; background: none; border: none; }
        .modal-body { overflow-y: auto; padding: 15px; flex-grow: 1; }
        .modal-footer {
            background: white; padding: 12px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: space-between;
            border-bottom-left-radius: 12px; border-bottom-right-radius: 12px;
            border-top: 1px solid var(--border-color);
        }
        .modal-footer button { padding: 10px 15px; font-size: 13px; border-radius: 8px; cursor: pointer; border: none; font-weight: 700; }
        
        .form-group, .item-form-card {
            background: white; padding: 12px; border-radius: 8px;
            margin-bottom: 12px; box-shadow: var(--shadow); display: grid; gap: 8px;
        }
        .form-group label { font-weight: 500; }
        .form-group input, .form-group select, .item-form-card input, .item-form-card select {
            width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; box-sizing: border-box; font-size: 13px;
        }
        .remove-form-btn { justify-self: end; background: none; border: none; color: var(--danger-color); font-size: 22px; cursor: pointer; padding: 0 5px; }
        #newSectionContainer { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; }
        #newSectionForm { display: grid; grid-template-columns: 1fr auto; gap: 8px; }

        .ledger-entry {
            background: white; border-radius: 8px; padding: 12px;
            margin-bottom: 8px; display: flex;
            justify-content: space-between; align-items: center;
            gap: 12px;
        }
        .ledger-desc { font-weight: 500; font-size: 12px; line-height: 1.5; }
        .ledger-qty { font-size: 15px; font-weight: 700; white-space: nowrap; }
        .ledger-in { color: var(--success-color); }
        .ledger-out { color: var(--danger-color); }
        #load-more-ledger {
            width: 100%;
            margin-top: 8px;
        }
        
        .more-btn { /* ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶®‡¶æ‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã */
            width: auto;
            display: block;
            margin: 10px auto 0 auto;
            padding: 5px 15px;
            font-size: 11px;
            background: #e9ecef;
            color: var(--dark-text);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
        }
        .more-btn:hover {
            background: #dee2e6;
        }

        #user-list .item-row { cursor: default; padding: 10px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;}

        #notification-container { position: fixed; bottom: 20px; right: 20px; z-index: 1002; }
        .toast {
            background-color: var(--success-color); color: white; padding: 12px; border-radius: 8px;
            margin-bottom: 10px; box-shadow: var(--shadow); opacity: 0;
            transition: opacity 0.5s ease, transform 0.5s ease; transform: translateY(20px);
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background-color: var(--danger-color); }
        .toast.warning { background-color: var(--warning-color); color: var(--dark-text); }

        .sliding-notification-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: var(--level-critical-bg); color: white;
            padding: 8px 0; overflow: hidden; white-space: nowrap; z-index: 999;
            display: none;
        }
        .sliding-notification-bar.show { display: block; }
        .sliding-text {
            display: inline-block;
            padding-left: 100%;
            animation-name: marquee;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }
        @keyframes marquee {
            0%   { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }

        @media (max-width: 768px) {
            .card table {
                font-size: 12px;
            }
            .card th, .card td {
                padding: 8px;
            }
        }
        .delete-btn {
            background: none !important;
            border: none !important;
            box-shadow: none !important;
            padding: 5px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stock-cell {
            cursor: pointer;
            text-align: right;
            vertical-align: middle;
        }
        .ledger-section {
            margin-bottom: 20px;
        }
        .ledger-section h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        .load-more-btn {
            width: 100%;
            margin-top: 10px;
            background: #6c757d;
            display: none; /* ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã ‡¶•‡¶æ‡¶ï‡¶¨‡ßá */
        }
        .modal-tabs {
            display: flex;
            background-color: #f1f3f5;
            padding: 5px;
            gap: 5px;
        }
        .ledger-tab {
            flex: 1;
            padding: 10px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            background-color: transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .ledger-tab.active {
            background-color: white;
            color: #0056b3;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .modal-header-actions {
            display: flex;
            align-items: center;
            gap: 10px; /* ‡¶Ü‡¶á‡¶ï‡¶® ‡¶¶‡ßÅ‡¶ü‡¶ø‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶®‡ßç‡¶Ø ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ ‡¶ú‡¶æ‡ßü‡¶ó‡¶æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶¨‡ßá */
        }
        #user-list .user-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        #user-list .user-row:last-child {
            border-bottom: none;
        }
        #user-list .user-name {
            font-weight: 500;
            cursor: pointer;
            flex-grow: 1;
        }
        #user-list .user-name:hover {
            color: #0056b3;
        }
        #user-report-body table {
            width: 100%;
            margin-top: 15px;
            border-collapse: collapse;
        }
        #user-report-body th, #user-report-body td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: left;
        }
        #add-user-form {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
        }
        #add-user-form input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 13px;
        }
        #add-user-form .action-btn {
            background: #0056b3;
        }
        .search-highlight {
            background-color: #fff9c4 !important;
            transition: background-color 0.3s ease-in-out;
        }
        .search-highlight td,
        .search-highlight strong,
        .search-highlight .stock-icon {
            color: var(--dark-text) !important;
        }        
        .search-highlight strong {
            color: var(--dark-text) !important;
        }
        .item-excluded {
            opacity: 0.5;
            text-decoration: line-through;
            background-color: #f8d7da !important;
        }
        #auth-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
        }
        .modal-overlay.show {
            display: flex;
        }
       
        #auth-modal-overlay .modal-content {
            width: 90%;
            max-width: 400px;
            animation: modal-pop 0.3s ease-out;
        }
         #auth-modal-overlay .form-group input {
            font-size: 14px;
            padding: 10px;
        }
        
        #auth-modal-overlay .action-btn {
            padding: 12px;
            font-size: 15px;
        }
       
        #main-app-wrapper {
            transition: filter 0.3s ease-in-out;
        }
        html.modal-open, body.modal-open {
            overflow: hidden;
        }
        .main-app-hidden {
            filter: blur(5px);
            pointer-events: none;
        }

        .select2-container {
            width: 100% !important;
        }
        .select2-container .select2-selection--single {
            height: 38px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 38px;
            padding-left: 12px;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 38px;
        }
        .select2-dropdown {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: var(--shadow);
        }
        .select2-search--dropdown .select2-search__field {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        .select2-container--open {
            z-index: 1051 !important;
        }
        .select2-container--open {
            z-index: 9999 !important;
        }
        @keyframes highlight-animation {
            from { background-color: #fff9c4; }
            to { background-color: transparent; }
        }
        .highlight-flash {
            animation: highlight-animation 4s forwards;
        }   
        @keyframes shake-horizontal {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake-error {
            animation: shake-horizontal 0.5s ease-in-out;
        }
        #back-to-top-btn {
            display: none;
            position: fixed;
            bottom: 60px;
            right: 20px;
            z-index: 998;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #e0e0e0;
            outline: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.8);
        }
        
        #back-to-top-btn svg {
            color: #0056b3;
            width: 24px;
            height: 24px;
        }
        
        #back-to-top-btn.show {
            display: flex;
            opacity: 1;
            visibility: visible;
            transform: scale(1);
        }
        #scroll-to-bottom-btn {
            display: none;
            position: fixed;
            bottom: 115px;
            right: 20px;
            z-index: 998;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #e0e0e0;
            outline: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.8);
        }
        
        #scroll-to-bottom-btn svg {
            color: #0056b3;
            width: 24px;
            height: 24px;
        }
        
        #scroll-to-bottom-btn.show {
            display: flex;
            opacity: 1;
            visibility: visible;
            transform: scale(1);
        }
        
        .ledger-entry {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .stock-cell {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .user-report-row {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        #pin-prompt-modal {
            z-index: 1002;
        }
        #requisitionInputModal .modal-content {
            height: 90vh;
            max-height: 90vh;
        }
        #requisitionInputModal .modal-body {
            padding: 0;
            max-height: calc(90vh - 150px);
        }
        .card-header .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 18px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .card-header .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }
        
  /* User Manual Modal Styles */
        #manualModal .modal-content {
            max-width: 800px; /* ‡¶Æ‡¶°‡¶æ‡¶≤‡¶ü‡¶ø ‡¶ö‡¶ì‡ßú‡¶æ ‡¶π‡¶¨‡ßá */
            height: 90vh;
            max-height: 90vh;
        }
        
        #manualModal .modal-body {
            background-color: #ffffff;
            line-height: 1.7;
            padding: 20px 25px;
        }
        
        #manualModal h3 {
            font-size: 18px;
            color: #0056b3;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 8px;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        
        #manualModal h4 {
            font-size: 16px;
            color: #343a40;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        #manualModal p, #manualModal li {
            font-size: 14px;
            color: #495057;
        }
        
        #manualModal ul {
            padding-left: 20px;
        }
        
        #manualModal strong {
            color: #0056b3;
        }
        
        #manualModal code {
            background-color: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: #c82333;
        }
        .card-body.collapsible.collapsed {
            max-height: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
            overflow: hidden;
            visibility: hidden;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out, visibility 0s linear 0.4s;
        }
        
        .card-body.collapsible {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out, visibility 0s;
            visibility: visible;
        }
        
        .sortable-list {
            list-style: none;
            padding: 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 15px;
            background-color: #f8f9fa;
            overflow-y: auto;
            max-height: 100vh;
        }
        @media (min-width: 768px) {
            .sortable-list {
                max-height: 65vh;
            }
        }        
        .sortable-list li {
            padding: 0;
            background-color: #fff;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .sortable-list li:last-child {
            border-bottom: none;
        }
        
        .drag-handle {
            padding: 8px 15px;
            cursor: grab;
            color: #adb5bd;
            font-size: 20px;
        }
        
        .section-text {
            padding: 8px 15px;
            flex-grow: 1;
        }
        
        .sortable-list li.dragging {
            opacity: 0.7;
            background: #d0eaff;
        }
        .custom-search-container {
            position: relative;
        }
        
        .custom-search-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 13px;
        }
        
        .custom-search-results {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 40vh;
            overflow-y: auto;
            z-index: 1053; /* ‡¶Ö‡¶§‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ */
            box-shadow: var(--shadow);
        }
        
        .custom-search-results.show {
            display: block;
        }
        
        .custom-search-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .custom-search-item:last-child {
            border-bottom: none;
        }
        
        .custom-search-item:hover {
            background-color: #f1f3f5;
        }
        
        .custom-search-item small {
            color: #6c757d;
            display: block;
            font-size: 11px;
            margin-top: 2px;
        }
        #provideItemModal.modal-expanded .modal-content {
            height: 80vh;
            max-height: 700px;
        }
        
        #provideItemModal.modal-compact .modal-content {
            height: auto;
            max-height: 90vh;
        }

    </style>
</head>
<body>
    <!-- Login/Register Modal -->
    <div id="auth-modal-overlay" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div id="login-view">
                <div class="modal-header">
                    <h2>‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                    <button class="close-btn" onclick="handleAuthClose()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="login-form" onsubmit="loginUser(event)">
                        <div class="form-group">
                            <label for="login-email">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label>
                            <input type="email" id="login-email" autocomplete="username" required>
                        </div>
                        <div class="form-group">
                            <label for="login-password">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°</label>
                            <input type="password" id="login-password" autocomplete="current-password" required>
                        </div>
                        <button type="submit" class="action-btn" style="width: 100%; background: var(--primary-gradient);">‡¶≤‡¶ó‡¶á‡¶®</button>
                        <div id="login-status-message" style="text-align: center; margin-top: 15px; font-weight: 500;"></div>
                        </form>
                </div>
                <div class="modal-footer" style="justify-content: center;">
                    <p>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? <a href="#" onclick="toggleAuthView(event)">‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</a></p>
                </div>
            </div>
    
            <div id="register-view" style="display: none;">
                <div class="modal-header">
                    <h2>‡¶®‡¶§‡ßÅ‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                    <button class="close-btn" onclick="handleAuthClose()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="register-form" onsubmit="registerUser(event)">
                        <div class="form-group">
                            <label for="register-email">‡¶á‡¶Æ‡ßá‡¶á‡¶≤</label>
                            <input type="email" id="register-email" autocomplete="username" required>
                        </div>
                        <div class="form-group">
                            <label for="register-password">‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° (‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞)</label>
                            <input type="password" id="register-password" autocomplete="new-password" minlength="6" required>
                        </div>
                        <button type="submit" class="action-btn" style="width: 100%; background: var(--success-color);">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞</button>
                        <div id="register-status-message" style="text-align: center; margin-top: 15px; font-weight: 500;"></div>
                        </form>
                </div>
                <div class="modal-footer" style="justify-content: center;">
                    <p>‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? <a href="#" onclick="toggleAuthView(event)">‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</a></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main App Wrapper -->
    <div id="main-app-wrapper">
         
        <header class="header"><h1>‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h1></header>
        <nav class="main-nav">
            <div class="nav-tab active" onclick="showPage('inventory')">‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø</div>
            <div class="nav-tab" onclick="showPage('reports')">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</div>
        </nav>
    
        <!-- Inventory Page -->
        <div id="inventory-page" class="page active">
            <div class="container">
                <div class="action-bar">
                    <button class="add-item-btn" onclick="openItemAddModal()">‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® ‚ûï</button>
                    <button class="provide-item-btn" onclick="openProvideItemModal()">‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‚ûñ</button>
                </div>
                <div class="card">
                    <div class="form-group" style="margin-bottom: 0; box-shadow: none; padding: 5px;">
                        <input type="text" id="searchInput" autocomplete="off" onkeyup="renderInventoryPage()" placeholder="üîç ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡ßÅ‡¶®..." style="font-size: 14px;">
                    </div>
                </div>    
                <div id="inventoryContainer"></div>
            </div>
        </div>
    
        <!-- Reports & Settings Page -->
        <div id="reports-page" class="page">
            <div class="container">
        
                <!-- ‡ßß. ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶¨‡¶ø‡¶ß‡¶ø -->
                <div class="card">
                    <h2>‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶¨‡¶ø‡¶ß‡¶ø</h2>
                    <p>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶ú‡¶æ‡¶®‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                    <button class="action-btn" style="background-color: #17a2b8; width: 100%;" onclick="openManualModal()">
                        ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® üìñ
                    </button>
                </div>
        
                <!-- ‡ß®. ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° -->
                <div class="card">
                    <h2>‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</h2>
                    <p>‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶¨‡¶æ‡¶ú‡ßá‡¶ü, ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶§‡¶•‡ßç‡¶Ø ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                    <button class="action-btn" style="background-color: var(--success-color);" onclick="openDownloadModal()">
                        ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶® üì•
                    </button>
                </div>
        
                <!-- ‡ß©. ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠ -->
                <div class="card">
                    <h2>‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠</h2>
                    <p>‡¶¨‡¶ø‡¶ó‡¶§ ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡ßü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶ö‡¶æ‡¶π‡¶ø‡¶¶‡¶æ ‡¶è‡¶°‡¶ø‡¶ü ‡¶¨‡¶æ ‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡ßü ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§</p>
                    <div id="archived-reports-list"></div>
                </div>
        
                <!-- ‡ß™. ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶ï‡ßç‡¶∞‡¶Æ ‡¶∏‡¶æ‡¶ú‡¶æ‡¶® -->
                <div class="card">
                    <div class="card-header" onclick="toggleCardBody(this)" style="cursor: pointer;">
                        <h2>‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶ï‡ßç‡¶∞‡¶Æ ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®</h2>
                        <span class="toggle-icon collapsed">‚ñº</span>
                    </div>
                    <div class="card-body collapsible collapsed" style="padding-bottom: 15px;">
                        <p>‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡¶ü‡¶ø ‡¶°‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ó ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶õ‡¶®‡ßç‡¶¶ ‡¶Æ‡¶§‡ßã ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶ï‡ßç‡¶∞‡¶Æ ‡¶∏‡¶æ‡¶ú‡¶æ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶è‡¶á ‡¶ï‡ßç‡¶∞‡¶Æ ‡¶∏‡¶¨ ‡¶ú‡¶æ‡ßü‡¶ó‡¶æ‡ßü ‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶π‡¶¨‡ßá‡•§</p>
                        <ul id="sortable-sections" class="sortable-list">
                        </ul>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                            <button id="resetSectionOrderBtn" class="action-btn" style="background-color: #6c757d;">
                                ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü üîÑ
                            </button>
                            <button id="saveSectionOrderBtn" class="action-btn" style="background-color: #28a745;">
                                ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶® üíæ
                            </button>
                        </div>
                    </div>
                </div>
        
                <!-- ‡ß´. ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶ï‡ßç‡¶∞‡¶Æ ‡¶∏‡¶æ‡¶ú‡¶æ‡¶® -->
                <div class="card">
                    <div class="card-header" onclick="toggleCardBody(this)" style="cursor: pointer;">
                        <h2>‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶ï‡ßç‡¶∞‡¶Æ ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®</h2>
                        <span class="toggle-icon collapsed">‚ñº</span>
                    </div>
                    <div class="card-body collapsible collapsed" style="padding-bottom: 15px;">
                        <p>‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶¨‡¶æ‡¶õ‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ‡¶ü‡¶ø ‡¶°‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ó ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶ï‡ßç‡¶∞‡¶Æ ‡¶∏‡¶æ‡¶ú‡¶æ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                        <div class="form-group" style="padding: 0; box-shadow: none; margin-bottom: 15px;">
                            <select id="item-sort-section-select" onchange="initializeItemSortableList()"></select>
                        </div>
                        <ul id="sortable-items" class="sortable-list"></ul>
                        <div id="item-sort-buttons-container" style="display: none; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                            <button id="resetItemOrderBtn" class="action-btn" style="background-color: #6c757d;">‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü üîÑ</button>
                            <button id="saveItemOrderBtn" class="action-btn" style="background-color: #28a745;">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶® üíæ</button>
                        </div>
                    </div>
                </div>
        
                <!-- ‡ß¨. ‡¶∏‡ßç‡¶ü‡¶ï ‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ‡¶®‡¶ø‡ßü‡¶Æ -->
                <div class="card">
                    <div class="card-header" onclick="toggleCardBody(this)" style="cursor: pointer;">
                        <h2>‡¶∏‡ßç‡¶ü‡¶ï ‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ‡¶®‡¶ø‡ßü‡¶Æ</h2>
                        <span class="toggle-icon collapsed">‚ñº</span>
                    </div>
                    <div class="card-body collapsible collapsed" style="padding-bottom: 15px;">
                        <p>‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶∏‡ßç‡¶ü‡¶ï ‡¶≤‡ßá‡¶≠‡ßá‡¶≤‡ßá‡¶∞ ‡¶®‡¶ø‡ßü‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶è‡¶¨‡¶Ç ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶®‡¶ø‡ßü‡¶Æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§</p>
                        <button class="action-btn" style="background-color: #007bff; width: 100%;" onclick="openRuleManagementModal()">
                            ‡¶®‡¶ø‡ßü‡¶Æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶® ‚öôÔ∏è
                        </button>
                    </div>
                </div>
        
                <!-- ‡ß≠. ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü -->
                <div class="card">
                    <div class="card-header" onclick="toggleCardBody(this)" style="cursor: pointer;">
                        <h2>‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h2>
                        <span class="toggle-icon collapsed">‚ñº</span>
                    </div>
                    <div class="card-body collapsible collapsed">
                        <form id="add-user-form" onsubmit="addNewUser(event)">
                            <input type="text" id="new-user-name" autocomplete="off" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶®‡¶æ‡¶Æ" required>
                            <button type="submit" class="action-btn">‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                        </form>
                        <div id="user-list" style="margin-top: 15px;"></div>
                    </div>
                </div>
        
                <!-- ‡ßÆ. ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü -->
                <div class="card">
                    <h2>‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h2>
                    <p>‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶®‡¶ø‡¶®, ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                        <button class="action-btn" style="background-color: #17a2b8;" onclick="exportAllData()">
                            ‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™
                        </button>
                        <button class="action-btn" style="background-color: #6c757d;" onclick="importAllData()">
                            ‡¶°‡ßá‡¶ü‡¶æ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞
                        </button>
                    </div>
                    <button class="action-btn" style="background-color: var(--danger-color); width: 100%; margin-top: 10px;" onclick="openResetDialogs()">
                        ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                </div>
        
            </div>
        </div>

        <!-- New Modals for Reports -->
        <!-- Requisition Input Modal -->
        <div id="requisitionInputModal" class="modal-overlay">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 id="requisition-modal-title">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶ö‡¶æ‡¶π‡¶ø‡¶¶‡¶æ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                    <button class="close-btn" onclick="closeModal('requisitionInputModal')">&times;</button>
                </div>
                <div class="modal-body" id="requisition-items-container" style="padding: 0;">
                </div>
                <div class="modal-footer" style="display: block; text-align: center;">
                    <div style="margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <input type="checkbox" id="filter-by-quantity-toggle" style="width: auto; height: 16px; cursor: pointer;">
                        <label for="filter-by-quantity-toggle" style="font-weight: 600; font-size: 13px; cursor: pointer;">‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶ö‡¶æ‡¶π‡¶ø‡¶¶‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ö‡¶®‡ßç‡¶§‡¶∞‡ßç‡¶≠‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                    </div>
                
                    <div style="display: flex; justify-content: center; gap: 8px; width: 100%;">
                        <select id="final-report-format" style="padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); font-weight: 700; flex-basis: 25%;">
                            <option value="pdf">PDF</option>
                            <option value="excel">Excel</option>
                        </select>
                        <button onclick="clearRequisitionInputs()" style="background: var(--danger-color); color: white; flex-basis: 30%;">
                            ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞
                        </button>
                        <button style="background: var(--primary-gradient); color: white; flex-basis: 45%;" onclick="generateRequisitionReport()">
                            ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü
                        </button>
                    </div>
                </div>
            </div>
        </div>
    
        <div id="userReportModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="user-report-title"></h2>
                    <div>
                        <button id="clear-user-report-btn" class="delete-btn" style="font-size: 20px;">üóëÔ∏è</button>
                        <button class="close-btn" onclick="closeModal('userReportModal')">&times;</button>
                    </div>
                </div>
                <div class="modal-body" id="user-report-body">
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="itemAddModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header"><h2>‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</h2><button class="close-btn" onclick="closeModal('itemAddModal')">&times;</button></div>
                <div class="modal-body" id="multiItemFormsContainer"></div>
                <div class="modal-footer">
                    <button onclick="addFormRow()">‡¶Ü‡¶∞‡ßá‡¶ï‡¶ü‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‚ûï</button>
                    <button onclick="toggleNewSectionForm()">‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‚ûï</button>
                    <button id="save-all-items-btn" style="background: var(--primary-gradient); color: white; flex-grow: 1;" onclick="saveAllItems()">üíæ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    <div id="newSectionContainer" style="width: 100%;"><div id="newSectionForm"><input type="text" id="newSectionName" autocomplete="off" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ"><button onclick="addNewSection()">‡¶∏‡ßá‡¶≠</button></div></div>
                </div>
            </div>
        </div>

        <div id="itemDetailsModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="details-item-title">
                        <span id="details-item-name" onclick="editItemName()"></span>
                        <span>- ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</span>
                    </h2>
                    <!-- ‡¶®‡¶§‡ßÅ‡¶® div ‡¶ü‡¶ø ‡¶Ü‡¶á‡¶ï‡¶®‡¶ó‡ßÅ‡¶≤‡ßã‡¶ï‡ßá ‡¶™‡¶æ‡¶∂‡¶æ‡¶™‡¶æ‡¶∂‡¶ø ‡¶∞‡¶æ‡¶ñ‡¶¨‡ßá -->
                    <div class="modal-header-actions">
                        <button class="delete-btn" onclick="moveItem()" style="font-size: 16px; color: #0056b3;">‚úèÔ∏è</button>
                        <button class="delete-btn" onclick="deleteItem()">üóëÔ∏è</button>
                        <button class="close-btn" onclick="closeModal('itemDetailsModal')">&times;</button>
                    </div>
                </div>
                <!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã -->
                <div class="modal-tabs">
                    <button id="ledger-out-tab" class="ledger-tab active" onclick="showLedgerTab('out')">‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶â‡¶ü ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°</button>
                    <button id="ledger-in-tab" class="ledger-tab" onclick="showLedgerTab('in')">‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°</button>
                </div>
                <div class="modal-body">
                    <div id="ledger-container"></div>
                    <button id="load-more-ledger" class="action-btn load-more-btn">More</button>
                </div>
            </div>
        </div>
        <div id="provideItemModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header"><h2>‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h2><button class="close-btn" onclick="closeModal('provideItemModal')">&times;</button></div>
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;" id="user-requisition-group">
                        <div class="form-group" style="margin: 0; padding: 0; box-shadow: none;">
                            <select id="pi-user-main"></select>
                        </div>
                        <div class="form-group" id="requisition-id-group" style="margin: 0; padding: 0; box-shadow: none;">
                            <input type="text" id="pi-requisition-id" autocomplete="off" placeholder="‡¶∞‡¶ø‡¶ï‡ßÅ‡¶á‡¶ú‡¶ø‡¶∂‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞">
                        </div>
                    </div>
                
                    <div id="provide-items-container">
                        <!-- ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶´‡¶∞‡ßç‡¶Æ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡¶¨‡ßá -->
                    </div>
        
                    <div style="display: flex; margin-top: 15px;">
                        <div class="form-group" style="background: var(--level-low-bg); display: flex; flex-direction: row; align-items: center; gap: 10px; padding: 10px; margin-bottom: 0; width: 100%;">
                            <input type="checkbox" id="pi-is-urgent-main" style="width: auto;" onchange="toggleRequisitionIdField(this.checked)">
                            <label for="pi-is-urgent-main" style="margin: 0;">‡¶∞‡¶ø‡¶ï‡ßÅ‡¶á‡¶ú‡¶ø‡¶∂‡¶® ‡¶õ‡¶æ‡ßú‡¶æ (‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ)</label>
                        </div>
                    </div>

                </div>
                <div class="modal-footer" style="justify-content: space-between;">
                    <button onclick="addProvideItemForm()">‡¶Ü‡¶∞‡ßá‡¶ï‡¶ü‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‚ûï</button>
                    <button id="execute-provide-all-btn" style="background: var(--warning-color); color: var(--dark-text); flex-grow: 1;" onclick="executeProvideAllItems()">‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </div>
        </div>

        <div id="notification-container"></div>
        <div class="sliding-notification-bar" id="slidingNotificationBar"><div class="sliding-text" id="slidingText"></div></div>
        </div>
    <div id="import-option-dialog" class="modal-overlay">
        <div class="modal-content" style="max-width: 380px;">
            <div class="modal-header">
                <h2>‡¶á‡¶Æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®</h2>
                <button class="close-btn" onclick="closeImportDialog()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="text-align: center; margin-bottom: 20px;">‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶∏‡¶¨ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®, ‡¶®‡¶æ‡¶ï‡¶ø ‡¶¶‡ßÅ‡¶ü‡¶ø‡¶ï‡ßá ‡¶è‡¶ï‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?</p>
                <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
                    <button id="merge-btn" class="action-btn" style="background-color: var(--success-color);">
                        ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶)
                    </button>
                    <button id="replace-btn" class="action-btn" style="background-color: var(--warning-color); color: var(--dark-text);">
                        ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡ßá‡¶∏ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá)
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="reset-confirm-dialog-1" class="modal-overlay">
        <div class="modal-content" style="max-width: 380px;">
            <div class="modal-header">
                <h2 style="color: var(--danger-color);">‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ!</h2>
            </div>
            <div class="modal-body">
                <p style="text-align: center;">‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶á ‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶´‡ßá‡¶∞‡¶æ‡¶®‡ßã ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶®‡ßü‡•§</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                    <button class="action-btn" style="background-color: #6c757d;" onclick="closeResetDialogs()">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                    <button id="confirm-reset-1" class="action-btn" style="background-color: var(--danger-color);">‡¶π‡ßç‡¶Ø‡¶æ‡¶Å, ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="reset-confirm-dialog-2" class="modal-overlay">
        <div class="modal-content" style="max-width: 380px;">
            <div class="modal-header">
                <h2 style="color: var(--danger-color);">‡¶ö‡ßÇ‡ßú‡¶æ‡¶®‡ßç‡¶§ ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ!</h2>
            </div>
            <div class="modal-body">
                <p style="text-align: center;">‡¶è‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∂‡ßá‡¶∑ ‡¶∏‡ßÅ‡¶Ø‡ßã‡¶ó‡•§ "‡¶∞‡¶ø‡¶∏‡ßá‡¶ü" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® (‡¶Ø‡¶¶‡¶ø ‡¶≤‡¶ó‡¶á‡¶® ‡¶•‡¶æ‡¶ï‡ßá‡¶®) ‡¶∏‡¶ï‡¶≤ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                    <button class="action-btn" style="background-color: #6c757d;" onclick="closeResetDialogs()">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                    <button id="confirm-reset-2" class="action-btn" style="background-color: var(--danger-color);">‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </div>
        </div>
    </div>
    <div id="pin-prompt-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 320px;">
            <div class="modal-header">
                <h2 id="pin-modal-title">‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶™‡¶ø‡¶® ‡¶¶‡¶ø‡¶®</h2>
                <button id="pin-close-btn" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="box-shadow: none; padding: 0;">
                    <input type="password" id="pin-input" autocomplete="one-time-code" inputmode="numeric" pattern="[0-9]*" maxlength="4" style="text-align: center; font-size: 24px; letter-spacing: 10px;" placeholder="----">
                    <p id="pin-error-msg" style="color: var(--danger-color); text-align: center; height: 15px; margin-top: 5px; font-weight: 500;"></p>
                </div>
            </div>
        </div>
    </div>
    <div id="move-item-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="move-item-modal-title">‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
            </div>
            <div class="modal-body">
                <p id="move-item-prompt-text" style="margin-bottom: 15px;"></p>
                <div class="form-group" style="box-shadow: none; padding: 0;">
                    <label for="section-select-dropdown" style="font-weight: 600;">‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®</label>
                    <select id="section-select-dropdown" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color);"></select>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: space-between;">
                <button id="move-item-cancel-btn" style="background-color: #6c757d;">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                <button id="move-item-confirm-btn" style="background: var(--success-color); color: white; flex-grow: 1;">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>
    </div>    
    <button id="back-to-top-btn" title="‡¶â‡¶™‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="18 15 12 9 6 15"></polyline>
        </svg>
    </button>
    <button id="scroll-to-bottom-btn" title="‡¶®‡¶ø‡¶ö‡ßá ‡¶Ø‡¶æ‡¶®">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
    </button>
    
    <div id="customConfirmModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 360px; text-align: center;">
            <div class="modal-header" style="padding: 10px 15px;">
                <h2 id="custom-confirm-title" style="font-size: 1.1rem; margin: 0;"></h2>
                <button class="close-btn" onclick="closeModal('customConfirmModal')" style="font-size: 1.5rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 15px 20px 20px;">
                <p id="custom-confirm-message" style="margin-bottom: 20px; font-size: 0.95rem; line-height: 1.4;"></p>
                <div style="display: flex; justify-content: space-around; gap: 10px;">
                    <button id="confirm-option-1" class="action-btn" style="background-color: #c82333; color: white; width: 48%; margin: 0; padding: 8px 10px; font-size: 0.85rem; border-radius: 5px;">‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡¶∏‡¶π ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
                    <button id="confirm-option-2" class="action-btn" style="background-color: #e0a800; color: #212529; width: 48%; margin: 0; padding: 8px 10px; font-size: 0.85rem; border-radius: 5px;">‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü</button>
                </div>
            </div>
        </div>
    </div>
    <div id="custom-prompt-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 380px;">
            <div class="modal-header">
                <h2 id="custom-prompt-title"></h2>
            </div>
            <div class="modal-body">
                <p id="custom-prompt-message" style="margin-bottom: 15px;"></p>
                <div class="form-group" style="box-shadow: none; padding: 0;">
                    <input type="number" id="custom-prompt-input" step="any" style="width: 100%; padding: 10px; font-size: 16px; border-radius: 6px; border: 1px solid var(--border-color);">
                </div>
            </div>
            <div class="modal-footer" style="justify-content: flex-end;">
                <button id="custom-prompt-cancel" style="background-color: #6c757d;">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
                <button id="custom-prompt-ok" style="background: var(--success-color); color: white;">‡¶ì‡¶ï‡ßá</button>
            </div>
        </div>
    </div>
    <!-- User Manual Modal -->
    <div id="manualModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü - ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤</h2>
                <button class="close-btn" onclick="closeModal('manualModal')">&times;</button>
            </div>
            <div class="modal-body">
                <h3>‡ßß. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø</h3>
                <p>‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø‡¶∞ ‡¶™‡ßç‡¶∞‡¶ß‡¶æ‡¶® ‡¶â‡¶¶‡ßç‡¶¶‡ßá‡¶∂‡ßç‡¶Ø ‡¶π‡¶≤‡ßã ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶®‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶¨‡¶æ ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶∞‡¶ø‡¶ö‡¶æ‡¶≤‡¶®‡¶æ ‡¶ï‡¶∞‡¶æ, ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡¶æ‡¶ï‡ßá ‡¶∏‡¶π‡¶ú ‡¶ì ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶ï‡¶∞‡¶æ‡•§</p>
    
                <h3>‡ß®. ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶ì ‡¶™‡¶ø‡¶® ‡¶™‡ßç‡¶∞‡ßã‡¶ü‡ßá‡¶ï‡¶∂‡¶® (‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£)</h3>
                <p>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ‡¶∞ ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶æ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶æ‡ßü ‡¶∏‡¶ï‡¶≤ ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶è‡¶¨‡¶Ç ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶ï‡¶æ‡¶ú <strong>‡ß™-‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶™‡¶ø‡¶®</strong> ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§‡•§ ‡¶≠‡ßÅ‡¶≤‡¶¨‡¶∂‡¶§ ‡¶¨‡¶æ ‡¶Ö‡¶®‡¶®‡ßÅ‡¶Æ‡ßã‡¶¶‡¶ø‡¶§ ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶∞‡ßã‡¶ß ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶á ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§</p>
                <h4>‡¶Ø‡ßá‡¶∏‡¶¨ ‡¶ï‡¶æ‡¶ú‡ßá ‡¶™‡¶ø‡¶® ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶® ‡¶π‡¶¨‡ßá:</h4>
                <ul>
                    <li>‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ, ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶¨‡¶æ ‡¶á‡¶â‡¶®‡¶ø‡¶ü ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ‡•§</li>
                    <li>‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶¨‡¶æ ‡¶è‡¶∞ ‡¶≤‡ßá‡¶ú‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡•§</li>
                    <li>‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶¨‡¶æ ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡•§</li>
                    <li>‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ‡•§</li>
                    <li>‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶¨‡¶æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡•§</li>
                </ul>
    
                <h3>‡ß©. ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶¨‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶≤‡¶ó‡¶á‡¶®</h3>
                <p>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‚Äî‡¶â‡¶≠‡ßü ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶§‡ßá‡¶á ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§ ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶´‡¶ø‡¶∞‡ßá ‡¶è‡¶≤‡ßá ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶ï‡¶∞‡¶æ ‡¶ï‡¶æ‡¶ú‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡ßç‡¶¨‡ßü‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶°‡ßá ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡ßü‡•§ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶¨‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ‡¶§‡ßá ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶ì ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡ßü‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶°‡ßá‡¶ü‡¶æ ‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶° ‡¶•‡ßá‡¶ï‡ßá ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá‡•§</p>
    
                <h3>‡ß™. ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶™‡ßá‡¶ú (‡¶Æ‡ßÇ‡¶≤ ‡¶™‡¶æ‡¶§‡¶æ)</h3>
                <ul>
                    <li><strong>‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶ï‡¶∞‡¶æ:</strong> ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶¨‡¶ï‡ßç‡¶∏‡ßá ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶∏‡¶π‡¶ú‡ßá‡¶á ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡•§</li>
                    <li><strong>‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ:</strong> "‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® ‚ûï" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï ‡¶¨‡¶æ ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡•§ ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶∞‡ßç‡¶Æ ‡¶ñ‡ßÅ‡¶≤‡¶≤‡ßá ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡¶ü‡¶ø ‡¶∏‡ßç‡¶¨‡ßü‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡ßü‡ßá ‡¶•‡¶æ‡¶ï‡ßá‡•§</li>
                    <li><strong>‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ:</strong> "‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‚ûñ" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶∏‡ßç‡¶ü‡¶ï ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶®‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶®‡¶•‡¶ø‡¶≠‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡•§</li>
                </ul>
    
                <h3>‡ß´. ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü (‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§)</h3>
                <ul>
                    <li><strong>‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ:</strong> ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ <strong>‡¶∏‡ßç‡¶ü‡¶ï‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</strong> (‡¶Ø‡ßá‡¶Æ‡¶®: "‡ßß‡ß¶ ‡¶™‡¶ø‡¶∏") ‡¶è‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶™‡¶™-‡¶Ü‡¶™‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶™‡¶ø‡¶® ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá)‡•§</li>
                    <li><strong>‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡¶æ (‡¶≤‡ßá‡¶ú‡¶æ‡¶∞):</strong> ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã <strong>‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞</strong> ‡¶â‡¶™‡¶∞ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ (‡¶≤‡ßá‡¶ú‡¶æ‡¶∞) ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§</li>
                    <li><strong>‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ:</strong> ‡¶≤‡ßá‡¶ú‡¶æ‡¶∞ ‡¶Æ‡¶°‡¶æ‡¶≤‡ßá‡¶∞ ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶°‡¶æ‡¶®‡¶¶‡¶ø‡¶ï‡ßá ‡¶•‡¶æ‡¶ï‡¶æ <strong>‡¶°‡¶æ‡¶∏‡ßç‡¶ü‡¶¨‡¶ø‡¶® (üóëÔ∏è)</strong> ‡¶Ü‡¶á‡¶ï‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶™‡¶ø‡¶® ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá)‡•§</li>
                </ul>
    
                <h3>‡ß¨. ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü (‡¶™‡¶ø‡¶® ‡¶™‡ßç‡¶∞‡ßã‡¶ü‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°)</h3>
                <ul>
                    <li><strong>‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®:</strong> ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ <strong>‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ‡ßá‡¶∞</strong> ‡¶â‡¶™‡¶∞ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶™‡¶ø‡¶® ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá)‡•§</li>
                    <li><strong>‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ:</strong> ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶°‡¶æ‡¶® ‡¶™‡¶æ‡¶∂‡ßá ‡¶•‡¶æ‡¶ï‡¶æ <strong>‡¶°‡¶æ‡¶∏‡ßç‡¶ü‡¶¨‡¶ø‡¶® (üóëÔ∏è)</strong> ‡¶Ü‡¶á‡¶ï‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶™‡¶ø‡¶® ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá)‡•§</li>
                </ul>
    
                <h3>‡ß≠. ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶™‡ßá‡¶ú</h3>
                <ul>
                    <li><strong>‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü:</strong> ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶¨‡¶æ ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡ßü‡•§</li>
                    <li><strong>‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°:</strong> ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶ö‡¶æ‡¶π‡¶ø‡¶¶‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü, ‡¶Ø‡¶æ ‡¶∏‡ßç‡¶¨‡ßü‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡ßü‡•§</li>
                    <li><strong>‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠:</strong> ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡¶ø‡¶ó‡¶§ ‡¶Æ‡¶æ‡¶∏‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡ßá‡•§ <strong>‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá</strong> ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶ö‡¶æ‡¶π‡¶ø‡¶¶‡¶æ ‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡ßü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü‡•§</li>
                    <li><strong>‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü:</strong> ‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™, ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶¨‡¶æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶™‡¶∂‡¶® (‡¶™‡¶ø‡¶® ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá)‡•§</li>
                </ul>
    
                <h3>‡ßÆ. ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞: ‡¶≤‡¶Ç-‡¶™‡ßç‡¶∞‡ßá‡¶∏ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®</h3>
                <p>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶ï‡¶æ‡¶ú‡¶ï‡ßá ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶ø‡¶õ‡ßÅ "‡¶ö‡ßá‡¶™‡ßá ‡¶ß‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ" ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶∞‡ßü‡ßá‡¶õ‡ßá:</p>
                <ul>
                    <li><strong>‡¶á‡¶â‡¶®‡¶ø‡¶ü ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®:</strong> ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶ï‡ßá‡¶∞ ‡¶â‡¶™‡¶∞ <code>‡ß© ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°</code> ‡¶ö‡ßá‡¶™‡ßá ‡¶ß‡¶∞‡ßÅ‡¶® (‡¶™‡¶ø‡¶® ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá)‡•§</li>
                    <li><strong>‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü:</strong> ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶ú‡¶æ‡¶∞ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶∞ ‡¶â‡¶™‡¶∞ <code>‡ßß ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°</code> ‡¶ö‡ßá‡¶™‡ßá ‡¶ß‡¶∞‡ßÅ‡¶® (‡¶™‡¶ø‡¶® ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá)‡•§</li>
                </ul>
            </div>
        </div>
    </div>
    <!-- Stock Level Rule Management Modal -->
    <div id="ruleManagementModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>‡¶∏‡ßç‡¶ü‡¶ï ‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ‡¶®‡¶ø‡ßü‡¶Æ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                <button class="close-btn" onclick="closeModal('ruleManagementModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Rules List -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header" style="padding: 10px 15px;">
                        <h3 style="margin:0; font-size: 15px;">‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶®‡¶ø‡ßü‡¶Æ‡¶æ‡¶¨‡¶≤‡ßÄ</h3>
                    </div>
                    <div id="existing-rules-container" style="padding: 15px; max-height: 250px; overflow-y: auto;">
                        <!-- Rules will be dynamically loaded here -->
                    </div>
                    <div style="padding: 0 15px 15px 15px; border-top: 1px solid #e9ecef;">
                        <button onclick="resetDefaultRules()" class="action-btn" style="background-color: var(--warning-color); color: var(--dark-text); width: 100%; margin-top: 10px;">
                            üîÑ ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü
                        </button>
                    </div>
                    
                </div>
    
                <!-- New Custom Rule Form -->
                <div class="card">
                     <div class="card-header" style="padding: 10px 15px;">
                        <h3 style="margin:0; font-size: 15px;">‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶®‡¶ø‡ßü‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)</h3>
                    </div>
                    <form id="new-rule-form" onsubmit="addNewStockRule(event)" style="padding: 15px;">
                        <div class="form-group">
                            <label>‡¶∂‡¶∞‡ßç‡¶§: ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßá ‡¶è‡¶á ‡¶∂‡¶¨‡ßç‡¶¶‡¶ü‡¶ø ‡¶•‡¶æ‡¶ï‡ßá</label>
                            <input type="text" id="rule-keyword" autocomplete="off" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: belt fusing, ampere tube" required>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div class="form-group" style="padding:0; box-shadow:none;">
                                <label>Low Level</label>
                                <input type="number" id="rule-low" autocomplete="off" step="any" required>
                            </div>
                            <div class="form-group" style="padding:0; box-shadow:none;">
                                <label>Very Low Level</label>
                                <input type="number" id="rule-very-low" autocomplete="off" step="any" required>
                            </div>
                            <div class="form-group" style="padding:0; box-shadow:none;">
                                <label>Critical Level</label>
                                <input type="number" id="rule-critical" autocomplete="off" step="any" required>
                            </div>
                        </div>
                        <button type="submit" class="action-btn" style="background: var(--success-color); width: 100%; margin-top: 10px;">üíæ ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶®‡¶ø‡ßü‡¶Æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Force Update Modal -->
    <div id="forceUpdateModal" class="modal-overlay" style="display: none; z-index: 9999; background-color: rgba(0, 0, 0, 0.85);">
        <div class="modal-content" style="max-width: 400px; text-align: center; padding: 20px;">
            <div class="modal-header" style="border-bottom: none; padding-bottom: 0;">
                <h2 style="width: 100%; text-align: center; color: var(--warning-color);">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®</h2>
            </div>
            <div class="modal-body">
                <p style="font-size: 15px; line-height: 1.6; margin-bottom: 25px;">
                    ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶∏‡¶Ç‡¶∏‡ßç‡¶ï‡¶∞‡¶£ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶ó‡ßá‡¶õ‡ßá‡•§ ‡¶∏‡ßá‡¶∞‡¶æ ‡¶Ö‡¶≠‡¶ø‡¶ú‡ßç‡¶û‡¶§‡¶æ ‡¶™‡ßá‡¶§‡ßá, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
                </p>
                <button id="update-now-btn" class="action-btn" style="background: var(--success-color); width: 100%; font-size: 16px;">
                    ‡¶è‡¶ñ‡¶® ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® üöÄ
                </button>
            </div>
        </div>
    </div>
     
    <script>
        // --- Global State & Constants ---
        const firebaseConfig = {
            apiKey: "AIzaSyDxYIqWdbNlB2mKjKiXmbWdZzWXcZLY_50",
            authDomain: "grgl-store-inventory.firebaseapp.com",
            projectId: "grgl-store-inventory",
            storageBucket: "grgl-store-inventory.firebasestorage.app",
            messagingSenderId: "1062844257534",
            appId: "1:1062844257534:web:d5c585957d67c901a201af"
        };
    
        firebase.initializeApp(firebaseConfig);
        firebase.firestore().enablePersistence()
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                } else if (err.code == 'unimplemented') {
                }
            });        
        const auth = firebase.auth();
        const db = firebase.firestore();
    
        let allItems = [], sections = [], users = [], ledger = [], archivedReports = [];
        let tempRequisitionData = {};
        let debounceTimer;
        let unsubscribeListeners = [];
        let sectionOrder = []; 
        let sortableInstance = null;
        let itemOrders = {};
        const ADMIN_UIDS = [
            "MnhpRrkD24WNCXQOF0EVWtyqEac2",
            "X85JKidshVWCJaNO1HVcXknpfbp2",
            "5xjowSXQKaPDWotozJlRLn6M7lw1"
        ];
        const CENTRAL_DB_ID = "grgl_central_store";
        const SECURITY_PIN = "0000";
        let resolvePinPromise = null;   
        const CURRENT_APP_VERSION = "2.1.1";
        let onlineAppVersion = null;
        
        const LEVEL_LOW = 5;
        const LEVEL_CRITICAL = 2;

        const stockLevels = {
            "‡¶™‡¶ø‡¶∏": { low: 8, veryLow: 5, critical: 2 },
            "‡¶ü‡¶ø": { low: 8, veryLow: 5, critical: 2 },
            "‡¶ú‡ßã‡ßú‡¶æ": { low: 4, veryLow: 2, critical: 1 },
            "‡¶∏‡ßá‡¶ü": { low: 5, veryLow: 3, critical: 1 },
            "‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ü": { low: 5, veryLow: 3, critical: 1 },
            "‡¶¨‡¶ï‡ßç‡¶∏": { low: 1, veryLow: 0.5, critical: 0 },
            "‡¶≤‡¶ø‡¶ü‡¶æ‡¶∞": { low: 2, veryLow: 1, critical: 0.5 },
            "‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ": { low: 200, veryLow: 100, critical: 50 },
            "‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞": { low: 8, veryLow: 5, critical: 2 },
            "‡¶´‡¶ø‡¶ü": { low: 7, veryLow: 5, critical: 2 },
            "‡¶ï‡¶Ø‡¶º‡ßá‡¶≤": { low: 2, veryLow: 1, critical: 0.5 },
            "‡¶∞‡ßã‡¶≤": { low: 2, veryLow: 1, critical: 0 },
            "‡¶°‡¶ú‡¶®": { low: 2, veryLow: 1, critical: 0.5 },
            "default": { low: 7, veryLow: 5, critical: 3 }
        };        
        const originalStockLevels = JSON.parse(JSON.stringify(stockLevels));
        let stockLevelRules = []; 
        function getDbPath() {
            const user = auth.currentUser;
            if (!user) return null;
        
            const dbId = ADMIN_UIDS.includes(user.uid) ? CENTRAL_DB_ID : user.uid;
            
            return db.collection('inventories').doc(dbId);
        }
        
        let currentUser = null;
        const ITEMS_PER_PAGE = 5;
        let activeItemId = null;
        let ledgerDisplayCount = 5;
        let expandedSections = {};
        let scrollPosition = 0;
        let itemToHighlight = null;
        let slowScrollAnimationId = null;
        // --- Helper Functions ---
        const toBengaliNumber = (enStr) => {
            if (typeof enStr !== 'string' && typeof enStr !== 'number') return enStr;
            const str = String(enStr);
            const bnNumbers = ['‡ß¶', '‡ßß', '‡ß®', '‡ß©', '‡ß™', '‡ß´', '‡ß¨', '‡ß≠', '‡ßÆ', '‡ßØ'];
            return str.replace(/[0-9]/g, (w) => bnNumbers[+w]);
        };
        function toggleRequisitionIdField(isUrgent) {
            const requisitionGroup = document.getElementById('requisition-id-group');
            const userRequisitionGroup = document.getElementById('user-requisition-group');
        
            if (isUrgent) {
                requisitionGroup.style.display = 'none';
                userRequisitionGroup.style.gridTemplateColumns = '1fr';
            } else {
                requisitionGroup.style.display = 'grid';
                userRequisitionGroup.style.gridTemplateColumns = '1fr 1fr';
            }
        }   
        const naturalSort = (a, b) => {
            const categoryWeights = {
                'nipple': 1, 'socket': 2, 'regulator': 3, 'pipe': 4, 'clamp': 5, 
                'gasket': 6, 'valve': 7, 'tape': 8, 'meter': 9,
                'breaker': 10, 'fuse': 11, 'contact': 12, 'relay': 13, 'timer': 14,
                'controller': 15, 'indicator': 16, 'switch': 17, 'plug': 18,
                'light': 20, 'led': 21, 'bulb': 22,
                'battery': 30, 'capacitor': 31, 'resistor': 32, 'diode': 33, 'transistor': 34,
                'mosfet': 35, 'rectifier': 36, 'optocoupler': 37, 'transformer': 38,
                'power supply': 39,
                'wire': 40, 'cable': 41, 'busbar': 42, 'lugs': 43, 'tie': 44, 'saddle': 45,
                'insulator': 46, 'insulation': 47, 'tube': 48,
                'motor': 50, 'coil': 51, 'bearing': 52, 'belt': 53, 'brush': 54, 'spring': 55,
                'pulley': 56, 'sheet': 57, 'key': 58,
                'cutter': 60, 'knife': 61, 'blade': 62, 'bit': 63, 'pliers': 64, 'hammer': 65,
                'tester': 66, 'stone': 67, 'screw': 68, 'bolt': 69,
                'paste': 80, 'gum': 81, 'varnish': 82, 'silicone': 83,
                'others': 999
            };
        
            const customWeights = {
                'single': 1, 'sp': 1, 'one': 1, 'mono': 1,
                'double': 2, 'dp': 2, 'two': 2, 'di': 2,
                'triple': 3, 'tp': 3, 'three': 3, 'tri': 3,
                'four': 4,
                'half': 0.5, 'quarter': 0.25,
                'no': 1, 'nc': 2
            };
        
            const getCategoryAndParts = (name) => {
                const lowerName = name.toLowerCase();
                let categoryRank = categoryWeights['others'];
                let bestMatchKeyword = '';
        
                for (const keyword in categoryWeights) {
                    if (lowerName.includes(keyword)) {
                        if (bestMatchKeyword.length < keyword.length) {
                            bestMatchKeyword = keyword;
                            categoryRank = categoryWeights[keyword];
                        }
                    }
                }
        
                const regex = /(\d+(\.\d+)?)|([a-zA-Z]+)/g;
                const parts = name.match(regex) || [];
                
                const processedParts = parts.map(part => {
                    const lowerPart = part.toLowerCase();
                    if (customWeights[lowerPart] !== undefined) {
                        return customWeights[lowerPart];
                    }
                    const num = parseFloat(part);
                    return isNaN(num) ? part : num;
                });
        
                return { rank: categoryRank, parts: processedParts };
            };
        
            const aData = getCategoryAndParts(a.name);
            const bData = getCategoryAndParts(b.name);
        
            if (aData.rank !== bData.rank) {
                return aData.rank - bData.rank;
            }
        
            const len = Math.min(aData.parts.length, bData.parts.length);
            for (let i = 0; i < len; i++) {
                const aPart = aData.parts[i];
                const bPart = bData.parts[i];
        
                const aIsNumber = typeof aPart === 'number';
                const bIsNumber = typeof bPart === 'number';
        
                if (aIsNumber && bIsNumber) {
                    if (aPart < bPart) return -1;
                    if (aPart > bPart) return 1;
                } else if (aIsNumber && !bIsNumber) {
                    return -1;
                } else if (!aIsNumber && bIsNumber) {
                    return 1;
                } else {
                    const comparison = String(aPart).localeCompare(String(bPart));
                    if (comparison !== 0) return comparison;
                }
            }
        
            return aData.parts.length - bData.parts.length;
        };
        const checkOnlineStatus = async () => {
            try {
                const response = await fetch('https://www.google.com/images/branding/googlelogo/1x/googlelogo_color_272x92dp.png', {
                    method: 'HEAD',
                    cache: 'no-cache',
                    mode: 'no-cors'
                });
                return true;
            } catch (error) {
                return false;
            }
        };
        const createLedgerDescription = (entry) => {
            const date = new Date(entry.date);
            const now = new Date();
            const months = ["‡¶ú‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶∞‡¶ø", "‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡ßü‡¶æ‡¶∞‡¶ø", "‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", "‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤", "‡¶Æ‡ßá", "‡¶ú‡ßÅ‡¶®", "‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á", "‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü", "‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞", "‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞", "‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞", "‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞"];
            
            let datePart = '';
            if (date.getFullYear() !== now.getFullYear()) {
                datePart = `${toBengaliNumber(date.getFullYear())} ‡¶∏‡¶æ‡¶≤‡ßá‡¶∞, ${months[date.getMonth()]} ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ${toBengaliNumber(date.getDate())} ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá,`;
            } else if (date.getMonth() !== now.getMonth()) {
                datePart = `${months[date.getMonth()]} ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ${toBengaliNumber(date.getDate())} ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá,`;
            } else {
                datePart = `${toBengaliNumber(date.getDate())} ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ‡ßá,`;
            }
        
            const time = date.toLocaleTimeString('bn-BD', { hour: 'numeric', minute: '2-digit', hour12: true });
            const quantity = toBengaliNumber(Math.abs(entry.change));
            const item = allItems.find(i => i.id === entry.itemId);
            const unit = item ? (item.unit || '‡¶™‡¶ø‡¶∏') : '‡¶™‡¶ø‡¶∏';
            const itemName = entry.itemName;
        
            if (entry.change > 0) {
                return `${datePart} ${time}, ${quantity} ${unit} ${itemName} ‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`;
            } else {
                return `${datePart} ${time}, ${quantity} ${unit} ${itemName} ‡¶®‡¶ø‡ßü‡ßá‡¶õ‡ßá ${entry.person}‡•§`;
            }
        };
        function showCustomPrompt({ title, message, defaultValue, step = 'any' }) {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-prompt-modal');
                const titleEl = document.getElementById('custom-prompt-title');
                const messageEl = document.getElementById('custom-prompt-message');
                const inputEl = document.getElementById('custom-prompt-input');
                inputEl.setAttribute('autocomplete', 'off');
                const okBtn = document.getElementById('custom-prompt-ok');
                const cancelBtn = document.getElementById('custom-prompt-cancel');
        
                titleEl.textContent = title;
                messageEl.textContent = message;
                inputEl.value = defaultValue;
                inputEl.step = step; // ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶≤‡¶æ‡¶á‡¶®
        
                openModal('custom-prompt-modal');
                
                setTimeout(() => {
                    inputEl.focus();
                    inputEl.select();
                }, 100);
        
                const handleOk = () => {
                    cleanup();
                    resolve(inputEl.value);
                };
        
                const handleCancel = () => {
                    cleanup();
                    resolve(null);
                };
        
                const handleEnter = (event) => {
                    if (event.key === 'Enter') {
                        handleOk();
                    }
                };
        
                const cleanup = () => {
                    closeModal('custom-prompt-modal');
                    okBtn.removeEventListener('click', handleOk);
                    cancelBtn.removeEventListener('click', handleCancel);
                    inputEl.removeEventListener('keydown', handleEnter);
                };
        
                okBtn.addEventListener('click', handleOk);
                cancelBtn.addEventListener('click', handleCancel);
                inputEl.addEventListener('keydown', handleEnter);
            });
        }

        function updateQuantityStep(unitInput) {
            const quantityInput = unitInput.closest('.item-form-card').querySelector('.item-quantity');
            const unitValue = unitInput.value.toLowerCase().trim();
            
            const integerUnits = [
                'pcs', 'pc', 'pice', 'pce', '‡¶™‡¶ø‡¶∏', '‡¶ü‡¶ø', 
                'set', '‡¶∏‡ßá‡¶ü', 
                'box', '‡¶¨‡¶ï‡ßç‡¶∏', 
                'packet', '‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ü', 
                'dozen', 'dzn', '‡¶°‡¶ú‡¶®', 
                'pair', '‡¶ú‡ßã‡ßú‡¶æ',
                'roll', '‡¶∞‡ßã‡¶≤',
                'ÿπÿØÿØ'
            ];
        
            if (integerUnits.includes(unitValue)) {
                quantityInput.step = "1";
                if (quantityInput.value) {
                    quantityInput.value = Math.round(parseFloat(quantityInput.value));
                }
            } else {
                quantityInput.step = "any";
            }
        }
        
        function updateProvideQuantityStep(itemSelect) {
            const quantityInput = itemSelect.closest('.item-form-card').querySelector('.pi-quantity-dynamic');
            const selectedItemId = itemSelect.value;
            const item = allItems.find(i => i.id === selectedItemId);
            
            if (item) {
                const unitValue = item.unit.toLowerCase().trim();
                
                const integerUnits = [
                    'pcs', 'pc', 'pice', 'pce', '‡¶™‡¶ø‡¶∏', '‡¶ü‡¶ø', 
                    'set', '‡¶∏‡ßá‡¶ü', 
                    'box', '‡¶¨‡¶ï‡ßç‡¶∏', 
                    'packet', '‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ü', 
                    'dozen', 'dzn', '‡¶°‡¶ú‡¶®', 
                    'pair', '‡¶ú‡ßã‡ßú‡¶æ',
                    'roll', '‡¶∞‡ßã‡¶≤'
                ];
        
                if (integerUnits.includes(unitValue)) {
                    quantityInput.step = "1";
                    if (quantityInput.value) {
                        quantityInput.value = Math.round(parseFloat(quantityInput.value));
                    }
                } else {
                    quantityInput.step = "any";
                }
            } else {
                quantityInput.step = "any";
            }
        }

        function listenForLiveUpdates() {
            const dbPath = getDbPath();
            if (!dbPath) return;
        
            unsubscribeListeners.forEach(unsubscribe => unsubscribe());
            unsubscribeListeners = [];
        
            const collections = ['sections', 'items', 'app_users', 'ledger', 'archivedReports'];
            const stateArrays = {
                sections: (data) => {
                    sections = data;
                    initializeSortableList();
                    populateItemSortSectionDropdown();
                    renderInventoryPage();
                    localStorage.setItem('sections', JSON.stringify(data));
                },
                items: (data) => {
                    allItems = data;
                    renderInventoryPage();
                    updateSlidingNotifications();
                    localStorage.setItem('items', JSON.stringify(data));
                },
                app_users: (data) => {
                    users = data;
                    renderUsersPage();
                    localStorage.setItem('app_users', JSON.stringify(data));
                },
                ledger: (data) => {
                    ledger = data;
                    localStorage.setItem('ledger', JSON.stringify(data));
                },
                archivedReports: (data) => {
                    archivedReports = data;
                    renderArchivedReports();
                    localStorage.setItem('archivedReports', JSON.stringify(data));
                }
            };
        
            const setupListeners = () => {
                collections.forEach(col => {
                    const unsubscribe = dbPath.collection(col).onSnapshot((snapshot) => {
                        const dataArray = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        stateArrays[col](dataArray);
                    });
                    unsubscribeListeners.push(unsubscribe);
                });
        
                const tempReqUnsubscribe = dbPath.collection('app_state').doc('temp_requisition').onSnapshot((doc) => {
                    const data = doc.data() || {};
                    localStorage.setItem('tempRequisition', JSON.stringify(data));
                    const reqModal = document.getElementById('requisitionInputModal');
                    if (reqModal && reqModal.classList.contains('show')) {
                        const inputs = reqModal.querySelectorAll('.req-quantity-input');
                        inputs.forEach(input => {
                            const row = input.closest('tr');
                            if (row) {
                                const itemId = row.dataset.itemId;
                                input.value = data[itemId] || '';
                            }
                        });
                    }
                });
                unsubscribeListeners.push(tempReqUnsubscribe);
        
                const settingsUnsubscribe = dbPath.collection('app_state').doc('settings').onSnapshot((doc) => {
                    if (doc.exists) {
                        const settingsData = doc.data();
                        if (settingsData.sectionOrder) {
                            sectionOrder = settingsData.sectionOrder;
                            localStorage.setItem('sectionOrder', JSON.stringify(sectionOrder));
                        }
                        if (settingsData.itemOrders) {
                            itemOrders = settingsData.itemOrders;
                            localStorage.setItem('itemOrders', JSON.stringify(itemOrders));
                        }
                        populateItemSortSectionDropdown();
                        renderInventoryPage();
                    }
                });
                unsubscribeListeners.push(settingsUnsubscribe);
            };
        
            dbPath.get().then(docSnapshot => {
                if (!docSnapshot.exists) {
                    dbPath.set({ createdAt: new Date().toISOString() }).then(setupListeners);
                } else {
                    setupListeners();
                }
            }).catch(error => {
                console.error("Error in listenForLiveUpdates:", error);
            });
        }

        function detachListeners() {
            unsubscribeListeners.forEach(unsubscribe => unsubscribe());
            unsubscribeListeners = [];
        }

        // --- Offline Database (localStorage) ---
        const offlineDB = {
            getData: (key) => {
                const data = localStorage.getItem(key);
                if (!data) return [];
                try {
                    return JSON.parse(data);
                } catch (e) {
                    console.error(`Error parsing localStorage data for key: ${key}`, e);
                    console.warn(`Data for key '${key}' was corrupted. Resetting to empty array.`);
                    localStorage.removeItem(key);
                    return [];
                }
            },
            setData: (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    console.error(`Error saving data to localStorage for key: ${key}`, e);
                    showToast('‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error');
                }
            },
            init: function() {
                sections = this.getData('sections');
                allItems = this.getData('items');
                users = this.getData('users');
                ledger = this.getData('ledger');
                archivedReports = this.getData('archivedReports');
                expandedSections = JSON.parse(localStorage.getItem('expandedSections') || '{}');
                this.renderAll();
            },
            renderAll: function() {
                renderInventoryPage();
                renderUsersPage();
                renderArchivedReports();
                updateSlidingNotifications();
            }
        };

        // --- Page Navigation ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`${pageId}-page`).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // --- Render Functions ---
        const defaultSort = (a, b) => {
            const naturalCompare = (strA, strB) => {
                const regex = /(\d+(\.\d+)?)|([a-zA-Z]+)/g;
                const partsA = strA.match(regex) || [];
                const partsB = strB.match(regex) || [];
                const len = Math.min(partsA.length, partsB.length);
                for (let i = 0; i < len; i++) {
                    const partA = partsA[i], partB = partsB[i];
                    const numA = parseFloat(partA), numB = parseFloat(partB);
                    if (!isNaN(numA) && !isNaN(numB)) {
                        if (numA < numB) return -1;
                        if (numA > numB) return 1;
                    } else {
                        const comparison = partA.localeCompare(partB);
                        if (comparison !== 0) return comparison;
                    }
                }
                return partsA.length - partsB.length;
            };
            return naturalCompare(a.name, b.name);
        };

        const sortControllingDevice = (a, b) => {
            const order = [
                'Magnetic Contact (Chint)25A-220v',
                'Magnetic Contact 60A',
                'Magnetic Contactor 125A',
                'Floatless Relay Boiler',
                'Timer (PUNEI,Heat Seal)',
                'Timer',
                'Timer 8Pin',
                'Timer Fusing (Analog)',
                'Mini DC Relay 5V',
                'Phase Failure Relay',
                'Solid State Relay',
                'Temperature Controller (Heat Seal)',
                'Temperature Controller (Fusing, Oshima)',
                'Temperature Controller (Fusing, Hasima)',
                'Thermocouple (Heat Seal)',
                'Thermocouple (Fusing)',
                'Thermostate (Electric Steam Iron)',
                'Speed Controller Rib Cutter',
                'Sensor (End Cutter, Flat Type)',
                'Sensor (End Cutter, Round Type)',
                'Day Night Sensor',
                'Power Supply 24V-10A',
                'Power Supply 24V-20A',
                'AVR-SX440',
                'Dol Starter 4-6Amp',
                'PFI Controller Meter',
                'DB Indicator (Red)',
                'DB Indicator (Yellow)',
                'DB Indicator (Blue)',
                'Cooling Fan 4"',
                'Buzzer'
            ];
        
            const indexA = order.indexOf(a.name);
            const indexB = order.indexOf(b.name);
        
            if (indexA === -1) return 1;
            if (indexB === -1) return -1;
        
            return indexA - indexB;
        };

        const sortCuttingAndSpecialParts = (a, b) => {
            const order = [
                'Round Knife',
                'Small Knife (Eastman)',
                'Small Knife (Winda)',
                'Small Knife (Spreading)',
                'Sharpness Stone',
                'Carbon Brush (Double Spring)',
                'Carbon Brush (Single Spring)',
                'Feed Belt (End Cutter)',
                'PU Belt (Spreading)',
                'Timing Belt (End Cutter, Winda)',
                'Timing Belt (Lift)',
                'Fabrics Relax Roller Belt',
                'Belt Fusing (Kai)450MS',
                'Belt Fusing (Hasima)HP 600 LFS',
                'Belt Fusing (Oshima)OP-900A',
                'Puly End Cutter',
                'Chain (Fusing)',
                'Roller Spring (Fusing)Hasima',
                'Roller Spring (Fusing)Oshima'
            ];
        
            const indexA = order.indexOf(a.name);
            const indexB = order.indexOf(b.name);
        
            if (indexA === -1) return 1;
            if (indexB === -1) return -1;
        
            return indexA - indexB;
        };

        const sortSwitchItems = (a, b) => {
            const order = [
                '3-Pin Plug',
                '3-Pin Socket',
                'CM Plug',
                'Rocker Switch (Small)',
                'Rocker Switch (Big)',
                'Motor Switch',
                'Iron Table Switch',
                'Push Button Switch (Chint)',
                'Push Button Switch (Lock Type)',
                'Push Button Switch (Without Lock Type)',
                'Emergency Stop Switch (Lock Type)',
                'Emergency Stop Switch (Without Lock Type)',
                'Mini Push Button Switch (Round,Lock Type)',
                'Limit Switch (Regular)',
                'Limit Switch (with Wheel)',
                'Limit Switch (Boiler Table)',
                'Limit Switch (Fusing)Omron Indonesia',
                'Toggle Switch',
                'Thinner Gun Switch',
                'Selector Switch Amp.',
                'Selector Switch volt.',
                'Selector Switch (Chint)',
                'Float Switch',
                'Fog Light NC Switch',
                'Fog Light NO Switch',
                'Thinner Gun Nozzle',
                'HRC Fuse 63A',
                'HRC Fuse 125A',
                'HRC Fuse Base'
            ];
        
            const indexA = order.indexOf(a.name);
            const indexB = order.indexOf(b.name);
        
            if (indexA === -1) return 1;
            if (indexB === -1) return -1;
        
            return indexA - indexB;
        };

        const sortLightItems = (a, b) => {
            const order = [
                'LED Color Light (9W) Yellow',
                'AC/DC Light (10W)',
                'LED Light (12W)',
                'LED Bullet (50W)',
                'Led Flood Light 100W',
                'LED Tube (1ft)',
                'LED Tube (T5)',
                'LED Tube (T8)',
                'LED Tube (D65)',
                'Fluorescent tube (D65)',
                'Panel Light (9"x9")',
                'Panel Light (12"x12")',
                'Panel Light (Round)',
                "Panel Light (1'x4')",
                "Panel Light (2'x4')",
                'Machine Light',
                'Exit Light',
                'Exit Light (Double Arrow)',
                'Exit Light (Single Arrow)',
                'Fog Light',
                'Pest Killer',
                'Pest Killer Tube (Led, 1.5ft)',
                'Pest Killer Tube (LED, 2ft)',
                'Spot Light'
            ];
        
            const indexA = order.indexOf(a.name);
            const indexB = order.indexOf(b.name);
        
            if (indexA === -1) return 1;
            if (indexB === -1) return -1;
        
            return indexA - indexB;
        };
        
        const sortCables = (a, b) => {
            const colorOrder = { 'red': 1, 'yellow': 2, 'blue': 3, 'black': 4, 'green': 5 };
            const extractInfo = (name) => {
                const lowerName = name.toLowerCase();
                const sizeMatch = name.match(/(\d+(\.\d+)?)mm/);
                const size = sizeMatch ? parseFloat(sizeMatch[1]) : (lowerName.includes('flexible') ? 200 : (lowerName.includes('pa cable') ? 300 : 100));
                let colorRank = 99;
                for (const color in colorOrder) {
                    if (lowerName.includes(color)) {
                        colorRank = colorOrder[color];
                        break;
                    }
                }
                return { size, colorRank };
            };
            const infoA = extractInfo(a.name), infoB = extractInfo(b.name);
            if (infoA.size !== infoB.size) return infoA.size - infoB.size;
            if (infoA.colorRank !== infoB.colorRank) return infoA.colorRank - infoB.colorRank;
            return defaultSort(a, b);
        };

        const sortMotorRewinding = (a, b) => {
            const rankMap = { 'copper wire': 1, 'ampere tube': 2, 'insulation paper': 3, 'varnish': 4, 'cotton tape': 5 };
            const getRank = (name) => {
                const lowerName = name.toLowerCase();
                for (const keyword in rankMap) {
                    if (lowerName.includes(keyword)) return rankMap[keyword];
                }
                return 999;
            };
            const rankA = getRank(a.name), rankB = getRank(b.name);
            if (rankA !== rankB) return rankA - rankB;
            return defaultSort(a, b);
        };

        const sortBearingItems = (a, b) => {
            const extractData = (name) => {
                const lowerName = name.toLowerCase();
                let type = 'standard';
                if (lowerName.includes('fusing')) {
                    type = 'fusing';
                } else if (lowerName.includes('coupling')) {
                    type = 'coupling';
                }
        
                const standardMatch = lowerName.match(/bearing (\d+)/);
                const couplingMatch = lowerName.match(/\(p(\d+)\)/);
        
                let primaryNumber = Infinity;
        
                if (standardMatch) {
                    primaryNumber = parseInt(standardMatch[1], 10);
                } else if (couplingMatch) {
                    primaryNumber = parseInt(couplingMatch[1], 10);
                }
        
                return {
                    type: type,
                    primaryNumber: primaryNumber,
                    originalName: name
                };
            };
        
            const dataA = extractData(a.name);
            const dataB = extractData(b.name);
        
            const typeOrder = { 'standard': 1, 'fusing': 2, 'coupling': 3 };
            if (typeOrder[dataA.type] !== typeOrder[dataB.type]) {
                return typeOrder[dataA.type] - typeOrder[dataB.type];
            }
        
            if (dataA.primaryNumber !== dataB.primaryNumber) {
                return dataA.primaryNumber - dataB.primaryNumber;
            }
        
            return a.name.localeCompare(b.name);
        };
        
        const sortMotorAccessories = (a, b) => {
            const order = [
                'Cutting Machine Clutch',
                'Motor Spring',
                'Pulley Cover',
                'Pulley Cover Screw',
                'Pulley Key',
                'Cork Sheet',
                'Iron Table Nut 17CM/8 No'
            ];
        
            const indexA = order.indexOf(a.name);
            const indexB = order.indexOf(b.name);
        
            if (indexA === -1) return 1;
            if (indexB === -1) return -1;
        
            return indexA - indexB;
        };

        const sortCapacitorItems = (a, b) => {
            const rankMap = { 'capacitor': 1 };
            const getRank = (name) => {
                const lowerName = name.toLowerCase();
                for (const keyword in rankMap) {
                    if (lowerName.includes(keyword)) return rankMap[keyword];
                }
                return 999;
            };
            const rankA = getRank(a.name), rankB = getRank(b.name);
            if (rankA !== rankB) return rankA - rankB;
            return defaultSort(a, b);
        };

        const sortAirFittings = (a, b) => {
            const extractData = (name) => {
                const lowerName = name.toLowerCase();
                
                const typeRanks = {
                    'bush nipple': 1,
                    'i-socket': 2,
                    't-socket': 3,
                    'l-socket': 4,
                    'regulator socket': 5,
                    'air regulator': 6,
                    'pneumatic pipe': 7,
                    'air gun': 8,
                    'solenoid valve': 9,
                    'hose clamp': 10,
                    'u-clamp': 11
                };
                
                let typeRank = 99;
                let itemType = 'other';
                for (const key in typeRanks) {
                    if (lowerName.startsWith(key)) {
                        typeRank = typeRanks[key];
                        itemType = key;
                        break;
                    }
                }
        
                const sizeMatch = lowerName.match(/(\d+)\s*x\s*(\d+)\s*x\s*(\d+)|(\d+)\s*x\s*(\d+)|(\d+)\s*mm|(\d+)"/);
                let sizes = [];
                if (sizeMatch) {
                    if (sizeMatch[1]) sizes = [parseInt(sizeMatch[1]), parseInt(sizeMatch[2]), parseInt(sizeMatch[3])];
                    else if (sizeMatch[4]) sizes = [parseInt(sizeMatch[4]), parseInt(sizeMatch[5])];
                    else if (sizeMatch[6]) sizes = [parseInt(sizeMatch[6])];
                    else if (sizeMatch[7]) sizes = [parseInt(sizeMatch[7])];
                }
        
                return { typeRank, itemType, sizes };
            };
        
            const dataA = extractData(a.name);
            const dataB = extractData(b.name);
        
            if (dataA.typeRank !== dataB.typeRank) {
                return dataA.typeRank - dataB.typeRank;
            }
        
            if (dataA.sizes.length > 0 && dataB.sizes.length > 0) {
                const minLength = Math.min(dataA.sizes.length, dataB.sizes.length);
                for (let i = 0; i < minLength; i++) {
                    if (dataA.sizes[i] !== dataB.sizes[i]) {
                        return dataA.sizes[i] - dataB.sizes[i];
                    }
                }
                if (dataA.sizes.length !== dataB.sizes.length) {
                    return dataA.sizes.length - dataB.sizes.length;
                }
            }
        
            return a.name.localeCompare(b.name);
        };
        
        const sortSteamLineFittings = (a, b) => {
            const order = [
                'Iron Pipe (A-Type)',
                'Iron Pipe (C-Type)',
                'Iron Pipe (E-Type)',
                'Iron Key (Silver Star)',
                'Iron Key (Oshima)',
                'Iron Valve (Oshima)',
                'Iron Out Line Bulb',
                'Iron Pipe Cover',
                'Pressure Gauge Meter',
                'Gasket Slack',
                'GI Socket 1"'
            ];
        
            const indexA = order.indexOf(a.name);
            const indexB = order.indexOf(b.name);
        
            if (indexA === -1) return 1;
            if (indexB === -1) return -1;
        
            return indexA - indexB;
        };

        const sortWiringItems = (a, b) => {
            const extractData = (name) => {
                const lowerName = name.toLowerCase();
                let rank = 999;
                let value1 = 0;
                let colorRank = 99;
        
                const sizeMatch = lowerName.match(/(\d+(\.\d+)?)\s*(inch|mm|no|a)?/);
                if (sizeMatch) {
                    value1 = parseFloat(sizeMatch[1]);
                }
        
                const colorOrder = { red: 1, yellow: 2, blue: 3, black: 4, green: 5 };
                for (const color in colorOrder) {
                    if (lowerName.includes(color)) {
                        colorRank = colorOrder[color];
                        break;
                    }
                }
        
                if (lowerName.startsWith('flexible pipe')) {
                    rank = 1;
                } else if (lowerName.startsWith('metal flexible pipe')) {
                    rank = 2;
                } else if (lowerName.startsWith('pvc channel')) {
                    rank = 3;
                } else if (lowerName.startsWith('mk box')) {
                    rank = 4;
                } else if (lowerName.startsWith('false cover')) {
                    rank = 5;
                } else if (lowerName.startsWith('ceiling ebonite')) {
                    rank = 6;
                } else if (lowerName.startsWith('circuit box')) {
                    rank = 7;
                } else if (lowerName.startsWith('connector')) {
                    rank = 8;
                } else if (lowerName.startsWith('twist-on wire connector')) {
                    rank = 9;
                } else if (lowerName.startsWith('cable lugs')) {
                    rank = 10;
                } else if (lowerName.startsWith('cable clip')) {
                    rank = 11;
                } else if (lowerName.startsWith('cable tie')) {
                    rank = 12;
                } else if (lowerName.startsWith('saddle')) {
                    rank = 13;
                } else if (lowerName.startsWith('star screw')) {
                    rank = 14;
                } else if (lowerName.startsWith('easy bolt')) {
                    rank = 15;
                } else if (lowerName.startsWith('royal bolt')) {
                    rank = 16;
                } else if (lowerName.startsWith('royal plug')) {
                    rank = 17;
                } else if (lowerName.startsWith('batten holder')) {
                    rank = 18;
                } else if (lowerName.startsWith('pvc tape')) {
                    rank = 19;
                } else if (lowerName.startsWith('thread tape')) {
                    rank = 20;
                } else if (lowerName.startsWith('pib tape')) {
                    rank = 21;
                } else if (lowerName.startsWith('ceiling fan canopy')) {
                    rank = 22;
                } else if (lowerName.startsWith('ceiling fan rubber')) {
                    rank = 23;
                } else if (lowerName.startsWith('numbering tag')) {
                    rank = 24;
                } else if (lowerName.startsWith('busbar insulator')) {
                    rank = 25;
                } else if (lowerName.startsWith('fan hook')) {
                    rank = 26;
                } else if (lowerName.startsWith('17mm nut')) {
                    rank = 27;
                } else if (lowerName.startsWith('turn buckle')) {
                    rank = 28;
                } else if (lowerName.startsWith('fevicol gum')) {
                    rank = 29;
                } else if (lowerName.startsWith('wd-40')) {
                    rank = 30;
                } else if (lowerName.startsWith('heat shrink tube')) {
                    rank = 31;
                }
        
                return { rank, value1, colorRank };
            };
        
            const dataA = extractData(a.name);
            const dataB = extractData(b.name);
        
            if (dataA.rank !== dataB.rank) {
                return dataA.rank - dataB.rank;
            }
        
            if (dataA.rank === 31) {
                if (dataA.value1 !== dataB.value1) {
                    return dataA.value1 - dataB.value1;
                }
                return dataA.colorRank - dataB.colorRank;
            }
        
            if (dataA.value1 !== dataB.value1) {
                return dataA.value1 - dataB.value1;
            }
        
            return a.name.localeCompare(b.name);
        };

        const sortElectronics = (a, b) => {
            const extractData = (name) => {
                const lowerName = name.toLowerCase();
                let rank = 99;
                let value1 = 0;
                let value2 = 0;
        
                if (lowerName.startsWith('transformer')) {
                    rank = 1;
                    const vMatch = lowerName.match(/(\d+)v/);
                    const aMatch = lowerName.match(/(\d+)a/);
                    const maMatch = lowerName.match(/(\d+)ma/);
                    const ohmMatch = lowerName.match(/(\d+)\s*ohm/);
                    if (vMatch) value1 = parseFloat(vMatch[1]);
                    if (aMatch) value2 = parseFloat(aMatch[1]) * 1000;
                    if (maMatch) value2 = parseFloat(maMatch[1]);
                    if (ohmMatch) value1 = 999;
                } else if (lowerName.startsWith('speaker')) {
                    rank = 2;
                } else if (lowerName.includes('led chip')) {
                    rank = 3;
                    const wMatch = lowerName.match(/(\d+)w/);
                    if (wMatch) value1 = parseFloat(wMatch[1]);
                } else if (lowerName.startsWith('indicator light')) {
                    rank = 4;
                } else if (lowerName.startsWith('capacitor')) {
                    rank = 5;
                    const ufMatch = lowerName.match(/(\d+)uf/);
                    if (ufMatch) value1 = parseFloat(ufMatch[1]);
                } else if (lowerName.startsWith('ceramic capacitor')) {
                    rank = 6;
                } else if (lowerName.startsWith('diode')) {
                    rank = 7;
                } else if (lowerName.startsWith('zener diode')) {
                    rank = 8;
                } else if (lowerName.startsWith('bridge rectifier')) {
                    rank = 9;
                } else if (lowerName.startsWith('fuse resistor')) {
                    rank = 10;
                } else if (lowerName.startsWith('resistor')) {
                    rank = 11;
                } else if (lowerName.startsWith('transistor')) {
                    rank = 12;
                } else if (lowerName.startsWith('mosfet')) {
                    rank = 13;
                } else if (lowerName.startsWith('optocoupler')) {
                    rank = 14;
                } else if (lowerName.startsWith('voltage regulator')) {
                    rank = 15;
                    if (lowerName.includes('lm317')) value1 = 1;
                } else if (lowerName.startsWith('soldering paste')) {
                    rank = 20;
                } else if (lowerName.startsWith('soldering wire')) {
                    rank = 21;
                } else if (lowerName.startsWith('thermal paste')) {
                    rank = 22;
                } else if (lowerName.startsWith('both side tape')) {
                    rank = 23;
                } else if (lowerName.startsWith('glue stick')) {
                    rank = 24;
                } else if (lowerName.startsWith('silicone rubber')) {
                    rank = 25;
                } else if (lowerName.startsWith('contact cleaner')) {
                    rank = 26;
                }
        
                return { rank, value1, value2 };
            };
        
            const dataA = extractData(a.name);
            const dataB = extractData(b.name);
        
            if (dataA.rank !== dataB.rank) {
                return dataA.rank - dataB.rank;
            }
        
            if (dataA.rank === 1) {
                if (dataA.value1 !== dataB.value1) {
                    return dataA.value1 - dataB.value1;
                }
                return dataA.value2 - dataB.value2;
            }
            
            if (dataA.value1 !== dataB.value1) {
                return dataA.value1 - dataB.value1;
            }
        
            return a.name.localeCompare(b.name);
        };

        const sortBatteryItems = (a, b) => {
            const extractData = (name) => {
                const lowerName = name.toLowerCase();
                
                const voltageMatch = lowerName.match(/(\d+(\.\d+)?)v/);
                const voltage = voltageMatch ? parseFloat(voltageMatch[1]) : Infinity;
        
                const ampereMatch = lowerName.match(/(\d+(\.\d+)?)a/);
                const ampere = ampereMatch ? parseFloat(ampereMatch[1]) : 0;
        
                const isRechargeable = lowerName.includes('rechargeable');
        
                const typeMatch = lowerName.match(/\b(aa|aaa|c|d|cr-?\d+)\b/);
                const type = typeMatch ? typeMatch[0] : lowerName;
        
                return { voltage, ampere, isRechargeable, type };
            };
        
            const dataA = extractData(a.name);
            const dataB = extractData(b.name);
        
            if (dataA.voltage !== dataB.voltage) {
                return dataA.voltage - dataB.voltage;
            }
        
            if (dataA.ampere !== dataB.ampere) {
                return dataA.ampere - dataB.ampere;
            }
        
            if (dataA.isRechargeable !== dataB.isRechargeable) {
                return dataA.isRechargeable ? 1 : -1;
            }
        
            if (dataA.type !== dataB.type) {
                if (dataA.type === 'aa' && dataB.type === 'aaa') return -1;
                if (dataA.type === 'aaa' && dataB.type === 'aa') return 1;
                
                return dataA.type.localeCompare(dataB.type);
            }
        
            return a.name.localeCompare(b.name);
        };
        
        const sortCircuitBreakerItems = (a, b) => {
            const extractData = (name) => {
                const lowerName = name.toLowerCase();
                let rank = 99;
                let amp = 0;
        
                const ampMatch = lowerName.match(/(\d+)a/);
                if (ampMatch) {
                    amp = parseInt(ampMatch[1], 10);
                }
        
                if (lowerName.includes('(sp-')) {
                    rank = 1;
                } else if (lowerName.includes('(dp-')) {
                    rank = 2;
                } else if (lowerName.includes('(tp-')) {
                    rank = 3;
                } else if (lowerName.startsWith('mccb')) {
                    rank = 4;
                } else if (lowerName.includes('comb busbar')) {
                    rank = 5;
                } else if (lowerName.includes('stopper')) {
                    rank = 6;
                }
                
                return { rank, amp };
            };
        
            const dataA = extractData(a.name);
            const dataB = extractData(b.name);
        
            if (dataA.rank !== dataB.rank) {
                return dataA.rank - dataB.rank;
            }
        
            if (dataA.amp !== dataB.amp) {
                return dataA.amp - dataB.amp;
            }
        
            return a.name.localeCompare(b.name);
        }; 

        const sortHandTools = (a, b) => {
            const extractData = (name) => {
                const lowerName = name.toLowerCase();
                let rank = 99;
                let size = 0;
        
                const sizeMatch = lowerName.match(/(\d+(\.\d)?)mm/);
                if (sizeMatch) {
                    size = parseFloat(sizeMatch[1]);
                }
        
                if (lowerName.startsWith('drill bit (iron)')) {
                    rank = 1;
                } else if (lowerName.startsWith('drill bit (hammer)')) {
                    rank = 2;
                } else if (lowerName.startsWith('hammer')) {
                    rank = 3;
                    if (lowerName.includes('1pound') || lowerName.includes('1 pound')) size = 1;
                    if (lowerName.includes('half pound')) size = 0.5;
                } else if (lowerName.startsWith('combination pliers')) {
                    rank = 4;
                } else if (lowerName.startsWith('combination cutting pliers')) {
                    rank = 5;
                } else if (lowerName.startsWith('adjustable wrench')) { // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∏‡¶Ç‡¶∂‡ßã‡¶ß‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
                    rank = 6;
                } else if (lowerName.startsWith('tester')) {
                    rank = 7;
                } else if (lowerName.startsWith('cable cutter')) {
                    rank = 8;
                } else if (lowerName.startsWith('metal cutter')) {
                    rank = 9;
                } else if (lowerName.startsWith('clump on meter')) {
                    rank = 10;
                } else if (lowerName.startsWith('hot glue gun')) {
                    rank = 11;
                } else if (lowerName.startsWith('hacksaw blade')) {
                    rank = 12;
                } else if (lowerName.startsWith('grinding disk')) {
                    rank = 13;
                }
                
                return { rank, size };
            };
        
            const dataA = extractData(a.name);
            const dataB = extractData(b.name);
        
            if (dataA.rank !== dataB.rank) {
                return dataA.rank - dataB.rank;
            }
        
            if (dataA.size !== dataB.size) {
                return dataA.size - dataB.size;
            }
        
            return a.name.localeCompare(b.name);
        };
        
        const sortBeltItems = (a, b) => {
            const extractInfo = (name) => {
                const typeMatch = name.match(/Belt ([A-Z]{1,2})-/);
                const type = typeMatch ? typeMatch[1] : 'ZZZ';
                const numMatch = name.match(/-(\d+)/);
                const num = numMatch ? parseInt(numMatch[1]) : Infinity;
                return { type, num };
            };
            const infoA = extractInfo(a.name), infoB = extractInfo(b.name);
            if (infoA.type !== infoB.type) return infoA.type.localeCompare(infoB.type);
            if (infoA.num !== infoB.num) return infoA.num - infoB.num;
            return defaultSort(a, b);
        };       
        
        const masterSortFunction = (sectionName) => {
            const sortMap = {
                "Controlling Device (Automation)": sortControllingDevice,
                "Cutting & Special Machine Parts": sortCuttingAndSpecialParts,
                "Switch,Socket,Plug Items": sortSwitchItems,
                "Light Items": sortLightItems,
                "Cable": sortCables,
                "Motor Rewinding": sortMotorRewinding,
                "Bearing Items": sortBearingItems,
                "Motor Accessories": sortMotorAccessories,
                "Capacitor Items": sortCapacitorItems,
                "Air Fittings": sortAirFittings,
                "Steam Line Fittings": sortSteamLineFittings,
                "Wiring Items": sortWiringItems,
                "Electronics": sortElectronics,
                "Battery Items": sortBatteryItems,
                "Circuit Breaker Items": sortCircuitBreakerItems,
                "Hand Tools": sortHandTools,
                "Belt Items": sortBeltItems
            };
            return sortMap[sectionName] || defaultSort;
        };

        function sortSections(sections, searchTerm) {
            const customOrder = sectionOrder;
            
            return [...sections].sort((a, b) => {
                if (searchTerm) {
                    if (b.maxScore !== a.maxScore) {
                        return b.maxScore - a.maxScore;
                    }
                }
                
                const indexA = customOrder.indexOf(a.name);
                const indexB = customOrder.indexOf(b.name);
        
                if (indexA !== -1 && indexB !== -1) {
                    return indexA - indexB;
                }
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
        
                return a.name.localeCompare(b.name);
            });
        }

        async function resetSectionOrderToDefault() {
            if (!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶ï‡ßç‡¶∞‡¶Æ ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü (A-Z) ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡ßü ‡¶´‡¶ø‡¶∞‡¶ø‡ßü‡ßá ‡¶Ü‡¶®‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
                return;
            }
        
            localStorage.removeItem('sectionOrder');
            itemOrders = {};
            localStorage.removeItem('itemOrders');
        
            const allSectionNames = [...new Set(sections.map(s => s.name))];
            sectionOrder = allSectionNames.sort((a, b) => a.localeCompare(b));
            
            renderSortableList();
            populateItemSortSectionDropdown();
            
            showToast('‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶ï‡ßç‡¶∞‡¶Æ ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡ßü ‡¶Ü‡¶®‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡¶ü‡¶ø ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ ‡¶ï‡¶∞‡¶§‡ßá "‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'warning');
        }

        function initializeSortableList() {
            const sortableList = document.getElementById('sortable-sections');
            if (!sortableList) return;
        
            const savedOrder = JSON.parse(localStorage.getItem('sectionOrder')) || [];
            const allSectionNames = [...new Set(sections.map(s => s.name))];
        
            if (savedOrder.length > 0 && savedOrder.every(name => allSectionNames.includes(name)) && savedOrder.length === allSectionNames.length) {
                sectionOrder = savedOrder;
            } else {
                sectionOrder = allSectionNames.sort((a, b) => a.localeCompare(b));
            }
            
            renderSortableList();
        
            if (sortableInstance) {
                sortableInstance.destroy();
            }
            sortableInstance = new Sortable(sortableList, {
                animation: 150,
                ghostClass: 'dragging',
                handle: '.drag-handle'
            });
        
            const saveBtn = document.getElementById('saveSectionOrderBtn');
            const resetBtn = document.getElementById('resetSectionOrderBtn');
        
            if (saveBtn) {
                saveBtn.removeEventListener('click', saveSectionOrder);
                saveBtn.addEventListener('click', saveSectionOrder);
            }
        
            if (resetBtn) {
                resetBtn.removeEventListener('click', resetSectionOrderToDefault);
                resetBtn.addEventListener('click', resetSectionOrderToDefault);
            }
        }

        function renderSortableList() {
            const sortableList = document.getElementById('sortable-sections');
            if (!sortableList) return;
            
            sortableList.innerHTML = '';
            sectionOrder.forEach(sectionName => {
                const li = document.createElement('li');
                li.dataset.section = sectionName;
                li.innerHTML = `
                    <span class="drag-handle">‚â°</span>
                    <span class="section-text">${sectionName}</span>
                `;
                sortableList.appendChild(li);
            });
        }

        async function saveSectionOrder() {
            const sortableList = document.getElementById('sortable-sections');
            if (!sortableList) return;
        
            const pinVerified = await requestPinAndExecute();
            if (!pinVerified) return;
        
            const newOrder = Array.from(sortableList.getElementsByTagName('li')).map(li => li.dataset.section);
            
            sectionOrder = newOrder;
            localStorage.setItem('sectionOrder', JSON.stringify(sectionOrder));
            
            const dbPath = getDbPath();
            if (auth.currentUser && dbPath) {
                const userSettingsRef = db.collection('inventories').doc(dbPath.id).collection('app_state').doc('settings');
                await userSettingsRef.set({ sectionOrder: newOrder }, { merge: true });
            }
        
            showToast('‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßç‡¶∞‡¶Æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!');
            renderInventoryPage();
            populateItemSortSectionDropdown();
        }

        function initializeItemSortableList() {
            const sectionSelect = document.getElementById('item-sort-section-select');
            const selectedSection = sectionSelect.value;
            const sortableList = document.getElementById('sortable-items');
            const buttonsContainer = document.getElementById('item-sort-buttons-container');
            let itemSortableInstance = null;
        
            sortableList.innerHTML = '';
        
            if (!selectedSection) {
                buttonsContainer.style.display = 'none';
                return;
            }
        
            buttonsContainer.style.display = 'grid';
            
            let itemsInSection = allItems.filter(item => item.section === selectedSection);
            const customOrder = itemOrders[selectedSection] || [];
            const defaultSortFunc = masterSortFunction(selectedSection);
        
            if (customOrder.length > 0) {
                itemsInSection.sort((a, b) => {
                    const indexA = customOrder.indexOf(a.id);
                    const indexB = customOrder.indexOf(b.id);
                    if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                    if (indexA !== -1) return -1;
                    if (indexB !== -1) return 1;
                    return defaultSortFunc(a, b);
                });
            } else {
                itemsInSection.sort(defaultSortFunc);
            }
        
            itemsInSection.forEach(item => {
                const li = document.createElement('li');
                li.dataset.itemId = item.id;
                li.innerHTML = `<span class="drag-handle">‚â°</span><span class="section-text">${item.name}</span>`;
                sortableList.appendChild(li);
            });
        
            if (itemSortableInstance) {
                itemSortableInstance.destroy();
            }
            itemSortableInstance = new Sortable(sortableList, {
                animation: 150,
                ghostClass: 'dragging',
                handle: '.drag-handle'
            });
        
            document.getElementById('saveItemOrderBtn').onclick = saveItemOrder;
            document.getElementById('resetItemOrderBtn').onclick = resetItemOrderToDefault;
        }
        
        function populateItemSortSectionDropdown() {
            const sectionSelect = document.getElementById('item-sort-section-select');
            if (!sectionSelect) return;
        
            const options = sectionOrder.map(name => `<option value="${name}">${name}</option>`).join('');
            sectionSelect.innerHTML = '<option value="">-- ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶¨‡¶æ‡¶õ‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶® --</option>' + options;
            
            initializeItemSortableList();
        }
        
        async function saveItemOrder() {
            const sectionSelect = document.getElementById('item-sort-section-select');
            const selectedSection = sectionSelect.value;
            if (!selectedSection) return;
        
            const pinVerified = await requestPinAndExecute();
            if (!pinVerified) return;
        
            const sortableList = document.getElementById('sortable-items');
            const newOrder = Array.from(sortableList.getElementsByTagName('li')).map(li => li.dataset.itemId);
        
            itemOrders[selectedSection] = newOrder;
            localStorage.setItem('itemOrders', JSON.stringify(itemOrders));
        
            const dbPath = getDbPath();
            if (auth.currentUser && dbPath) {
                const settingsRef = dbPath.collection('app_state').doc('settings');
                await settingsRef.set({ itemOrders: itemOrders }, { merge: true });
            }
        
            showToast(`'${selectedSection}' ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶ï‡ßç‡¶∞‡¶Æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!`);
            renderInventoryPage();
        }
        // --- Stock Level Rule Management Functions ---
        
        async function openRuleManagementModal() {
            await loadRules();
            renderStockRules();
            openModal('ruleManagementModal');
        }
        
        async function loadRules() {
            const dbPath = getDbPath();
            if (navigator.onLine && dbPath) {
                try {
                    const doc = await dbPath.collection('app_state').doc('stock_rules').get();
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.default_levels) {
                            Object.assign(stockLevels, data.default_levels);
                        }
                        stockLevelRules = data.custom_rules || [];
                        localStorage.setItem('stockLevelRules', JSON.stringify(stockLevelRules));
                        localStorage.setItem('stockLevels', JSON.stringify(stockLevels));
                    }
                } catch (error) {
                    console.error("Error fetching stock rules:", error);
                }
            } else {
                const localDefault = JSON.parse(localStorage.getItem('stockLevels'));
                if (localDefault) Object.assign(stockLevels, localDefault);
                stockLevelRules = JSON.parse(localStorage.getItem('stockLevelRules') || '[]');
            }
        }
        
        function renderStockRules() {
            const container = document.getElementById('existing-rules-container');
            container.innerHTML = '';
        
            for (const unit in stockLevels) {
                const rule = stockLevels[unit];
                let description = `<strong>‡¶á‡¶â‡¶®‡¶ø‡¶ü:</strong> ${unit} (‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü)`;
                description += ` &rarr; <strong>Low:</strong> ${rule.low}, <strong>Very Low:</strong> ${rule.veryLow}, <strong>Critical:</strong> ${rule.critical}`;
        
                const ruleDiv = document.createElement('div');
                ruleDiv.className = 'ledger-entry';
                ruleDiv.style.padding = '8px 12px';
                ruleDiv.style.background = '#f8f9fa';
                ruleDiv.innerHTML = `
                    <span class="ledger-desc" style="font-size: 12px;">${description}</span>
                    <button class="delete-btn" onclick="editDefaultRule('${unit}')" title="‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶®‡¶ø‡ßü‡¶Æ ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®">‚úèÔ∏è</button>
                `;
                container.appendChild(ruleDiv);
            }
        
            stockLevelRules.forEach((rule, index) => {
                let description = `<strong>‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶®‡¶ø‡ßü‡¶Æ:</strong> ‡¶®‡¶æ‡¶Æ‡ßá <strong>"${rule.keyword}"</strong> ‡¶•‡¶æ‡¶ï‡¶≤‡ßá`;
                description += ` &rarr; <strong>Low:</strong> ${rule.levels.low}, <strong>Very Low:</strong> ${rule.levels.veryLow}, <strong>Critical:</strong> ${rule.levels.critical}`;
        
                const ruleDiv = document.createElement('div');
                ruleDiv.className = 'ledger-entry';
                ruleDiv.style.padding = '8px 12px';
                ruleDiv.style.background = 'var(--level-low-bg)';
                ruleDiv.innerHTML = `
                    <span class="ledger-desc" style="font-size: 12px;">${description}</span>
                    <button class="delete-btn" onclick="deleteStockRule(${index})" title="‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶®‡¶ø‡ßü‡¶Æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®">üóëÔ∏è</button>
                `;
                container.appendChild(ruleDiv);
            });
        }
        
        async function editDefaultRule(unit) {
            const pinVerified = await requestPinAndExecute();
            if (!pinVerified) return;
        
            const currentRule = stockLevels[unit];
            const newLow = prompt(`'${unit}' ‡¶á‡¶â‡¶®‡¶ø‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡¶§‡ßÅ‡¶® 'Low' ‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ‡¶¶‡¶ø‡¶®:`, currentRule.low);
            if (newLow === null) return;
            const newVeryLow = prompt(`'${unit}' ‡¶á‡¶â‡¶®‡¶ø‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡¶§‡ßÅ‡¶® 'Very Low' ‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ‡¶¶‡¶ø‡¶®:`, currentRule.veryLow);
            if (newVeryLow === null) return;
            const newCritical = prompt(`'${unit}' ‡¶á‡¶â‡¶®‡¶ø‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡¶§‡ßÅ‡¶® 'Critical' ‡¶≤‡ßá‡¶≠‡ßá‡¶≤ ‡¶¶‡¶ø‡¶®:`, currentRule.critical);
            if (newCritical === null) return;
        
            const low = parseFloat(newLow);
            const veryLow = parseFloat(newVeryLow);
            const critical = parseFloat(newCritical);
        
            if (isNaN(low) || isNaN(veryLow) || isNaN(critical)) {
                return showToast('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¶‡¶ø‡¶®‡•§', 'error');
            }
        
            stockLevels[unit] = { low, veryLow, critical };
            await saveRulesToDB();
            showToast(`'${unit}' ‡¶á‡¶â‡¶®‡¶ø‡¶ü‡ßá‡¶∞ ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶®‡¶ø‡ßü‡¶Æ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
            renderStockRules();
        }
        
        async function addNewStockRule(event) {
            event.preventDefault();
            const pinVerified = await requestPinAndExecute();
            if (!pinVerified) return;
        
            const newRule = {
                keyword: document.getElementById('rule-keyword').value.trim().toLowerCase(),
                levels: {
                    low: parseFloat(document.getElementById('rule-low').value),
                    veryLow: parseFloat(document.getElementById('rule-very-low').value),
                    critical: parseFloat(document.getElementById('rule-critical').value)
                }
            };
        
            if (!newRule.keyword) {
                return showToast('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶Ö‡¶Ç‡¶∂ (keyword) ‡¶¶‡¶ø‡¶®‡•§', 'error');
            }
            if (isNaN(newRule.levels.low) || isNaN(newRule.levels.veryLow) || isNaN(newRule.levels.critical)) {
                return showToast('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßá‡¶≠‡ßá‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¶‡¶ø‡¶®‡•§', 'error');
            }
        
            stockLevelRules.push(newRule);
            await saveRulesToDB();
            showToast('‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶®‡¶ø‡ßü‡¶Æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
            renderStockRules();
            event.target.reset();
        }
        
        async function deleteStockRule(index) {
            const pinVerified = await requestPinAndExecute();
            if (!pinVerified) return;
        
            stockLevelRules.splice(index, 1);
            await saveRulesToDB();
            showToast('‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶®‡¶ø‡ßü‡¶Æ‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
            renderStockRules();
        }
        
        async function saveRulesToDB() {
            localStorage.setItem('stockLevels', JSON.stringify(stockLevels));
            localStorage.setItem('stockLevelRules', JSON.stringify(stockLevelRules));
            
            const dbPath = getDbPath();
            if (navigator.onLine && dbPath) {
                try {
                    await dbPath.collection('app_state').doc('stock_rules').set({
                        default_levels: stockLevels,
                        custom_rules: stockLevelRules
                    });
                } catch (error) {
                    console.error("Error saving stock rules:", error);
                    showToast('‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶°‡ßá ‡¶®‡¶ø‡ßü‡¶Æ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error');
                }
            }
            renderInventoryPage();
        }

        async function resetDefaultRules() {
            if (!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶∏‡¶ï‡¶≤ ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶®‡¶ø‡ßü‡¶Æ‡¶ï‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶Æ‡ßÇ‡¶≤ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏‡ßá ‡¶´‡¶ø‡¶∞‡¶ø‡ßü‡ßá ‡¶Ü‡¶®‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶®‡¶ø‡ßü‡¶Æ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§")) {
                return;
            }
        
            const pinVerified = await requestPinAndExecute();
            if (!pinVerified) return;
        
            Object.assign(stockLevels, JSON.parse(JSON.stringify(originalStockLevels)));
        
            const dbPath = getDbPath();
            if (navigator.onLine && dbPath) {
                try {
                    await dbPath.collection('app_state').doc('stock_rules').set({
                        default_levels: stockLevels
                    }, { merge: true });
                } catch (error) {
                    console.error("Error resetting default rules in DB:", error);
                    showToast('‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶°‡ßá ‡¶®‡¶ø‡ßü‡¶Æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error');
                }
            }
        
            localStorage.setItem('stockLevels', JSON.stringify(stockLevels));
        
            showToast('‡¶∏‡¶ï‡¶≤ ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶®‡¶ø‡ßü‡¶Æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
            
            renderStockRules();
            renderInventoryPage();
        }
                
        function resetItemOrderToDefault() {
            const sectionSelect = document.getElementById('item-sort-section-select');
            const selectedSection = sectionSelect.value;
            if (!selectedSection) return;
        
            if (!confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá '${selectedSection}' ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶ï‡ßç‡¶∞‡¶Æ ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡ßü ‡¶´‡¶ø‡¶∞‡¶ø‡ßü‡ßá ‡¶Ü‡¶®‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) {
                return;
            }
        
            delete itemOrders[selectedSection];
            localStorage.setItem('itemOrders', JSON.stringify(itemOrders));
            
            initializeItemSortableList();
            
            showToast(`'${selectedSection}' ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶ï‡ßç‡¶∞‡¶Æ ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡¶ü‡¶ø ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ ‡¶ï‡¶∞‡¶§‡ßá "‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`, 'warning');
        }

        async function renderInventoryPage() {
            await loadRules();
        
            const container = document.getElementById('inventoryContainer');
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
            container.innerHTML = '';
        
            if (sections.length === 0) {
                container.innerHTML = `<p style="text-align: center; margin-top: 20px;">‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§</p>`;
                return;
            }
        
            let filteredAndScoredItems = [];
            if (searchTerm) {
                const searchWords = searchTerm.split(' ').filter(w => w);
                const firstSearchWord = searchWords[0] || '';
        
                filteredAndScoredItems = allItems
                    .map(item => {
                        const lowerItemName = item.name.toLowerCase();
                        let score = 0;
                        const allSearchWordsFound = searchWords.every(word => lowerItemName.includes(word));
        
                        if (allSearchWordsFound) {
                            const itemWords = lowerItemName.split(' ');
                            const firstItemWord = itemWords[0] || '';
                            if (firstItemWord === firstSearchWord) score = 4;
                            else if (firstItemWord.startsWith(firstSearchWord)) score = 3;
                            else if (itemWords.some(word => word.startsWith(firstSearchWord))) score = 2;
                            else score = 1;
                        }
                        return { ...item, score };
                    })
                    .filter(item => item.score > 0);
            } else {
                filteredAndScoredItems = allItems.map(item => ({ ...item, score: 0 }));
            }
        
            let foundItems = false;
            
            const sectionsWithScores = sections.map(section => {
                const itemsInSection = filteredAndScoredItems.filter(item => item.section === section.name);
                const maxScore = itemsInSection.length > 0 ? Math.max(...itemsInSection.map(item => item.score)) : 0;
                return { ...section, maxScore };
            });
        
            const sortedSections = sortSections(sectionsWithScores, searchTerm);
        
            sortedSections.forEach(section => {
                const sortFunction = masterSortFunction(section.name);
                const customItemOrder = itemOrders[section.name] || [];
                
                let sectionItems = filteredAndScoredItems
                    .filter(item => item.section === section.name);
                
                if (customItemOrder.length > 0) {
                    sectionItems.sort((a, b) => {
                        if (a.score !== b.score) return b.score - a.score;
                        const indexA = customItemOrder.indexOf(a.id);
                        const indexB = customItemOrder.indexOf(b.id);
                        if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                        if (indexA !== -1) return -1;
                        if (indexB !== -1) return 1;
                        return sortFunction(a, b);
                    });
                } else {
                    sectionItems.sort((a, b) => {
                        if (a.score !== b.score) return b.score - a.score;
                        return sortFunction(a, b);
                    });
                }
        
                if (sectionItems.length > 0) {
                    foundItems = true;
                    container.appendChild(createSectionCard(section, sectionItems));
                } else if (!searchTerm) {
                    container.appendChild(createSectionCard(section, []));
                }
            });
        
            if (!foundItems && searchTerm) {
                container.innerHTML = `<p style="text-align: center; margin-top: 20px;">'${searchInput.value}' ‡¶®‡¶æ‡¶Æ‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p>`;
            } else if (allItems.length === 0) {
                container.innerHTML = `<p style="text-align: center; margin-top: 20px;">‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§</p>`;
            }
        
            if (itemToHighlight) {
                setTimeout(() => {
                    const elementToScroll = document.querySelector(`[data-highlight-id='${itemToHighlight}']`);
                    if (elementToScroll) {
                        elementToScroll.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        elementToScroll.classList.add('highlight-flash');
                    }
                    itemToHighlight = null;
                }, 100);
            }
        }

        function createSectionCard(section, items) {
            const card = document.createElement('div');
            card.className = 'card';
            card.setAttribute('data-highlight-id', section.id);
            const isExpanded = expandedSections[section.id] || false;
            const itemsToShow = isExpanded ? items : items.slice(0, ITEMS_PER_PAGE);
        
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        
            let tableRowsHTML = itemsToShow.map(item => {
                let stockClass = '', stockIcon = '';
                const unit = item.unit || '‡¶™‡¶ø‡¶∏';
                const lowerItemName = item.name.toLowerCase();
                let levels = null;
        
                const customRule = stockLevelRules.find(rule => lowerItemName.includes(rule.keyword));
        
                if (customRule) {
                    levels = customRule.levels;
                } else {
                    levels = stockLevels[unit] || stockLevels['default'];
                }
        
                if (item.quantity <= levels.critical) {
                    stockClass = 'level-critical'; stockIcon = 'üö®';
                } else if (item.quantity <= levels.veryLow) {
                    stockClass = 'level-very-low'; stockIcon = 'üî•';
                } else if (item.quantity <= levels.low) {
                    stockClass = 'level-low'; stockIcon = '‚ö†Ô∏è';
                }
                
                const highlightClass = (searchTerm && lowerItemName.includes(searchTerm)) ? 'search-highlight' : '';
                
                return `<tr class="${stockClass} ${highlightClass}" data-highlight-id="${item.id}">
                            <td data-label="‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" class="item-name-cell" data-item-id="${item.id}">${item.name} <span class="stock-icon">${stockIcon}</span></td>
                            <td data-label="‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï" class="stock-cell" 
                                data-item-id="${item.id}" 
                                data-item-name="${item.name.replace(/"/g, '&quot;')}" 
                                data-item-quantity="${item.quantity}">
                                <strong>${toBengaliNumber(item.quantity)} ${unit}</strong>
                            </td>
                        </tr>`;
            }).join('');
            
            let expandButtonHTML = '';
            if (items.length > ITEMS_PER_PAGE) {
                const buttonText = isExpanded ? 'Less' : 'More';
                expandButtonHTML = `<button class="more-btn" onclick="toggleExpandSection('${section.id}')">${buttonText}</button>`;
            }
        
            card.innerHTML = `
                <div class="card-header">
                    <h2 class="section-title" data-section-id="${section.id}" data-section-name="${section.name.replace(/"/g, '&quot;')}">${section.name} (${toBengaliNumber(items.length)})</h2>
                    <button class="delete-btn delete-section-btn" data-section-id="${section.id}" data-section-name="${section.name.replace(/"/g, '&quot;')}">üóëÔ∏è</button>
                </div>
                <div class="card-body">
                    ${items.length > 0 ? `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th style="white-space: nowrap;">‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</th>
                                        <th style="text-align: right; white-space: nowrap;">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRowsHTML}
                                </tbody>
                            </table>
                        </div>
                        ${expandButtonHTML}` 
                    : '<p class="empty-section">‡¶è‡¶á ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶®‡ßá‡¶á‡•§</p>'}
                </div>`;
            
            card.querySelector('.section-title').addEventListener('click', (e) => {
                const target = e.currentTarget;
                editSectionName(target.dataset.sectionId, target.dataset.sectionName);
            });
        
            card.querySelector('.delete-section-btn').addEventListener('click', (e) => {
                const target = e.currentTarget;
                deleteSection(target.dataset.sectionId, target.dataset.sectionName);
            });
        
            card.querySelectorAll('.item-name-cell').forEach(cell => {
                cell.addEventListener('click', (e) => {
                    openItemDetailsModal(e.currentTarget.dataset.itemId);
                });
            });
        
            card.querySelectorAll('.stock-cell strong').forEach(strongTag => {
                const cell = strongTag.parentElement;
                strongTag.style.cursor = 'pointer'; 
            
                strongTag.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editStock(cell.dataset.itemId, cell.dataset.itemName, parseFloat(cell.dataset.itemQuantity));
                });
            
                strongTag.addEventListener('touchstart', (e) => handlePress(e, cell.dataset.itemId, 'unit'));
                strongTag.addEventListener('touchend', handleRelease);
                strongTag.addEventListener('mousedown', (e) => handlePress(e, cell.dataset.itemId, 'unit'));
                strongTag.addEventListener('mouseup', handleRelease);
                strongTag.addEventListener('mouseleave', handleRelease);
            });
            
            return card;
        }

        let pressTimer = null;
        
        function handlePress(event, primaryId, action, secondaryId = null) {
            const duration = (action === 'unit') ? 3000 : 1000;
        
            pressTimer = setTimeout(() => {
                event.preventDefault();
                event.stopPropagation();
        
                if (action === 'unit') {
                    editItemUnit(primaryId);
                } else if (action === 'deleteUserLedger') {
                    deleteSingleUserTransaction(primaryId, secondaryId);
                }
            }, duration);
        }

        function handleRelease() {
            clearTimeout(pressTimer);
        }
        
        async function editItemUnit(itemId) {
            const item = allItems.find(i => i.id === itemId);
            if (!item) return;
        
            const pinVerified = await requestPinAndExecute();
            if (!pinVerified) {
                showToast('‡¶™‡¶ø‡¶® ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü‡•§');
                return;
            }
        
            const newUnit = prompt(`'${item.name}' ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶â‡¶®‡¶ø‡¶ü ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®:`, item.unit);
        
            if (newUnit && newUnit.trim() !== '' && newUnit.trim().toLowerCase() !== item.unit.toLowerCase()) {
                const trimmedUnit = newUnit.trim();
                
                item.unit = trimmedUnit;
                localStorage.setItem('items', JSON.stringify(allItems));
        
                const dbPath = getDbPath();
                if (dbPath) {
                    dbPath.collection('items').doc(itemId).update({ unit: trimmedUnit })
                        .catch(error => console.error("Unit update failed in Firestore:", error));
                }
        
                showToast('‡¶á‡¶â‡¶®‡¶ø‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
                renderInventoryPage();
            } else if (newUnit) {
                showToast('‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§');
            }
        }

        function toggleExpandSection(sectionId) {
            expandedSections[sectionId] = !expandedSections[sectionId];
            localStorage.setItem('expandedSections', JSON.stringify(expandedSections));
            renderInventoryPage();
        }

        function toggleExcludeItem(button, itemId) {
            const row = button.closest('tr');
            const tempRequisition = JSON.parse(localStorage.getItem('tempRequisition') || '{}');
            let excludedItems = tempRequisition.excluded || [];
        
            if (row.classList.toggle('item-excluded')) {
                if (!excludedItems.includes(itemId)) {
                    excludedItems.push(itemId);
                }
                button.textContent = 'üîÑ';
            } else {
                excludedItems = excludedItems.filter(id => id !== itemId);
                button.textContent = '‚ùå';
            }
        
            tempRequisition.excluded = excludedItems;
            localStorage.setItem('tempRequisition', JSON.stringify(tempRequisition));
        }

        function renderUsersPage() {
            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            if (users.length === 0) {
                userList.innerHTML = '<p style="text-align: center; margin-top: 10px;">‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§</p>';
                return;
            }
        
            const sortedUsers = [...users].sort((a, b) => a.name.localeCompare(b.name));
        
            sortedUsers.forEach(user => {
                const userRow = document.createElement('div');
                userRow.className = 'user-row';
                userRow.innerHTML = `
                    <span class="user-name" onclick="showUserReport('${user.id}')">${user.name}</span>
                    <button class="delete-btn" onclick="deleteUser('${user.id}')">üóëÔ∏è</button>
                `;
                userList.appendChild(userRow);
            });
        }

        // --- Modal Controls ---
        let openModalCount = 0;
        
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
        
            if (openModalCount === 0) {
                scrollPosition = window.scrollY;
                document.body.classList.add('modal-open');
            }
            
            modal.classList.add('show');
            modal.style.display = 'flex';
            
            openModalCount++;
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
        
            modal.classList.remove('show');
            modal.style.display = 'none';
            
            openModalCount--;
        
            if (openModalCount < 0) {
                openModalCount = 0;
            }
        
            if (openModalCount === 0) {
                document.body.classList.remove('modal-open');
                window.scrollTo(0, scrollPosition);
            }
        }

        function openItemAddModal() {
            const formsContainer = document.getElementById('multiItemFormsContainer');
            formsContainer.innerHTML = '';
            if (sections.length > 0) {
                addFormRow();
            } else {
                // ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ü‡¶ø ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
                updateSaveButtonState();
            }
            document.getElementById('newSectionContainer').style.display = 'none';
            openModal('itemAddModal');
        }

        function updateSaveButtonState() {
            const container = document.getElementById('multiItemFormsContainer');
            const formCount = container.getElementsByClassName('item-form-card').length;
            const button = document.getElementById('save-all-items-btn');
        
            if (formCount > 1) {
                button.innerHTML = 'üíæ ‡¶∏‡¶¨ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®';
            } else {
                button.innerHTML = 'üíæ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®';
            }
        }

        function openItemDetailsModal(itemId) {
            activeItemId = itemId;
            const item = allItems.find(i => i.id === itemId);
            if (!item) return;
        
            document.getElementById('details-item-name').textContent = item.name;
            
            // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü‡¶≠‡¶æ‡¶¨‡ßá 'out' ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
            showLedgerTab('out'); 
            
            openModal('itemDetailsModal');
        }

        function renderLedger(type = 'out') {
            const container = document.getElementById('ledger-container');
            const loadMoreBtn = document.getElementById('load-more-ledger');
            container.innerHTML = '';
        
            const itemLedger = ledger.filter(l => l.itemId === activeItemId).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const filteredData = type === 'in' 
                ? itemLedger.filter(entry => entry.change > 0)
                : itemLedger.filter(entry => entry.change < 0);
        
            let displayCount = parseInt(container.dataset.displayCount || '5');
        
            if (filteredData.length === 0) {
                container.innerHTML = `<p class="empty-ledger">‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</p>`;
                loadMoreBtn.style.display = 'none';
                return;
            }
        
            const toDisplay = filteredData.slice(0, displayCount);
        
            toDisplay.forEach(entry => {
                const description = createLedgerDescription(entry);
                const changeClass = entry.change > 0 ? 'ledger-in' : 'ledger-out';
                
                let urgentIndicator = '';
                if (entry.isUrgent && type === 'out') {
                    urgentIndicator = `
                        <button onclick="clearUrgentFlag('${entry.id}')" 
                                style="background: var(--warning-color); color: var(--dark-text); border: none; border-radius: 5px; padding: 3px 8px; font-size: 10px; cursor: pointer; font-weight: bold; margin-left: 8px;">
                            ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞
                        </button>`;
                }
        
                const entryDiv = document.createElement('div');
                entryDiv.className = 'ledger-entry';
                if (entry.isUrgent) {
                    entryDiv.style.background = 'var(--level-low-bg)';
                }
        
                entryDiv.innerHTML = `
                    <span class="ledger-desc">${description} ${entry.isUrgent ? '<b>(‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ)</b>' : ''}</span>
                    <div style="display: flex; align-items: center;">
                        <span class="ledger-qty ${changeClass}">${entry.change > 0 ? '+' : ''}${toBengaliNumber(entry.change)}</span>
                        ${urgentIndicator}
                    </div>
                `;
        
                let pressTimer;
                entryDiv.addEventListener('mousedown', (e) => {
                    if (e.button !== 0) return; 
                    pressTimer = window.setTimeout(() => {
                        deleteLedgerEntry(entry.id);
                    }, 1000);
                });
        
                entryDiv.addEventListener('mouseup', () => {
                    clearTimeout(pressTimer);
                });
        
                entryDiv.addEventListener('mouseleave', () => {
                    clearTimeout(pressTimer);
                });
                
                entryDiv.addEventListener('touchstart', (e) => {
                     pressTimer = window.setTimeout(() => {
                        e.preventDefault();
                        deleteLedgerEntry(entry.id);
                    }, 1000);
                }, { passive: false });
        
                entryDiv.addEventListener('touchend', () => {
                    clearTimeout(pressTimer);
                });
        
                entryDiv.addEventListener('touchmove', () => {
                    clearTimeout(pressTimer);
                });
        
                container.appendChild(entryDiv);
            });
        
            if (filteredData.length > displayCount) {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.onclick = () => {
                    container.dataset.displayCount = displayCount + 5;
                    renderLedger(type);
                };
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }

        async function deleteLedgerEntry(ledgerId) {
            const entryIndex = ledger.findIndex(e => e.id === ledgerId);
            if (entryIndex === -1) return;
        
            const entry = ledger[entryIndex];
            const item = allItems.find(i => i.id === entry.itemId);
            if (!item) return;
        
            const confirmation = confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?\n\n‡¶¨‡¶ø‡¶¨‡¶∞‡¶£: ${createLedgerDescription(entry)}\n‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£: ${entry.change > 0 ? '+' : ''}${toBengaliNumber(entry.change)}`);
            if (!confirmation) {
                showToast('‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
                return;
            }
        
            const pinVerified = await requestPinAndExecute();
            if (!pinVerified) {
                showToast('‡¶™‡¶ø‡¶® ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü‡•§');
                return;
            }
        
            const dbPath = getDbPath();
            if (navigator.onLine && dbPath) {
                try {
                    const batch = db.batch();
                    const itemRef = dbPath.collection('items').doc(item.id);
                    const ledgerRef = dbPath.collection('ledger').doc(ledgerId);
        
                    const newQuantity = item.quantity - entry.change;
        
                    batch.update(itemRef, { quantity: newQuantity });
                    batch.delete(ledgerRef);
        
                    await batch.commit();
                    
                    showToast('‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
                    
                    const localItem = allItems.find(i => i.id === item.id);
                    if(localItem) localItem.quantity = newQuantity;
                    
                    ledger = ledger.filter(l => l.id !== ledgerId);
        
                    const currentTab = document.querySelector('.ledger-tab.active').id.includes('out') ? 'out' : 'in';
                    renderLedger(currentTab);
                    renderInventoryPage();
                    updateSlidingNotifications();
        
                } catch (error) {
                    console.error("Error deleting ledger entry from Firestore:", error);
                    showToast('‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error');
                    return; 
                }
            } else {
                item.quantity -= entry.change;
                ledger.splice(entryIndex, 1);
        
                localStorage.setItem('items', JSON.stringify(allItems));
                localStorage.setItem('ledger', JSON.stringify(ledger));
                
                showToast('‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá (‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®)‡•§');
                
                const currentTab = document.querySelector('.ledger-tab.active').id.includes('out') ? 'out' : 'in';
                renderLedger(currentTab);
                renderInventoryPage();
                updateSlidingNotifications();
            }
        }

        function clearUrgentFlag(ledgerId) {
            if (!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶è‡¶á ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßÅ‡¶á‡¶ú‡¶ø‡¶∂‡¶® ‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá?")) return;
        
            const dbPath = getDbPath();
            if (!dbPath) return showToast('‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§', 'error');
        
            const ledgerRef = dbPath.collection('ledger').doc(ledgerId);
        
            ledgerRef.update({ isUrgent: false })
                .then(() => {
                    showToast('‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
                    const currentTab = document.querySelector('.ledger-tab.active').id.includes('in') ? 'in' : 'out';
                    renderLedger(currentTab);
                })
                .catch(error => {
                    showToast('‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡¶ü‡¶ø ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error');
                });
        }
        
        function showLedgerTab(type) {
            // ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶¨‡¶æ‡¶ü‡¶®‡¶ó‡ßÅ‡¶≤‡ßã‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü
            document.getElementById('ledger-in-tab').classList.toggle('active', type === 'in');
            document.getElementById('ledger-out-tab').classList.toggle('active', type === 'out');
        
            // ‡¶°‡¶ø‡¶∏‡¶™‡ßç‡¶≤‡ßá ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
            document.getElementById('ledger-container').dataset.displayCount = '5';
        
            // ‡¶∏‡¶†‡¶ø‡¶ï ‡¶°‡ßá‡¶ü‡¶æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶≤‡ßá‡¶ú‡¶æ‡¶∞ ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
            renderLedger(type);
        }
                
        // --- Data Manipulation ---
        async function editItemName() {
            const dbPath = getDbPath();
            if (!dbPath) return showToast('‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§', 'error');
        
            const item = allItems.find(i => i.id === activeItemId);
            if (!item) return;
        
            const pinVerified = await requestPinAndExecute();
            if (!pinVerified) return;
        
            const newName = prompt(`'${item.name}' ‡¶è‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®:`, item.name);
        
            if (!newName || newName.trim() === '' || newName.trim() === item.name) {
                return;
            }
        
            const trimmedNewName = newName.trim();
        
            dbPath.collection('items').doc(activeItemId)
                .update({ name: trimmedNewName })
                .then(() => {
                    closeModal('itemDetailsModal');
                    showToast('‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
                    
                    const localItem = allItems.find(i => i.id === activeItemId);
                    if (localItem) {
                        localItem.name = trimmedNewName;
                    }
                    itemToHighlight = activeItemId;
                    renderInventoryPage();
                })
                .catch(error => {
                    showToast('‡¶®‡¶æ‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error');
                });
        }

        async function moveItem() {
            const item = allItems.find(i => i.id === activeItemId);
            if (!item) return;
        
            const moveModal = document.getElementById('move-item-modal');
            const dropdown = document.getElementById('section-select-dropdown');
            const confirmBtn = document.getElementById('move-item-confirm-btn');
            const cancelBtn = document.getElementById('move-item-cancel-btn');
        
            const sectionOptions = sections
                .map(s => `<option value="${s.name}" ${s.name === item.section ? 'selected' : ''}>${s.name}</option>`)
                .join('');
            dropdown.innerHTML = sectionOptions;
            
            document.getElementById('move-item-prompt-text').innerHTML = `‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø <strong>'${item.name}'</strong> ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ü‡¶ø‡¶ï‡ßá <strong>'${item.section}'</strong> ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶æ‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`;
        
            openModal('move-item-modal');
        
            const handleConfirm = async () => {
                const newSectionName = dropdown.value;
        
                if (newSectionName === item.section) {
                    closeModal('move-item-modal');
                    cleanup();
                    return;
                }
        
                const pinVerified = await requestPinAndExecute();
                if (!pinVerified) {
                    cleanup();
                    return;
                }
        
                const localItem = allItems.find(i => i.id === activeItemId);
                if (localItem) {
                    localItem.section = newSectionName;
                }
                localStorage.setItem('items', JSON.stringify(allItems));
        
                showToast(`‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ü‡¶ø '${newSectionName}' ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá ‡¶∏‡¶∞‡¶æ‡¶®‡ßã ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
                closeModal('itemDetailsModal');
                closeModal('move-item-modal');
                renderInventoryPage();
                cleanup();
        
                const dbPath = getDbPath();
                if (navigator.onLine && dbPath) {
                    try {
                        await dbPath.collection('items').doc(activeItemId).update({ section: newSectionName });
                    } catch (error) {
                        console.error("Firestore move item sync error:", error);
                        showToast('‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶°‡ßá ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'warning');
                    }
                }
            };
        
            const handleCancel = () => {
                closeModal('move-item-modal');
                cleanup();
            };
        
            const cleanup = () => {
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };
        
            confirmBtn.addEventListener('click', handleConfirm, { once: true });
            cancelBtn.addEventListener('click', handleCancel, { once: true });
        }

        function deleteItem() {
            const item = allItems.find(i => i.id === activeItemId);
            if (!item) return;
        
            const modal = document.getElementById('customConfirmModal');
            const title = document.getElementById('custom-confirm-title');
            const message = document.getElementById('custom-confirm-message');
            const option1Btn = document.getElementById('confirm-option-1');
            const option2Btn = document.getElementById('confirm-option-2');
        
            title.textContent = `'${item.name}'`;
            message.textContent = '‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶¨‡¶æ ‡¶è‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡¶™‡¶∂‡¶® ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®‡•§';
            
            option1Btn.onclick = async () => {
                closeModal('customConfirmModal');
                const pinVerified = await requestPinAndExecute();
                if (!pinVerified) {
                    if (pinVerified === false) showToast('‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
                    else showToast('‡¶™‡¶ø‡¶® ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü‡•§');
                    return;
                }
        
                if (!confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá '${item.name}' ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶è‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶á ‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶´‡ßá‡¶∞‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§`)) return;
        
                const dbPath = getDbPath();
                if (dbPath && navigator.onLine) {
                    try {
                        const batch = db.batch();
                        const itemRef = dbPath.collection('items').doc(activeItemId);
                        batch.delete(itemRef);
        
                        const ledgerSnapshot = await dbPath.collection('ledger').where('itemId', '==', activeItemId).get();
                        ledgerSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                        
                        await batch.commit();
                    } catch (error) {
                        showToast('‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error');
                        return;
                    }
                }
        
                ledger = ledger.filter(entry => entry.itemId !== activeItemId);
                localStorage.setItem('ledger', JSON.stringify(ledger));
        
                allItems = allItems.filter(i => i.id !== activeItemId);
                localStorage.setItem('items', JSON.stringify(allItems));
        
                closeModal('itemDetailsModal');
                showToast('‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶è‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
                renderInventoryPage();
                updateSlidingNotifications();
            };
        
            option2Btn.onclick = async () => {
                closeModal('customConfirmModal');
                const pinVerified = await requestPinAndExecute();
                if (!pinVerified) {
                    if (pinVerified === false) showToast('‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
                    else showToast('‡¶™‡¶ø‡¶® ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü‡•§');
                    return;
                }
        
                if (!confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá '${item.name}' ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶∞ ‡¶´‡¶≤‡ßá ‡¶∏‡ßç‡¶ü‡¶ï ‡ß¶ ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ü‡¶ø ‡¶•‡¶æ‡¶ï‡¶¨‡ßá‡•§`)) return;
        
                const dbPath = getDbPath();
                if (dbPath && navigator.onLine) {
                    try {
                        const batch = db.batch();
                        const itemRef = dbPath.collection('items').doc(activeItemId);
                        batch.update(itemRef, { quantity: 0 });
        
                        const ledgerSnapshot = await dbPath.collection('ledger').where('itemId', '==', activeItemId).get();
                        ledgerSnapshot.docs.forEach(doc => batch.delete(doc.ref));
        
                        await batch.commit();
                    } catch (error) {
                        showToast('‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error');
                        return;
                    }
                }
        
                const originalLedgerCount = ledger.length;
                ledger = ledger.filter(entry => entry.itemId !== activeItemId);
                const deletedLedgerCount = originalLedgerCount - ledger.length;
                localStorage.setItem('ledger', JSON.stringify(ledger));
        
                const currentItem = allItems.find(i => i.id === activeItemId);
                if (currentItem) {
                    currentItem.quantity = 0;
                    localStorage.setItem('items', JSON.stringify(allItems));
                }
                
                showToast(`‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®! ${toBengaliNumber(deletedLedgerCount)} ‡¶ü‡¶ø ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßç‡¶ü‡¶ï ‡ß¶ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
                renderLedger(document.querySelector('.ledger-tab.active').id.includes('out') ? 'out' : 'in');
                renderInventoryPage();
            };
        
            modal.style.display = 'flex';
        }

        async function editStock(itemId, itemName, currentStock) {
            const dbPath = getDbPath();
            if (!dbPath) return showToast('‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§', 'error');
        
            const pinVerified = await requestPinAndExecute();
            if (!pinVerified) return;
        
            const item = allItems.find(i => i.id === itemId);
            let inputStep = 'any';
            let requiresInteger = false;
        
            if (item) {
                const unitValue = item.unit.toLowerCase().trim();
                const integerUnits = [
                    'pcs', 'pc', 'pice', 'pce', '‡¶™‡¶ø‡¶∏', '‡¶ü‡¶ø', 
                    'set', '‡¶∏‡ßá‡¶ü', 
                    'box', '‡¶¨‡¶ï‡ßç‡¶∏', 
                    'packet', '‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ü', 
                    'dozen', 'dzn', '‡¶°‡¶ú‡¶®', 
                    'pair', '‡¶ú‡ßã‡ßú‡¶æ',
                    'roll', '‡¶∞‡ßã‡¶≤',
                    'ÿπÿØÿØ'
                ];
                if (integerUnits.includes(unitValue)) {
                    inputStep = '1';
                    requiresInteger = true;
                }
            }
        
            const newStockStr = await showCustomPrompt({
                title: "‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü",
                message: `'${itemName}' ‡¶è‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶¶‡¶ø‡¶®:`,
                defaultValue: currentStock,
                step: inputStep
            });
        
            if (newStockStr === null) return;
            
            const newStock = parseFloat(newStockStr);
            
            if (isNaN(newStock) || newStock < 0) {
                return showToast('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶¶‡¶ø‡¶®‡•§', 'error');
            }
        
            if (requiresInteger && newStock % 1 !== 0) {
                return showToast(`'${item.unit}' ‡¶á‡¶â‡¶®‡¶ø‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ (‡¶Ø‡ßá‡¶Æ‡¶®: ‡ßß, ‡ß®, ‡ß©) ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§`, 'error');
            }
        
            const finalStock = requiresInteger ? Math.round(newStock) : newStock;
        
            const itemRef = dbPath.collection('items').doc(itemId);
            const change = finalStock - currentStock;
        
            const batch = db.batch();
            batch.update(itemRef, { quantity: finalStock });
            const ledgerRef = dbPath.collection('ledger').doc();
            batch.set(ledgerRef, {
                itemId: itemId,
                itemName: itemName,
                change: change,
                person: '‡¶∏‡¶Ç‡¶∂‡ßã‡¶ß‡¶®',
                date: new Date().toISOString()
            });
        
            batch.commit().then(() => showToast('‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§'))
                .catch(error => showToast('‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error'));
        }

        async function editSectionName(sectionId, oldName) {
            const pinVerified = await requestPinAndExecute();
            if (!pinVerified) return;
        
            const newName = prompt(`'${oldName}' ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®:`, oldName);
            if (!newName || newName.trim() === '' || newName.trim() === oldName) {
                return;
            }
        
            const newSectionName = newName.trim();
        
            const sectionToUpdate = sections.find(s => s.id === sectionId);
            if (sectionToUpdate) {
                sectionToUpdate.name = newSectionName;
            }
        
            allItems.forEach(item => {
                if (item.section === oldName) {
                    item.section = newSectionName;
                }
            });
        
            localStorage.setItem('sections', JSON.stringify(sections));
            localStorage.setItem('items', JSON.stringify(allItems));
        
            showToast('‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
            renderInventoryPage();
        
            const dbPath = getDbPath();
            if (navigator.onLine && dbPath) {
                try {
                    const batch = db.batch();
                    const sectionRef = dbPath.collection('sections').doc(sectionId);
                    batch.update(sectionRef, { name: newSectionName });
        
                    const itemsQuery = dbPath.collection('items').where("section", "==", oldName);
                    const itemsSnapshot = await itemsQuery.get();
                    
                    itemsSnapshot.docs.forEach(doc => {
                        batch.update(doc.ref, { section: newSectionName });
                    });
        
                    await batch.commit();
                } catch (error) {
                    console.error("Firestore section name sync error:", error);
                    showToast('‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶°‡ßá ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'warning');
                }
            }
        }
        
        function addNewUser(event) {
            event.preventDefault();
            const nameInput = document.getElementById('new-user-name');
            const name = nameInput.value.trim();
            if (!name) return;
        
            const localUsers = JSON.parse(localStorage.getItem('app_users') || '[]');
        
            if (localUsers.some(u => u.name.toLowerCase() === name.toLowerCase())) {
                showToast('‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶∞‡ßü‡ßá‡¶õ‡ßá‡•§', 'error');
                return;
            }
        
            const newUser = {
                id: `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                name: name
            };
        
            localUsers.push(newUser);
            localStorage.setItem('app_users', JSON.stringify(localUsers));
            users = localUsers;
        
            nameInput.value = '';
            showToast('‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
            renderUsersPage();
            nameInput.focus();
        
            const dbPath = getDbPath();
            if (navigator.onLine && dbPath) {
                dbPath.collection('app_users').doc(newUser.id).set({ name: newUser.name }).catch(error => {
                    console.error("Firebase user sync error:", error);
                });
            }
        }
        function deleteUser(userId) {
            const dbPath = getDbPath();
            if (!dbPath) return showToast('‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§', 'error');
        
            const executeDelete = async () => {
                const pinVerified = await requestPinAndExecute();
                if (!pinVerified) return;
        
                if (!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶á ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶ï‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) return;
                
                dbPath.collection('app_users').doc(userId).delete()
                    .then(() => showToast('‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§'))
                    .catch(error => showToast('‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error'));
            };
            executeDelete();
        }

        async function deleteSection(sectionId) {
            const section = sections.find(s => s.id === sectionId);
            if (!section) return;
        
            const pinVerified = await requestPinAndExecute();
            if (!pinVerified) return;
        
            const confirmation = confirm(`'${section.name}' ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá ‡¶è‡¶∞ ‡¶Ö‡¶ß‡ßÄ‡¶®‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∏‡ßç‡¶•‡¶æ‡ßü‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?`);
            if (!confirmation) return;
        
            const itemIdsToDelete = allItems
                .filter(item => item.section === section.name)
                .map(item => item.id);
        
            allItems = allItems.filter(item => !itemIdsToDelete.includes(item.id));
            ledger = ledger.filter(entry => !itemIdsToDelete.includes(entry.itemId));
            sections = sections.filter(s => s.id !== sectionId);
        
            localStorage.setItem('items', JSON.stringify(allItems));
            localStorage.setItem('ledger', JSON.stringify(ledger));
            localStorage.setItem('sections', JSON.stringify(sections));
        
            showToast('‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡¶ø‡¶§ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
            renderInventoryPage();
            updateSlidingNotifications();
        
            const dbPath = getDbPath();
            if (navigator.onLine && dbPath) {
                try {
                    const batch = db.batch();
                    
                    const itemsQuery = dbPath.collection('items').where('section', '==', section.name);
                    const itemsSnapshot = await itemsQuery.get();
                    
                    if (itemsSnapshot.empty) {
                        await dbPath.collection('sections').doc(sectionId).delete();
                        return;
                    }
        
                    const onlineItemIdsToDelete = itemsSnapshot.docs.map(doc => doc.id);
        
                    itemsSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
        
                    if (onlineItemIdsToDelete.length > 0) {
                        const ledgerQuery = dbPath.collection('ledger').where('itemId', 'in', onlineItemIdsToDelete);
                        const ledgerSnapshot = await ledgerQuery.get();
                        ledgerSnapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                    }
        
                    batch.delete(dbPath.collection('sections').doc(sectionId));
        
                    await batch.commit();
        
                } catch (error) {
                    console.error("Error deleting section from Firestore:", error);
                    showToast('‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error');
                }
            }
        }

        function addFormRow() {
            const formsContainer = document.getElementById('multiItemFormsContainer');
            const allForms = formsContainer.getElementsByClassName('item-form-card');
            let lastSelectedSection = '';
        
            if (allForms.length > 0) {
                const lastForm = allForms[allForms.length - 1];
                const lastSelect = lastForm.querySelector('.item-section');
                if (lastSelect) {
                    lastSelectedSection = lastSelect.value;
                }
            }
        
            const formCard = document.createElement('div');
            formCard.className = 'item-form-card';
        
            const sortedSections = [...sections].sort((a, b) => a.name.localeCompare(b.name));
            
            const sectionOptions = `<option value="" disabled selected>-- ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>` + 
                sortedSections.map(s => {
                    const isSelected = (s.name === lastSelectedSection && lastSelectedSection !== '');
                    return `<option value="${s.name}" ${isSelected ? 'selected' : ''}>${s.name}</option>`;
                }).join('');
        
            formCard.innerHTML = `
                <button class="remove-form-btn" onclick="this.parentElement.remove(); updateSaveButtonState();">√ó</button>
                <input type="text" class="item-name" autocomplete="off" placeholder="‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" required>
                <select class="item-section">${sectionOptions}</select>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <input type="number" class="item-quantity" autocomplete="off" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£" min="0" step="any">
                    <input type="text" class="item-unit" autocomplete="off" placeholder="‡¶è‡¶ï‡¶ï (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶ï‡ßá‡¶ú‡¶ø, ‡¶™‡¶ø‡¶∏)" value="‡¶™‡¶ø‡¶∏" oninput="updateQuantityStep(this)" required>
                </div>
            `;
            formsContainer.appendChild(formCard);
            updateSaveButtonState();
            formCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            formCard.querySelector('.item-name').focus();
        }

        function toggleNewSectionForm() {
            const container = document.getElementById('newSectionContainer');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
        }

        function addNewSection() {
            const sectionNameInput = document.getElementById('newSectionName');
            const sectionName = sectionNameInput.value.trim();
            if (!sectionName) {
                showToast('‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®‡•§', 'error');
                return;
            }
        
            const localSections = JSON.parse(localStorage.getItem('sections') || '[]');
        
            if (localSections.some(s => s.name.toLowerCase() === sectionName.toLowerCase())) {
                showToast('‡¶è‡¶á ‡¶®‡¶æ‡¶Æ‡ßá ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶õ‡ßá‡•§', 'error');
                return;
            }
        
            const newSection = {
                id: `sec_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                name: sectionName
            };
        
            localSections.push(newSection);
            localStorage.setItem('sections', JSON.stringify(localSections));
            sections = localSections;
        
            sectionNameInput.value = '';
            toggleNewSectionForm();
            showToast('‡¶®‡¶§‡ßÅ‡¶® ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
            updateAllSectionDropdowns();
            itemToHighlight = newSection.id;
            renderInventoryPage();
        
            const dbPath = getDbPath();
            if (navigator.onLine && dbPath) {
                dbPath.collection('sections').doc(newSection.id).set({ name: newSection.name }).catch(error => {
                    console.error("Firebase section sync error:", error);
                });
            }
        }

        function updateAllSectionDropdowns() {
            const allDropdowns = document.querySelectorAll('#multiItemFormsContainer .item-section');
            const newOptionsHTML = sections.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            
            allDropdowns.forEach(dropdown => {
                const selectedValue = dropdown.value; // ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
                dropdown.innerHTML = newOptionsHTML;
                dropdown.value = selectedValue; // ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá (‡¶Ø‡¶¶‡¶ø ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶π‡ßü)
            });
        }

        function saveAllItems() {
            const formCards = document.querySelectorAll('#multiItemFormsContainer .item-form-card');
            if (formCards.length === 0) {
                showToast("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶´‡¶∞‡ßç‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§", 'error');
                return;
            }
        
            const localData = {
                items: JSON.parse(localStorage.getItem('items') || '[]'),
                ledger: JSON.parse(localStorage.getItem('ledger') || '[]')
            };
        
            let itemsAddedCount = 0;
            let errorOccurred = false;
            const itemsToSync = [];
            const ledgerToSync = [];
        
            formCards.forEach(card => {
                if (errorOccurred) return;
        
                const name = card.querySelector('.item-name').value.trim();
                const section = card.querySelector('.item-section').value;
                const quantityStr = card.querySelector('.item-quantity').value;
                const quantity = parseFloat(quantityStr) || 0;
                const unit = card.querySelector('.item-unit').value.trim() || '‡¶™‡¶ø‡¶∏';
        
                if (!name || !section || quantity < 0) {
                    showToast('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶¶‡¶ø‡¶®‡•§', 'error');
                    errorOccurred = true;
                    return;
                }
        
                let existingItem = localData.items.find(i => i.name.toLowerCase() === name.toLowerCase() && i.section === section);
                let targetItemId;
                let isNewItem = false;
        
                if (existingItem) {
                    if (existingItem.unit.toLowerCase() !== unit.toLowerCase()) {
                        showToast(`'${name}' ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ü‡¶ø '${existingItem.unit}' ‡¶è‡¶ï‡¶ï‡ßá ‡¶∞‡ßü‡ßá‡¶õ‡ßá‡•§`, 'error');
                        errorOccurred = true;
                        return;
                    }
                    existingItem.quantity += quantity;
                    targetItemId = existingItem.id;
                    itemsToSync.push({ item: existingItem, isNew: false });
                } else {
                    isNewItem = true;
                    targetItemId = `item_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    const newItem = { id: targetItemId, name, section, quantity, unit };
                    localData.items.push(newItem);
                    itemsToSync.push({ item: newItem, isNew: true });
                }
        
                if (quantity > 0) {
                    const ledgerEntry = {
                        id: `ledger_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        itemId: targetItemId,
                        itemName: name,
                        change: quantity,
                        person: isNewItem ? '‡¶®‡¶§‡ßÅ‡¶® ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ' : '‡¶∏‡ßç‡¶ü‡¶ï ‡¶á‡¶®',
                        date: new Date().toISOString()
                    };
                    localData.ledger.push(ledgerEntry);
                    ledgerToSync.push(ledgerEntry);
                }
                itemsAddedCount++;
            });
        
            if (errorOccurred) return;
        
            if (itemsAddedCount > 0) {
                localStorage.setItem('items', JSON.stringify(localData.items));
                localStorage.setItem('ledger', JSON.stringify(localData.ledger));
                allItems = localData.items;
                ledger = localData.ledger;
        
                document.getElementById('multiItemFormsContainer').innerHTML = '';
                closeModal('itemAddModal');
                showToast(`${toBengaliNumber(itemsAddedCount)}‡¶ü‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠/‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
                if (itemsToSync.length === 1) {
                    itemToHighlight = itemsToSync[0].item.id;
                }                
                renderInventoryPage();
                updateSlidingNotifications();
        
                const dbPath = getDbPath();
                if (navigator.onLine && dbPath) {
                    const batch = db.batch();
                    itemsToSync.forEach(syncInfo => {
                        const itemRef = dbPath.collection('items').doc(syncInfo.item.id);
                        if (syncInfo.isNew) {
                            batch.set(itemRef, syncInfo.item);
                        } else {
                            batch.update(itemRef, { quantity: syncInfo.item.quantity });
                        }
                    });
                    ledgerToSync.forEach(entry => {
                        const ledgerRef = dbPath.collection('ledger').doc(entry.id);
                        batch.set(ledgerRef, entry);
                    });
                    batch.commit().catch(error => console.error("Firebase item save sync error:", error));
                }
            }
        }

        function openProvideItemModal() {
            if (sections.length === 0) return showToast('‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
            if (users.length === 0) return showToast('‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡¶ú‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
        
            const userSelect = document.getElementById('pi-user-main');
            const sortedUsers = [...users].sort((a, b) => a.name.localeCompare(b.name));
            userSelect.innerHTML = `<option value="" disabled selected>-- ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ --</option>${sortedUsers.map(u => `<option value="${u.name}">${u.name}</option>`).join('')}`;
            
            document.getElementById('provide-items-container').innerHTML = '';
            const urgentCheckbox = document.getElementById('pi-is-urgent-main');
            urgentCheckbox.checked = false;
            toggleRequisitionIdField(false); 
        
            addProvideItemForm();
            openModal('provideItemModal');
        
            const modal = document.getElementById('provideItemModal');
            modal.classList.add('modal-expanded');
            modal.classList.remove('modal-compact');
        
            const firstSearchInput = document.querySelector('#provide-items-container .custom-search-input');
            if (firstSearchInput) {
                setTimeout(() => {
                    firstSearchInput.focus();
                    filterItems(firstSearchInput, true);
                }, 100); 
            }
        }

        function addProvideItemForm() {
            const container = document.getElementById('provide-items-container');
            const formId = `provide-form-${Date.now()}`;
        
            const formCard = document.createElement('div');
            formCard.className = 'item-form-card';
            formCard.id = formId;
            formCard.innerHTML = `
                <button class="remove-form-btn" onclick="this.parentElement.remove(); updateProvideButtonState();">√ó</button>
                <div class="custom-search-container">
                    <input type="text" class="custom-search-input" autocomplete="off" placeholder="‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." onkeyup="filterItems(this)" onfocus="filterItems(this, true)">
                    <div class="custom-search-results"></div>
                </div>
                <input type="hidden" class="selected-item-id">
                <input type="number" class="pi-quantity-dynamic" autocomplete="off" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£" min="0" step="any" required oninput="validateStockOnInput(this)">
            `;
            container.appendChild(formCard);
            updateProvideButtonState();
            
            const newInput = formCard.querySelector('.custom-search-input');
            newInput.focus();
        
            setTimeout(() => {
                filterItems(newInput, true);
            }, 0);
        
            const modal = document.getElementById('provideItemModal');
            modal.classList.add('modal-expanded');
            modal.classList.remove('modal-compact');
        }

        function validateStockOnInput(quantityInput) {
            const formCard = quantityInput.closest('.item-form-card');
            const itemId = formCard.querySelector('.selected-item-id').value;
            const enteredQuantity = parseFloat(quantityInput.value);
        
            if (!itemId || isNaN(enteredQuantity) || enteredQuantity <= 0) {
                return;
            }
        
            const item = allItems.find(i => i.id === itemId);
        
            if (item && enteredQuantity > item.quantity) {
                if (navigator.vibrate) {
                    navigator.vibrate(100);
                }
                
                showToast(`‡¶Ö‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶∏‡ßç‡¶ü‡¶ï! ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ${toBengaliNumber(item.quantity)} ${item.unit} ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá‡•§`, 'error');
                
                quantityInput.value = '';
                quantityInput.focus();
            }
        }

        function updateProvideButtonState() {
            const container = document.getElementById('provide-items-container');
            const formCount = container.getElementsByClassName('item-form-card').length;
            const button = document.getElementById('execute-provide-all-btn');
        
            if (formCount > 1) {
                button.textContent = '‡¶∏‡¶¨ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';
            } else {
                button.textContent = '‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®';
            }
        }

        async function executeProvideAllItems() {
            const personName = document.getElementById('pi-user-main').value;
            const isUrgent = document.getElementById('pi-is-urgent-main').checked;
            const requisitionValue = document.getElementById('pi-requisition-id').value.trim();
            const formCards = document.querySelectorAll('#provide-items-container .item-form-card');
        
            if (!personName) {
                return showToast('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ú‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
            }
            if (!isUrgent && !requisitionValue) {
                return showToast('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∞‡¶ø‡¶ï‡ßÅ‡¶á‡¶ú‡¶ø‡¶∂‡¶® ‡¶∏‡ßç‡¶≤‡¶ø‡¶™ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®‡•§', 'error');
            }
            if (formCards.length === 0) {
                return showToast('‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
            }
        
            const itemsToProvide = [];
            for (const card of formCards) {
                const itemId = card.querySelector('.selected-item-id').value;
                const quantityStr = card.querySelector('.pi-quantity-dynamic').value;
                const quantity = parseFloat(quantityStr);
                const itemName = card.querySelector('.custom-search-input').value;
        
                if (!itemId || isNaN(quantity) || quantity <= 0) {
                    return showToast('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶¨ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
                }
                itemsToProvide.push({ itemId, quantity, itemName });
            }
        
            if (!navigator.onLine) {
                return showToast('‡¶è‡¶á ‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡•§', 'error');
            }
        
            showToast('‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...', 'warning');
        
            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error("‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶®‡ßá‡¶á‡•§");
                }
        
                const dbId = ADMIN_UIDS.includes(user.uid) ? CENTRAL_DB_ID : user.uid;
                const mainDocRef = db.collection('inventories').doc(dbId);
                const requisitionIdAsNumber = isUrgent ? null : parseInt(requisitionValue, 10);
        
                if (!isUrgent && isNaN(requisitionIdAsNumber)) {
                    return showToast('‡¶∞‡¶ø‡¶ï‡ßÅ‡¶á‡¶ú‡¶ø‡¶∂‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§', 'error');
                }
        
                if (!isUrgent) {
                    const ledgerQuery = await mainDocRef.collection('ledger').where('requisitionId', '==', requisitionIdAsNumber).get();
                    if (!ledgerQuery.empty) {
                        throw new Error(`‡¶∞‡¶ø‡¶ï‡ßÅ‡¶á‡¶ú‡¶ø‡¶∂‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ '${requisitionValue}' ‡¶á‡¶§‡ßã‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
                    }
                }
        
                await db.runTransaction(async (transaction) => {
                    for (const itemData of itemsToProvide) {
                        const itemRef = mainDocRef.collection('items').doc(itemData.itemId);
                        const itemSnapshot = await transaction.get(itemRef);
        
                        if (!itemSnapshot.exists) {
                            throw new Error(`'${itemData.itemName}' ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ü‡¶ø ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§`);
                        }
        
                        const currentStock = itemSnapshot.data().quantity;
                        if (currentStock < itemData.quantity) {
                            throw new Error(`'${itemData.itemName}' ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶Ö‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶∏‡ßç‡¶ü‡¶ï!`);
                        }
        
                        const newStock = currentStock - itemData.quantity;
                        transaction.update(itemRef, { quantity: newStock });
        
                        const ledgerRef = mainDocRef.collection('ledger').doc();
                        const ledgerEntry = {
                            id: ledgerRef.id,
                            itemId: itemData.itemId,
                            itemName: itemData.itemName,
                            change: -itemData.quantity,
                            person: personName,
                            date: new Date().toISOString(),
                            isUrgent: isUrgent,
                            requisitionId: requisitionIdAsNumber
                        };
                        transaction.set(ledgerRef, ledgerEntry);
                    }
                });
        
                showToast(`${toBengaliNumber(itemsToProvide.length)}‡¶ü‡¶ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
                closeModal('provideItemModal');
        
            } catch (error) {
                console.error("Operation failed:", error);
                showToast(error.message || '‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
            }
        }

        // --- Toast Notification ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'error' : ''}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        // --- Sliding Notification ---
        async function updateSlidingNotifications() {
            await loadRules();
        
            const getUrgencyScore = (item) => {
                const lowerItemName = item.name.toLowerCase();
                const customRule = stockLevelRules.find(rule => lowerItemName.includes(rule.keyword));
                const levels = customRule ? customRule.levels : (stockLevels[item.unit] || stockLevels['default']);
                
                if (item.quantity <= 0) {
                    return 1000;
                }
                if (item.quantity <= levels.critical) {
                    return 500 + (levels.critical - item.quantity);
                }
                if (item.quantity <= levels.veryLow) {
                    return 200 + (levels.veryLow - item.quantity);
                }
                if (item.quantity <= levels.low) {
                    return 100 + (levels.low - item.quantity);
                }
                return 0;
            };
        
            const urgentItems = allItems
                .map(item => ({ ...item, urgency: getUrgencyScore(item) }))
                .filter(item => item.urgency > 0)
                .sort((a, b) => b.urgency - a.urgency);
        
            const bar = document.getElementById('slidingNotificationBar');
            const slidingTextEl = document.getElementById('slidingText');
        
            if (urgentItems.length > 0) {
                let htmlContent = '';
                urgentItems.forEach((item, index) => {
                    const separator = index > 0 ? ' <span style="color: #ffffff4d; margin: 0 8px;">|</span> ' : '';
                    let stockInfo = '';
                    let itemClass = '';
        
                    if (item.quantity <= 0) {
                        stockInfo = ' (‡¶∏‡ßç‡¶ü‡¶ï ‡¶®‡ßá‡¶á)';
                        itemClass = 'critical-item';
                    } else {
                        stockInfo = ` (${toBengaliNumber(item.quantity)})`;
                        if (item.urgency >= 500) itemClass = 'critical-item';
                        else if (item.urgency >= 200) itemClass = 'very-low-item';
                        else itemClass = 'low-item';
                    }
                    
                    htmlContent += `${separator}<span class="urgent-item-link ${itemClass}" data-item-id="${item.id}">${item.name}${stockInfo}</span>`;
                });
        
                slidingTextEl.innerHTML = htmlContent;
        
                const totalLength = slidingTextEl.textContent.length;
                const charactersPerSecond = 15;
                const duration = Math.max(15, totalLength / charactersPerSecond);
                slidingTextEl.style.animationDuration = `${duration.toFixed(2)}s`;
        
                const hasCritical = urgentItems.some(item => item.urgency >= 500);
                if (hasCritical) {
                    bar.style.backgroundColor = 'var(--level-critical-bg)';
                    bar.style.color = 'var(--light-text)';
                } else {
                    bar.style.backgroundColor = 'var(--warning-color)';
                    bar.style.color = 'var(--dark-text)';
                }
        
                bar.classList.add('show');
                const paddingValue = Math.max(0, bar.offsetHeight);
                document.body.style.paddingBottom = paddingValue + 'px';
        
                slidingTextEl.querySelectorAll('.urgent-item-link').forEach(link => {
                    link.style.cursor = 'pointer';
                    link.style.textDecoration = 'underline';
                    link.onclick = (e) => {
                        e.stopPropagation();
                        const itemId = link.dataset.itemId;
                        openItemDetailsModal(itemId);
                        
                        itemToHighlight = itemId;
                        renderInventoryPage();
                    };
                });
        
            } else {
                bar.classList.remove('show');
                document.body.style.paddingBottom = '0';
                slidingTextEl.style.animationDuration = '0s';
            }
        }

        async function openDownloadModal() {
            tempRequisitionData = JSON.parse(localStorage.getItem('tempRequisition') || '{}');          
            const dbPath = getDbPath();
            if (navigator.onLine && dbPath) {
                try {
                    const doc = await dbPath.collection('app_state').doc('temp_requisition').get();
                    if (doc.exists) {
                        const firestoreData = doc.data();
                        localStorage.setItem('tempRequisition', JSON.stringify(firestoreData));
                    }
                } catch (error) {
                    console.error("Error fetching temp requisition from Firestore:", error);
                }
            }
        
            const container = document.getElementById('requisition-items-container');
            const monthNames = ["‡¶ú‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶∞‡¶ø", "‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡ßü‡¶æ‡¶∞‡¶ø", "‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", "‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤", "‡¶Æ‡ßá", "‡¶ú‡ßÅ‡¶®", "‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á", "‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü", "‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞", "‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞", "‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞", "‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞"];
            const month = monthNames[new Date().getMonth()];
            const year = toBengaliNumber(new Date().getFullYear());
            document.getElementById('requisition-modal-title').textContent = `${month} ${year} ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶ö‡¶æ‡¶π‡¶ø‡¶¶‡¶æ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü`;
        
            let searchBarHTML = `
                <div style="padding: 10px 15px; background-color: #fff; border-bottom: 1px solid #e0e0e0;">
                    <input type="text" id="requisition-search-input" autocomplete="off" onkeyup="filterRequisitionItems()" placeholder="üîç ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." style="width: 100%; padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;">
                </div>
            `;
        
            let tableHTML = `<div class="table-container" style="max-height: 60vh;"><table style="font-size: 12px; width: 100%;">
                                <thead>
                                    <tr>
                                        <th style="width: 8%; text-align: center; padding: 8px 2px;">‡¶®‡¶Ç</th>
                                        <th style="width: 57%; padding-left: 2px;">‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ (‡¶∏‡ßç‡¶ü‡¶ï)</th>
                                        <th style="width: 20%; text-align: center;">‡¶ö‡¶æ‡¶π‡¶ø‡¶¶‡¶æ</th>
                                        <th style="width: 15%; text-align: center; padding: 8px 2px;">‡¶¨‡¶æ‡¶¶</th>
                                    </tr>
                                </thead>
                                <tbody>`;
        
            const excludedItems = tempRequisitionData.excluded || [];
            let itemCounter = 0;
        
            const sortedSections = sortSections(sections, '');
            
            sortedSections.forEach(section => {
                const sortFunction = masterSortFunction(section.name);
                let sectionItems = allItems.filter(item => item.section === section.name);
                
                const customItemOrder = itemOrders[section.name] || [];
                if (customItemOrder.length > 0) {
                    sectionItems.sort((a, b) => {
                        const indexA = customItemOrder.indexOf(a.id);
                        const indexB = customItemOrder.indexOf(b.id);
                        if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                        if (indexA !== -1) return -1;
                        if (indexB !== -1) return 1;
                        return sortFunction(a, b);
                    });
                } else {
                    sectionItems.sort(sortFunction);
                }
                if (sectionItems.length > 0) {
                    tableHTML += `
                        <tr>
                            <td colspan="4" style="background-color: #f1f3f5; font-weight: bold; padding: 8px 10px;">
                                ${section.name}
                            </td>
                        </tr>
                    `;
        
                    sectionItems.forEach(item => {
                        itemCounter++;
                        const stockInfo = `${toBengaliNumber(item.quantity)} ${item.unit || '‡¶™‡¶ø‡¶∏'}`;
                        const savedReq = tempRequisitionData[item.id] || '';
                        const isExcluded = excludedItems.includes(item.id);
                        const rowClass = isExcluded ? 'item-excluded' : '';
                        const itemNameStyle = (item.name.length > 25) ? 'font-size: 11px;' : '';
        
                        tableHTML += `
                            <tr data-item-id="${item.id}" class="${rowClass}">
                                <td style="text-align: center; padding: 8px 2px; vertical-align: middle;">${toBengaliNumber(itemCounter)}</td>
                                <td style="padding-left: 2px; vertical-align: middle; ${itemNameStyle}">${item.name} <strong style="color: #0056b3;">(${stockInfo})</strong></td>
                                <td style="text-align: center; vertical-align: middle;">
                                    <input 
                                        type="number" 
                                        class="req-quantity-input" 
                                        value="${savedReq}"
                                        oninput="saveTempRequisition('${item.id}', this.value)"
                                        onkeydown="handleRequisitionEnter(event, this)"
                                        placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£" 
                                        min="0" 
                                        style="padding: 6px; font-size: 12px; width: 50px; text-align: center; border-radius: 6px; border: 1px solid #ccc;">
                                </td>
                                <td style="text-align: center; vertical-align: middle; padding: 8px 2px;">
                                    <button onclick="toggleExcludeItem(this, '${item.id}')" style="background: none; border: none; cursor: pointer; font-size: 16px; padding: 0 5px; color: var(--danger-color);">
                                        ${isExcluded ? 'üîÑ' : '‚ùå'}
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                }
            });
        
            tableHTML += `</tbody></table></div>`;
            container.innerHTML = searchBarHTML + tableHTML;
            openModal('requisitionInputModal');
        }

        function filterRequisitionItems() {
            const searchTerm = document.getElementById('requisition-search-input').value.toLowerCase();
            const rows = document.querySelectorAll('#requisition-items-container tbody tr');
            let visibleItemCounter = 0;
        
            rows.forEach(row => {
                const sectionHeader = row.querySelector('td[colspan="4"]');
                if (sectionHeader) {
                    row.style.display = '';
                    return;
                }
        
                const itemName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const matches = itemName.includes(searchTerm);
                row.style.display = matches ? '' : 'none';
        
                if (matches) {
                    visibleItemCounter++;
                    row.querySelector('td:first-child').textContent = toBengaliNumber(visibleItemCounter);
                }
            });
        
            const sections = document.querySelectorAll('#requisition-items-container tbody tr td[colspan="4"]');
            sections.forEach(sectionCell => {
                let nextRow = sectionCell.parentElement.nextElementSibling;
                let hasVisibleItems = false;
                while (nextRow && !nextRow.querySelector('td[colspan="4"]')) {
                    if (nextRow.style.display !== 'none') {
                        hasVisibleItems = true;
                        break;
                    }
                    nextRow = nextRow.nextElementSibling;
                }
                sectionCell.parentElement.style.display = hasVisibleItems ? '' : 'none';
            });
        }

        function showUserReport(userId) {
          const user = users.find(u => u.id === userId);
          if (!user) return;
      
          const userLedger = ledger.filter(l => l.person === user.name && l.change < 0)
                                   .sort((a, b) => new Date(b.date) - new Date(a.date));
      
          const reportTitle = document.getElementById('user-report-title');
          reportTitle.textContent = `${user.name} ‡¶è‡¶∞ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü`;
      
          const clearAllBtn = document.getElementById('clear-user-report-btn');
          clearAllBtn.onclick = () => clearAllUserTransactions(userId);
      
          const reportBody = document.getElementById('user-report-body');
          if (userLedger.length === 0) {
              reportBody.innerHTML = '<p style="text-align: center; padding: 20px 0;">‡¶è‡¶á ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶ï‡¶∞‡ßá‡¶®‡¶ø‡•§</p>';
              clearAllBtn.style.display = 'none';
          } else {
              clearAllBtn.style.display = 'inline-block';
              let tableHTML = '<div class="table-container"><table><thead><tr><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ</th><th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</th></tr></thead><tbody>';
              userLedger.forEach(entry => {
                  const item = allItems.find(i => i.id === entry.itemId);
                  const unit = item ? (item.unit || '‡¶™‡¶ø‡¶∏') : '‡¶™‡¶ø‡¶∏';
                  
                  tableHTML += `
                      <tr class="user-report-row" data-ledger-id="${entry.id}" style="cursor: pointer;">
                          <td>${new Date(entry.date).toLocaleDateString('bn-BD')}</td>
                          <td>${entry.itemName}</td>
                          <td>${toBengaliNumber(Math.abs(entry.change))} ${unit}</td>
                      </tr>
                  `;
              });
              tableHTML += '</tbody></table></div>';
              reportBody.innerHTML = tableHTML;
      
              const rows = reportBody.querySelectorAll('.user-report-row');
              rows.forEach(row => {
                  let pressTimer;
                  const ledgerId = row.getAttribute('data-ledger-id');
      
                  const startPress = (e) => {
                      pressTimer = setTimeout(() => {
                          e.preventDefault();
                          e.stopPropagation();
                          deleteSingleUserTransaction(ledgerId, userId);
                      }, 1000);
                  };
      
                  const cancelPress = () => {
                      clearTimeout(pressTimer);
                  };
      
                  row.addEventListener('mousedown', startPress);
                  row.addEventListener('touchstart', startPress, { passive: false });
                  
                  row.addEventListener('mouseup', cancelPress);
                  row.addEventListener('mouseleave', cancelPress);
                  row.addEventListener('touchend', cancelPress);
                  row.addEventListener('touchmove', cancelPress);
              });
          }
          openModal('userReportModal');
      }

        async function clearAllUserTransactions(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
        
            const pinVerified = await requestPinAndExecute();
            if (!pinVerified) return showToast('‡¶™‡¶ø‡¶® ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü‡•§');
        
            if (!confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá '${user.name}'-‡¶è‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶∞ ‡¶´‡¶≤‡ßá ‡¶∏‡¶ï‡¶≤ ‡¶∏‡¶Ç‡¶∂‡ßç‡¶≤‡¶ø‡¶∑‡ßç‡¶ü ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§`)) return;
        
            const userTransactions = ledger.filter(l => l.person === user.name && l.change < 0);
            if (userTransactions.length === 0) return showToast('‡¶Æ‡ßã‡¶õ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶®‡ßá‡¶á‡•§');
        
            const transactionIdsToDelete = userTransactions.map(t => t.id);
            
            userTransactions.forEach(entry => {
                const item = allItems.find(i => i.id === entry.itemId);
                if (item) {
                    item.quantity -= entry.change;
                }
            });
        
            ledger = ledger.filter(l => !transactionIdsToDelete.includes(l.id));
        
            localStorage.setItem('items', JSON.stringify(allItems));
            localStorage.setItem('ledger', JSON.stringify(ledger));
        
            const dbPath = getDbPath();
            if (dbPath) {
                const batch = db.batch();
                transactionIdsToDelete.forEach(id => {
                    batch.delete(dbPath.collection('ledger').doc(id));
                });
                userTransactions.forEach(entry => {
                    const item = allItems.find(i => i.id === entry.itemId);
                    if (item) {
                        batch.update(dbPath.collection('items').doc(item.id), { quantity: item.quantity });
                    }
                });
                await batch.commit();
            }
        
            showToast(`'${user.name}'-‡¶è‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`);
            showUserReport(userId);
            renderInventoryPage();
        }

        async function deleteSingleUserTransaction(ledgerId, userId) {
            const entryIndex = ledger.findIndex(e => e.id === ledgerId);
            if (entryIndex === -1) return;
        
            const entry = ledger[entryIndex];
            const item = allItems.find(i => i.id === entry.itemId);
            if (!item) return;
        
            const pinVerified = await requestPinAndExecute();
            if (!pinVerified) return showToast('‡¶™‡¶ø‡¶® ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü‡•§');
        
            if (!confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?\n\n‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ: ${entry.itemName}\n‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£: ${toBengaliNumber(Math.abs(entry.change))}`)) return;
        
            item.quantity -= entry.change;
            ledger.splice(entryIndex, 1);
        
            localStorage.setItem('items', JSON.stringify(allItems));
            localStorage.setItem('ledger', JSON.stringify(ledger));
        
            const dbPath = getDbPath();
            if (dbPath) {
                const batch = db.batch();
                batch.delete(dbPath.collection('ledger').doc(ledgerId));
                batch.update(dbPath.collection('items').doc(item.id), { quantity: item.quantity });
                await batch.commit();
            }
        
            showToast('‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
            showUserReport(userId);
            renderInventoryPage();
        }

        function saveTempRequisition(itemId, quantity) {
            if (quantity !== null && quantity !== "") {
                tempRequisitionData[itemId] = quantity;
            } else {
                delete tempRequisitionData[itemId];
            }
        
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                localStorage.setItem('tempRequisition', JSON.stringify(tempRequisitionData));
                
                const dbPath = getDbPath();
                if (navigator.onLine && dbPath) {
                    const reqRef = dbPath.collection('app_state').doc('temp_requisition');
                    
                    const dataToSync = {};
                    dataToSync[itemId] = quantity !== null && quantity !== "" ? quantity : firebase.firestore.FieldValue.delete();
                    
                    reqRef.set(dataToSync, { merge: true });
                }
            }, 500);
        }

        function handleRequisitionEnter(event, currentInput) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const allInputs = Array.from(document.querySelectorAll('#requisition-items-container .req-quantity-input'));
                const currentIndex = allInputs.indexOf(currentInput);
        
                if (currentIndex > -1) {
                    for (let i = currentIndex + 1; i < allInputs.length; i++) {
                        const nextInput = allInputs[i];
                        if (nextInput.offsetParent !== null) {
                            nextInput.focus();
                            nextInput.select();
                            return;
                        }
                    }
                }
            }
        }

        function generateRequisitionReport(reportToRegenerate = null) {
            const isRegenerating = !!reportToRegenerate;
            const executeReport = async () => {
                if (!isRegenerating) {
                    const pinVerified = await requestPinAndExecute();
                    if (!pinVerified) return;
                }
                const filterByQuantity = document.getElementById('filter-by-quantity-toggle').checked;
                const unitMap = {
                    '‡¶™‡¶ø‡¶∏': 'Pcs', '‡¶ü‡¶ø': 'Pcs', '‡¶ï‡¶Ø‡¶º‡ßá‡¶≤': 'Coil', '‡¶ï‡ßá‡¶ú‡¶ø': 'Kg', '‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ': 'g',
                    '‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ü': 'Packet', '‡¶¨‡¶ï‡ßç‡¶∏': 'Box', '‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞': 'Mtr', '‡¶°‡¶ú‡¶®': 'Dzn', '‡¶≤‡¶ø‡¶ü‡¶æ‡¶∞': 'Ltr',
                    '‡¶∏‡ßá‡¶ü': 'Set',
                    '‡¶∞‡ßã‡¶≤': 'Roll',
                    '‡¶´‡¶ø‡¶ü': 'Feet'
                };
        
                let reportMonth, reportYear, reportItems;
        
                if (isRegenerating) {
                    reportMonth = reportToRegenerate.month;
                    reportYear = reportToRegenerate.year;
                    reportItems = reportToRegenerate.items;
                    if (filterByQuantity) {
                        reportItems = reportItems.filter(item => item.reqQnt && parseInt(item.reqQnt, 10) > 0);
                    }
                } else {
                    const now = new Date();
                    reportMonth = now.getMonth();
                    reportYear = now.getFullYear();
                    reportItems = [];
                    const tempRequisition = JSON.parse(localStorage.getItem('tempRequisition') || '{}');
                    const excludedItems = tempRequisition.excluded || [];
                    const sortedSections = sortSections(sections, '');
                    
                    sortedSections.forEach(section => {
                        const sortFunction = masterSortFunction(section.name);
                        const sectionItems = allItems
                            .filter(item => item.section === section.name && !excludedItems.includes(item.id))
                            .sort(sortFunction);
                        
                        let filteredSectionItems = sectionItems;
                        if (filterByQuantity) {
                            filteredSectionItems = sectionItems.filter(item => {
                                const reqQnt = tempRequisition[item.id];
                                return reqQnt && parseInt(reqQnt, 10) > 0;
                            });
                        }
                        
                        if (filteredSectionItems.length > 0) {
                            filteredSectionItems.forEach((item, itemIndex) => {
                                const reqQnt = tempRequisition[item.id] ? parseInt(tempRequisition[item.id], 10) : '';
                                reportItems.push({
                                    id: item.id, name: item.name, stock: item.quantity || 0,
                                    unit: item.unit || '‡¶™‡¶ø‡¶∏', reqQnt: reqQnt,
                                    isLastInSection: itemIndex === filteredSectionItems.length - 1
                                });
                            });
                        }
                    });
                }
        
                if (reportItems.length === 0) {
                    showToast('‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ (‡¶ö‡¶æ‡¶π‡¶ø‡¶¶‡¶æ ‡¶∏‡¶π) ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§', 'warning');
                    return;
                }
        
                let itemCounter = 0;
                const body = reportItems.map(item => {
                    itemCounter++;
                    const unit = unitMap[item.unit.toLowerCase()] || item.unit;
                    return {
                        no: itemCounter, name: item.name, stock: item.stock,
                        unit: unit, reqQnt: item.reqQnt, remarks: '',
                        isLastInSection: item.isLastInSection
                    };
                });
        
                const reportFormat = document.getElementById('final-report-format').value;
                const monthNames = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
                const monthStr = monthNames[reportMonth];
                const companyName = "Golden Refit Garments Ltd";
                const title = `Electrical Material Stock & Requisition For ${monthStr} ${reportYear}`;
                const fileName = `Stock_Requisition_${monthStr}_${reportYear}`;
        
                const headers = ['No.', 'Item Description', 'Stock Qnt.', 'Unit', 'Req. Qnt.', 'Remarks'];
                const bodyData = body.map(item => [item.no, item.name, item.stock, item.unit, item.reqQnt, item.remarks]);
        
                if (reportFormat === 'excel') {
                    const footerData = [
                        [],
                        [],
                        ['Store', 'Utility Department', 'DGM (HR, Admin & Compliance)', 'COO']
                    ];
                
                    const excelData = [
                        [companyName],
                        [title],
                        [],
                        headers,
                        ...bodyData,
                        ...footerData
                    ];
                
                    const worksheet = XLSX.utils.aoa_to_sheet(excelData);
                
                    const columnWidths = [
                        { wch: 5 },
                        { wch: 60 },
                        { wch: 12 },
                        { wch: 10 },
                        { wch: 12 },
                        { wch: 20 }
                    ];
                    worksheet['!cols'] = columnWidths;
                
                    if (!worksheet['!merges']) worksheet['!merges'] = [];
                    worksheet['!merges'].push(
                        { s: { r: 0, c: 0 }, e: { r: 0, c: 5 } },
                        { s: { r: 1, c: 0 }, e: { r: 1, c: 5 } }
                    );
                
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Requisition");
                    XLSX.writeFile(workbook, `${fileName}.xlsx`);
                } else if (reportFormat === 'pdf') {
                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                        const pageWidth = doc.internal.pageSize.getWidth();
                        const pageHeight = doc.internal.pageSize.getHeight();
        
                        let tableConfig;
                        const itemCount = reportItems.length;
        
                        if (itemCount <= 45) {
                            tableConfig = {
                                styles: { fontSize: 8.5, cellPadding: 1.5 },
                                headStyles: { fontSize: 8.5, cellPadding: 1.5 },
                                margin: { top: 20, bottom: 25 }
                            };
                        } else if (itemCount <= 55) {
                            tableConfig = {
                                styles: { fontSize: 7.5, cellPadding: 1.1 },
                                headStyles: { fontSize: 7.5, cellPadding: 1.1 },
                                margin: { top: 18, bottom: 22 }
                            };
                        } else { // 56 or more items
                            tableConfig = {
                                styles: { fontSize: 7.2, cellPadding: 0.8 },
                                headStyles: { fontSize: 7.2, cellPadding: 1.0 },
                                margin: { top: 18, bottom: 22 }
                            };
                        }
                        
                        tableConfig.styles = { ...tableConfig.styles, halign: 'center', valign: 'middle' };
                        tableConfig.headStyles = { ...tableConfig.headStyles, fillColor: [220, 220, 220], textColor: 0, fontStyle: 'bold' };
                        tableConfig.columnStyles = {
                            0: { cellWidth: 8 }, 1: { cellWidth: 82, halign: 'left' },
                            2: { cellWidth: 18 }, 3: { cellWidth: 12 },
                            4: { cellWidth: 18 }, 5: { cellWidth: 'auto', halign: 'left' }
                        };
        
                        doc.autoTable({
                            head: [headers],
                            body: bodyData,
                            theme: 'grid',
                            ...tableConfig,
                            didDrawCell: function (data) {
                                const originalItem = body.find(item => item.no === data.cell.raw[0]);
                                if (originalItem && originalItem.isLastInSection && data.column.index === data.table.columns.length - 1) {
                                    doc.setLineWidth(0.5);
                                    doc.line(data.table.margins.left, data.cell.y + data.cell.height, data.table.width + data.table.margins.left, data.cell.y + data.cell.height);
                                }
                            },
                            didDrawPage: function (data) {
                                doc.setFontSize(14);
                                doc.setFont(undefined, 'bold');
                                doc.text(companyName, pageWidth / 2, 10, { align: 'center' });
                                doc.setFontSize(11);
                                doc.setFont(undefined, 'normal');
                                doc.text(title, pageWidth / 2, 15, { align: 'center' });
        
                                const footerY = pageHeight - 15;
                                const signatureY = footerY + 4;
                                const colWidth = pageWidth / 4;
                                doc.setFontSize(8);
                                doc.setTextColor(0);
        
                                doc.text('-------------------------', colWidth * 0.5, footerY, { align: 'center' });
                                doc.text('Store', colWidth * 0.5, signatureY, { align: 'center' });
                                doc.text('-------------------------', colWidth * 1.5, footerY, { align: 'center' });
                                doc.text('Utility Department', colWidth * 1.5, signatureY, { align: 'center' });
                                doc.text('-------------------------', colWidth * 2.5, footerY, { align: 'center' });
                                doc.text('DGM (HR, Admin & Compliance)', colWidth * 2.5, signatureY, { align: 'center' });
                                doc.text('-------------------------', colWidth * 3.5, footerY, { align: 'center' });
                                doc.text('COO', colWidth * 3.5, signatureY, { align: 'center' });
        
                                doc.setFontSize(8);
                                doc.setTextColor(100);
                                const text = `Page ${data.pageNumber} of ${doc.internal.getNumberOfPages()}`;
                                doc.text(text, pageWidth - 15, pageHeight - 5, { align: 'right' });
                            }
                        });
        
                        doc.save(`${fileName}.pdf`);
                    } catch (e) {
                        console.error("PDF generation failed:", e);
                        showToast("PDF ‡¶§‡ßà‡¶∞‡¶ø‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§", "error");
                    }
                }
        
                if (!isRegenerating) {
                    const dbPath = getDbPath();
                    const newReport = {
                        id: `rep_${Date.now()}`,
                        month: reportMonth,
                        year: reportYear,
                        items: reportItems
                    };
                    const localArchived = JSON.parse(localStorage.getItem('archivedReports') || '[]');
                    const existingReportIndex = localArchived.findIndex(r => r.month === reportMonth && r.year === reportYear);
                    if (existingReportIndex > -1) {
                        localArchived[existingReportIndex] = newReport;
                    } else {
                        localArchived.push(newReport);
                    }
                    localStorage.setItem('archivedReports', JSON.stringify(localArchived));
                    archivedReports = localArchived;
        
                    if (navigator.onLine && dbPath) {
                        dbPath.collection('archivedReports').doc(newReport.id).set(newReport).catch(err => console.error(err));
                    }
        
                    closeModal('requisitionInputModal');
                    showToast('‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ì ‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
                    renderArchivedReports();
                }
            };
        
            executeReport();
        }
        function clearRequisitionInputs() {
            if (!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶∏‡¶ï‡¶≤ ‡¶ö‡¶æ‡¶π‡¶ø‡¶¶‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) return;
        
            tempRequisitionData = {};
            localStorage.removeItem('tempRequisition');
        
            const dbPath = getDbPath();
            if (navigator.onLine && dbPath) {
                dbPath.collection('app_state').doc('temp_requisition').set({})
                    .then(() => {
                        showToast('‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶° ‡¶•‡ßá‡¶ï‡ßá ‡¶ö‡¶æ‡¶π‡¶ø‡¶¶‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
                    })
                    .catch(err => console.error("Error clearing temp requisition from cloud:", err));
            }
        
            const inputs = document.querySelectorAll('#requisition-items-container .req-quantity-input');
            inputs.forEach(input => input.value = '');
        
            showToast('‡¶∏‡¶ï‡¶≤ ‡¶ö‡¶æ‡¶π‡¶ø‡¶¶‡¶æ‡¶∞ ‡¶ò‡¶∞ ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
        }

        function renderArchivedReports() {
            const container = document.getElementById('archived-reports-list');
            container.innerHTML = '';
            if (archivedReports.length === 0) {
                container.innerHTML = '<p>‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§</p>';
                return;
            }
        
            const sortedArchives = [...archivedReports].sort((a, b) => new Date(b.year, b.month) - new Date(a.year, a.month));
            const monthNames = ["‡¶ú‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶∞‡¶ø", "‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡ßü‡¶æ‡¶∞‡¶ø", "‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", "‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤", "‡¶Æ‡ßá", "‡¶ú‡ßÅ‡¶®", "‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á", "‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü", "‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞", "‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞", "‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞", "‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞"];
        
            sortedArchives.forEach(report => {
                const reportDiv = document.createElement('div');
                reportDiv.className = 'ledger-entry';
                reportDiv.innerHTML = `
                    <span class="ledger-desc" style="font-weight: bold; cursor: pointer;" onclick="loadArchivedRequisition('${report.id}')">${monthNames[report.month]} ${toBengaliNumber(report.year)}</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <button onclick="regenerateArchivedReport('${report.id}', 'pdf')" style="padding: 5px 10px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 5px;">PDF</button>
                        <button onclick="regenerateArchivedReport('${report.id}', 'excel')" style="padding: 5px 10px; font-size: 12px; background: #28a745; color: white; border: none; border-radius: 5px;">Excel</button>
                        <button onclick="deleteArchivedReport('${report.id}')" class="delete-btn" style="font-size: 18px; color: var(--danger-color);">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(reportDiv);
            });
        }
        
        function toggleCardBody(headerElement) {
            const card = headerElement.closest('.card');
            const cardBody = card.querySelector('.card-body.collapsible');
            const icon = headerElement.querySelector('.toggle-icon');
        
            if (cardBody && icon) {
                cardBody.classList.toggle('collapsed');
                icon.classList.toggle('collapsed');
            }
        }

        function regenerateArchivedReport(reportId, format) {
            const report = archivedReports.find(r => r.id === reportId);
            if (report) {
                document.getElementById('final-report-format').value = format;
                generateRequisitionReport(report);
            } else {
                showToast('‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§', 'error');
            }
        }

        function loadArchivedRequisition(reportId) {
            const report = archivedReports.find(r => r.id === reportId);
            if (!report || !report.items) {
                showToast('‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¨‡¶æ ‡¶è‡¶∞ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§', 'error');
                return;
            }
        
            if (!confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø '${new Date(report.year, report.month).toLocaleString('bn-BD', { month: 'long', year: 'numeric' })}' ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶ö‡¶æ‡¶π‡¶ø‡¶¶‡¶æ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶∞ ‡¶´‡¶≤‡ßá ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶∏‡ßá‡¶≠ ‡¶•‡¶æ‡¶ï‡¶æ ‡¶ö‡¶æ‡¶π‡¶ø‡¶¶‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§`)) {
                return;
            }
        
            const newRequisitionData = {};
            report.items.forEach(item => {
                if (item.reqQnt !== '' && item.reqQnt !== null && typeof item.reqQnt !== 'undefined') {
                    newRequisitionData[item.id] = item.reqQnt;
                }
            });
        
            tempRequisitionData = newRequisitionData;
            localStorage.setItem('tempRequisition', JSON.stringify(tempRequisitionData));
        
            const dbPath = getDbPath();
            if (navigator.onLine && dbPath) {
                dbPath.collection('app_state').doc('temp_requisition').set(tempRequisitionData)
                    .catch(err => console.error("Error syncing loaded requisition to cloud:", err));
            }
        
            showToast('‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶ö‡¶æ‡¶π‡¶ø‡¶¶‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
            
            openDownloadModal();
        }

        function deleteArchivedReport(reportId) {
            const report = archivedReports.find(r => r.id === reportId);
            if (!report) return;
        
            const executeDelete = async () => {
                const pinVerified = await requestPinAndExecute();
                if (!pinVerified) return;
        
                const monthNames = ["‡¶ú‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶∞‡¶ø", "‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡ßü‡¶æ‡¶∞‡¶ø", "‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", "‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤", "‡¶Æ‡ßá", "‡¶ú‡ßÅ‡¶®", "‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á", "‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü", "‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞", "‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞", "‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞", "‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞"];
                const reportName = `${monthNames[report.month]} ${toBengaliNumber(report.year)}`;
        
                if (confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø '${reportName}' ‡¶Æ‡¶æ‡¶∏‡ßá‡¶∞ ‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`)) {
                    archivedReports = archivedReports.filter(r => r.id !== reportId);
                    localStorage.setItem('archivedReports', JSON.stringify(archivedReports));
        
                    const dbPath = getDbPath();
                    if (navigator.onLine && dbPath) {
                        dbPath.collection('archivedReports').doc(reportId).delete().catch(err => console.error("Error deleting from Firestore:", err));
                    }
        
                    renderArchivedReports();
                    showToast('‡¶Ü‡¶∞‡ßç‡¶ï‡¶æ‡¶á‡¶≠ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
                }
            };
            
            executeDelete();
        }

        function toggleAuthView(event) {
            event.preventDefault();
            const loginView = document.getElementById('login-view');
            const registerView = document.getElementById('register-view');
            
            if (loginView.style.display === 'none') {
                loginView.style.display = 'block';
                registerView.style.display = 'none';
            } else {
                loginView.style.display = 'none';
                registerView.style.display = 'block';
            }
        }
        function openManualModal() {
            openModal('manualModal');
        }
      
        function showApp() {
            document.documentElement.style.overflow = '';
            document.body.style.overflow = '';
            document.getElementById('auth-modal-overlay').style.display = 'none';
            document.getElementById('main-app-wrapper').style.filter = 'none';
            document.getElementById('main-app-wrapper').style.pointerEvents = 'auto';
        
            sections = JSON.parse(localStorage.getItem('sections') || '[]');
            allItems = JSON.parse(localStorage.getItem('items') || '[]');
            users = JSON.parse(localStorage.getItem('app_users') || '[]');
            ledger = JSON.parse(localStorage.getItem('ledger') || '[]');
            archivedReports = JSON.parse(localStorage.getItem('archivedReports') || '[]');
            
            sectionOrder = JSON.parse(localStorage.getItem('sectionOrder') || '[]');
            itemOrders = JSON.parse(localStorage.getItem('itemOrders') || '{}');
        
            renderInventoryPage();
            initializeSortableList();
            populateItemSortSectionDropdown();      
            renderUsersPage();
            renderArchivedReports();
            updateSlidingNotifications();
        
            if (auth.currentUser && navigator.onLine) {
                listenForLiveUpdates();
            }
        }
        
        function showLogin() {
            document.documentElement.style.overflow = 'hidden';
            document.body.style.overflow = 'hidden';
            document.getElementById('auth-modal-overlay').style.display = 'flex';
            document.getElementById('main-app-wrapper').style.filter = 'blur(5px)';
            document.getElementById('main-app-wrapper').style.pointerEvents = 'none';
        
            detachListeners();
        
            allItems = [];
            sections = [];
            users = [];
            ledger = [];
            archivedReports = [];
        
            renderInventoryPage();
            renderUsersPage();
            renderArchivedReports();
            updateSlidingNotifications();
        }

        function showAuthMessage(view, message, isError = false) {
            const messageEl = document.getElementById(`${view}-status-message`);
            if (!messageEl) return;
        
            messageEl.textContent = message;
            messageEl.style.color = isError ? 'var(--danger-color)' : 'var(--success-color)';
        }
        
        function registerUser(event) {
            event.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const registerBtn = event.target.querySelector('button[type="submit"]');
        
            registerBtn.disabled = true;
            showAuthMessage('register', '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
        
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    showAuthMessage('register', '‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶´‡¶≤! ‡¶è‡¶ñ‡¶® ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', false);
                    setTimeout(() => {
                        toggleAuthView(event); 
                        registerBtn.disabled = false;
                        showAuthMessage('register', '');
                        showAuthMessage('login', '‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡•§', false);
                    }, 2000);
                })
                .catch((error) => {
                    let message = '‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶ò‡¶ü‡ßá‡¶õ‡ßá‡•§';
                    if (error.code === 'auth/email-already-in-use') {
                        message = '‡¶è‡¶á ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡ßü‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶õ‡ßá‡•§';
                    } else if (error.code === 'auth/invalid-email') {
                        message = '‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡¶®‡•§';
                    } else if (error.code === 'auth/weak-password') {
                        message = '‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°‡¶ü‡¶ø ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§';
                    }
                    showAuthMessage('register', message, true);
                    registerBtn.disabled = false;
                });
        }
        
        function loginUser(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginBtn = event.target.querySelector('button[type="submit"]');
        
            loginBtn.disabled = true;
            showAuthMessage('login', '‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
        
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                })
                .catch((error) => {
                    let message = '‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶ò‡¶ü‡ßá‡¶õ‡ßá‡•§';
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        message = '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶™‡¶æ‡¶∏‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü‡•§';
                    }
                    showAuthMessage('login', message, true);
                    loginBtn.disabled = false;
                });
        }
        
        function handleAuthClose() {
            const hasLocalData = (localStorage.getItem('sections') || '[]').length > 2;
        
            if (hasLocalData) {
                showToast('‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ñ‡¶® ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶Ü‡¶õ‡ßá‡¶®‡•§', 'warning');
                showApp();
            } else {
                showAuthMessage('login', '‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶®‡ßá‡¶á, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', true);
            }
        }
        function requestPinAndExecute() {
            const pinModal = document.getElementById('pin-prompt-modal');
            const pinInput = document.getElementById('pin-input');
            const pinErrorMsg = document.getElementById('pin-error-msg');
            const pinCloseBtn = document.getElementById('pin-close-btn');
        
            openModal('pin-prompt-modal');
            pinInput.value = '';
            pinErrorMsg.textContent = '';
            pinInput.focus();
        
            return new Promise((resolve) => {
                let isProcessing = false;
        
                const handleValidation = () => {
                    if (isProcessing) return;
                    isProcessing = true;
        
                    if (pinInput.value === SECURITY_PIN) {
                        pinErrorMsg.textContent = '';
                        setTimeout(() => {
                            closeModal('pin-prompt-modal');
                            cleanup();
                            resolve(true);
                        }, 100);
                    } else {
                        pinErrorMsg.textContent = '‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶ø‡¶®!';
                        pinInput.classList.add('shake-error');
                        
                        setTimeout(() => {
                            pinInput.classList.remove('shake-error');
                            pinInput.value = '';
                            pinInput.focus();
                            isProcessing = false;
                        }, 500);
                    }
                };
        
                const handleInput = (event) => {
                    pinErrorMsg.textContent = '';
                    if (event.target.value.length === 4) {
                        handleValidation();
                    }
                };
        
                const handleCancel = () => {
                    closeModal('pin-prompt-modal');
                    cleanup();
                    resolve(false);
                };
        
                const cleanup = () => {
                    pinInput.removeEventListener('input', handleInput);
                    pinCloseBtn.removeEventListener('click', handleCancel);
                };
        
                pinInput.addEventListener('input', handleInput);
                pinCloseBtn.addEventListener('click', handleCancel);
            });
        }

        window.addEventListener('offline', () => {
            const authModal = document.getElementById('auth-modal-overlay');
            if (authModal.style.display === 'flex') {
                showToast('‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡¶ø‡¶ö‡ßç‡¶õ‡¶ø‡¶®‡ßç‡¶®‡•§ ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶õ‡ßá‡¶®‡•§', 'warning');
                showApp();
            }
        });
        
        window.addEventListener('online', () => {
            if (!auth.currentUser) {
                showToast('‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶´‡¶ø‡¶∞‡ßá ‡¶è‡¶∏‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
                showLogin();
            }
        });
        let importedFileContent = null;
        
        function closeImportDialog() {
            document.getElementById('import-option-dialog').classList.remove('show');
            importedFileContent = null;
        }
        
        function openResetDialogs() {
            document.getElementById('reset-confirm-dialog-1').classList.add('show');
        }
        
        function closeResetDialogs() {
            document.getElementById('reset-confirm-dialog-1').classList.remove('show');
            document.getElementById('reset-confirm-dialog-2').classList.remove('show');
        }
        
        function getAllDataAsObject() {
            return {
                version: "1.0",
                exportedAt: new Date().toISOString(),
                sections: JSON.parse(localStorage.getItem('sections') || '[]'),
                items: JSON.parse(localStorage.getItem('items') || '[]'),
                app_users: JSON.parse(localStorage.getItem('app_users') || '[]'),
                ledger: JSON.parse(localStorage.getItem('ledger') || '[]'),
                archivedReports: JSON.parse(localStorage.getItem('archivedReports') || '[]')
            };
        }
        
        function exportAllData() {
            const dataToExport = getAllDataAsObject();
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: "application/json;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `inventory_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast('‡¶°‡ßá‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§');
        }
        
        function importAllData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,application/json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = res => {
                    importedFileContent = res.target.result;
                    document.getElementById('import-option-dialog').classList.add('show');
                };
                reader.onerror = err => showToast('‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶™‡ßú‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error');
                reader.readAsText(file);
            };
            input.click();
        }

        async function processDataImport(isMerging) {
            if (!importedFileContent) return showToast('‡¶ï‡ßã‡¶®‡ßã ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡¶®‡¶ø‡•§', 'error');
            const pinVerified = await requestPinAndExecute();
            if (!pinVerified) {
                closeImportDialog();
                return;
            }            
            try {
                const backupData = JSON.parse(importedFileContent);
                if (!backupData || typeof backupData.sections === 'undefined' || typeof backupData.items === 'undefined') {
                    throw new Error('‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶®‡ßü‡•§');
                }
        
                if (isMerging) {
                    const currentSections = JSON.parse(localStorage.getItem('sections') || '[]');
                    const currentItems = JSON.parse(localStorage.getItem('items') || '[]');
                    const currentUsers = JSON.parse(localStorage.getItem('app_users') || '[]');
                    const currentLedger = JSON.parse(localStorage.getItem('ledger') || '[]');
                    const currentArchivedReports = JSON.parse(localStorage.getItem('archivedReports') || '[]');
        
                    backupData.sections.forEach(newSection => {
                        const sectionExists = currentSections.some(
                            existing => existing.name.trim().toLowerCase() === newSection.name.trim().toLowerCase()
                        );
                        if (!sectionExists) {
                            currentSections.push(newSection);
                        }
                    });
        
                    backupData.items.forEach(newItem => {
                        const itemExists = currentItems.some(
                            existing => existing.name.trim().toLowerCase() === newItem.name.trim().toLowerCase() &&
                                        existing.section.trim().toLowerCase() === newItem.section.trim().toLowerCase()
                        );
                        if (!itemExists) {
                            currentItems.push(newItem);
                        }
                    });
                    
                    const mergeById = (currentArray, newArray) => {
                        if (!newArray || !Array.isArray(newArray)) return currentArray;
                        newArray.forEach(newItem => {
                            if (newItem && typeof newItem.id !== 'undefined') {
                                const exists = currentArray.some(existing => existing.id === newItem.id);
                                if (!exists) {
                                    currentArray.push(newItem);
                                }
                            }
                        });
                        return currentArray;
                    };
        
                    const finalUsers = mergeById(currentUsers, backupData.app_users);
                    const finalLedger = mergeById(currentLedger, backupData.ledger);
                    const finalArchivedReports = mergeById(currentArchivedReports, backupData.archivedReports);
        
                    localStorage.setItem('sections', JSON.stringify(currentSections));
                    localStorage.setItem('items', JSON.stringify(currentItems));
                    localStorage.setItem('app_users', JSON.stringify(finalUsers));
                    localStorage.setItem('ledger', JSON.stringify(finalLedger));
                    localStorage.setItem('archivedReports', JSON.stringify(finalArchivedReports));
                    
                    showToast('‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ú ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
        
                } else {
                    if (!confirm('‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ! ‡¶è‡¶∞ ‡¶´‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡¶ï‡¶≤ ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶¶‡¶ø‡ßü‡ßá ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶ø‡¶§ ‡¶π‡¶¨‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§?')) {
                        closeImportDialog();
                        return;
                    }
                    localStorage.setItem('sections', JSON.stringify(backupData.sections || []));
                    localStorage.setItem('items', JSON.stringify(backupData.items || []));
                    localStorage.setItem('app_users', JSON.stringify(backupData.app_users || []));
                    localStorage.setItem('ledger', JSON.stringify(backupData.ledger || []));
                    localStorage.setItem('archivedReports', JSON.stringify(backupData.archivedReports || []));
                    showToast('‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡ßá‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
                }
        
                const dbPath = getDbPath();
                if (auth.currentUser && dbPath) {
                    showToast('‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶°‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...', 'warning');
                    const finalData = getAllDataAsObject();
                    const collections = ['sections', 'items', 'app_users', 'ledger', 'archivedReports'];
                    
                    const batch = db.batch();
                    collections.forEach(colName => {
                        if (finalData[colName]) {
                            finalData[colName].forEach(doc => {
                                if(doc.id) {
                                   batch.set(dbPath.collection(colName).doc(doc.id), doc);
                                }
                            });
                        }
                    });
                    await batch.commit();
                    showToast('‡¶ï‡ßç‡¶≤‡¶æ‡¶â‡¶° ‡¶∏‡¶ø‡¶ô‡ßç‡¶ï ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
                }
        
                closeImportDialog();
                showToast('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∞‡¶ø‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...', 'warning');
                setTimeout(() => window.location.reload(), 1500);
        
            } catch (error) {
                showToast(error.message, 'error');
                closeImportDialog();
            }
        }

        async function executeHardReset() {
            closeResetDialogs();
            const pinVerified = await requestPinAndExecute();
            if (!pinVerified) return;     
            showToast('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...', 'warning');
        
            const dbPath = getDbPath();
            if (auth.currentUser && dbPath) {
                const collections = ['sections', 'items', 'app_users', 'ledger', 'archivedReports'];
                const batch = db.batch();
                
                for (const colName of collections) {
                    const snapshot = await dbPath.collection(colName).get();
                    snapshot.docs.forEach(doc => batch.delete(doc.ref));
                }
                
                try {
                    await batch.commit();
                    showToast('‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'success');
                } catch (error) {
                    showToast('‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶°‡ßá‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§', 'error');
                }
            }
        
            localStorage.clear();
            showToast('‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü ‡¶π‡¶¨‡ßá‡•§', 'success');
            setTimeout(() => window.location.reload(), 1500);
        }

        function filterItems(input) {
            const searchTerm = input.value.toLowerCase();
            const resultsContainer = input.nextElementSibling;
            const formCard = input.closest('.item-form-card');
        
            resultsContainer.innerHTML = '';
        
            // ‡¶Ø‡¶¶‡¶ø ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶•‡¶æ‡¶ï‡ßá
            if (searchTerm.length === 0) {
                // sectionOrder ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∏‡¶æ‡¶ú‡¶ø‡ßü‡ßá ‡¶®‡¶ø‡¶®
                const sortedSections = [...sectionOrder];
                
                // ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
                sortedSections.forEach(sectionName => {
                    const itemsInSection = allItems.filter(item => item.section === sectionName);
                    
                    // ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ‡¶ó‡ßÅ‡¶≤‡ßã‡¶ï‡ßá ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶®‡¶ø‡¶ú‡¶∏‡ßç‡¶¨ ‡¶ï‡ßç‡¶∞‡¶Æ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶∏‡¶æ‡¶ú‡¶æ‡¶®
                    const customItemOrder = itemOrders[sectionName] || [];
                    const defaultSortFunc = masterSortFunction(sectionName);
                    if (customItemOrder.length > 0) {
                        itemsInSection.sort((a, b) => {
                            const indexA = customItemOrder.indexOf(a.id);
                            const indexB = customItemOrder.indexOf(b.id);
                            if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                            if (indexA !== -1) return -1;
                            if (indexB !== -1) return 1;
                            return defaultSortFunc(a, b);
                        });
                    } else {
                        itemsInSection.sort(defaultSortFunc);
                    }
        
                    itemsInSection.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'custom-search-item';
                        itemDiv.innerHTML = `
                            ${item.name}
                            <small>‡¶∏‡ßá‡¶ï‡¶∂‡¶®: ${item.section} (‡¶∏‡ßç‡¶ü‡¶ï: ${toBengaliNumber(item.quantity)} ${item.unit})</small>
                        `;
                        itemDiv.onclick = () => selectItem(input, item);
                        resultsContainer.appendChild(itemDiv);
                    });
                });
                resultsContainer.classList.add('show');
                return;
            }
        
            // ‡¶Ø‡¶¶‡¶ø ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶¨‡¶ï‡ßç‡¶∏‡ßá ‡¶≤‡ßá‡¶ñ‡¶æ ‡¶•‡¶æ‡¶ï‡ßá (‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡¶ø‡¶Ç)
            const filtered = allItems.filter(item => item.name.toLowerCase().includes(searchTerm));
            
            if (filtered.length > 0) {
                filtered.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'custom-search-item';
                    itemDiv.innerHTML = `
                        ${item.name}
                        <small>‡¶∏‡ßá‡¶ï‡¶∂‡¶®: ${item.section} (‡¶∏‡ßç‡¶ü‡¶ï: ${toBengaliNumber(item.quantity)} ${item.unit})</small>
                    `;
                    itemDiv.onclick = () => selectItem(input, item);
                    resultsContainer.appendChild(itemDiv);
                });
                resultsContainer.classList.add('show');
            } else {
                resultsContainer.classList.remove('show');
            }
        }
        
        function selectItem(input, item) {
            const formCard = input.closest('.item-form-card');
            input.value = item.name;
            formCard.querySelector('.selected-item-id').value = item.id;
            formCard.querySelector('.custom-search-results').classList.remove('show');
            formCard.querySelector('.pi-quantity-dynamic').focus();
        
            const modal = document.getElementById('provideItemModal');
            modal.classList.remove('modal-expanded');
            modal.classList.add('modal-compact');
        }


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('merge-btn').addEventListener('click', () => processDataImport(true));
            document.getElementById('replace-btn').addEventListener('click', () => processDataImport(false));
            document.getElementById('confirm-reset-1').addEventListener('click', () => {
                document.getElementById('reset-confirm-dialog-1').classList.remove('show');
                document.getElementById('reset-confirm-dialog-2').classList.add('show');
            });
            document.getElementById('confirm-reset-2').addEventListener('click', executeHardReset);
        
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('custom-search-input')) {
                    return;
                }
                const openSearchResults = document.querySelectorAll('.custom-search-results.show');
                openSearchResults.forEach(container => {
                    const searchWrapper = container.closest('.custom-search-container');
                    if (searchWrapper && !searchWrapper.contains(event.target)) {
                        container.classList.remove('show');
                    }
                });
            });
        
            const backToTopBtn = document.getElementById('back-to-top-btn');
            const scrollToBottomBtn = document.getElementById('scroll-to-bottom-btn');
            if (backToTopBtn && scrollToBottomBtn) {
                const stopSlowScroll = () => {
                    if (slowScrollAnimationId) {
                        cancelAnimationFrame(slowScrollAnimationId);
                        slowScrollAnimationId = null;
                    }
                };
                window.addEventListener('wheel', stopSlowScroll, { passive: true });
                window.addEventListener('touchstart', stopSlowScroll, { passive: true });
                window.onscroll = () => {
                    const scrollPosition = document.documentElement.scrollTop || document.body.scrollTop;
                    const totalHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                    if (scrollPosition > 200) {
                        backToTopBtn.classList.add('show');
                    } else {
                        backToTopBtn.classList.remove('show');
                    }
                    if (scrollPosition < totalHeight - 200) {
                        scrollToBottomBtn.classList.add('show');
                    } else {
                        scrollToBottomBtn.classList.remove('show');
                        stopSlowScroll();
                    }
                };
                backToTopBtn.addEventListener('click', () => {
                    stopSlowScroll();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
                scrollToBottomBtn.addEventListener('click', () => {
                    stopSlowScroll(); 
                    const startPosition = window.scrollY;
                    const distance = document.documentElement.scrollHeight - startPosition - window.innerHeight;
                    if (distance <= 0) return;
                    const scrollSpeed = 10;
                    let currentPosition = startPosition;
                    const step = () => {
                        currentPosition += scrollSpeed;
                        window.scrollTo(0, currentPosition);
                        if (currentPosition < document.documentElement.scrollHeight - window.innerHeight) {
                            slowScrollAnimationId = requestAnimationFrame(step);
                        } else {
                            slowScrollAnimationId = null;
                        }
                    };
                    slowScrollAnimationId = requestAnimationFrame(step);
                });
            }
        
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
        
                const runMainApp = async () => {
                    const dbPath = getDbPath();
                    if (navigator.onLine && dbPath) {
                        try {
                            const settingsDoc = await dbPath.collection('app_state').doc('settings').get();
                            if (settingsDoc.exists) {
                                onlineAppVersion = settingsDoc.data().app_version;
                            }
                        } catch (error) {
                            console.error("Error fetching app version:", error);
                        }
                    }
        
                    if (onlineAppVersion && onlineAppVersion !== CURRENT_APP_VERSION) {
                        document.getElementById('forceUpdateModal').style.display = 'flex';
                        document.getElementById('update-now-btn').onclick = () => {
                            window.location.reload(true);
                        };
                    } else {
                        showApp();
                    }
                };
        
                if (user) {
                    runMainApp();
                } else {
                    const hasLocalData = (localStorage.getItem('items') || '[]').length > 2 || (localStorage.getItem('sections') || '[]').length > 2;
                    if (hasLocalData) {
                        showToast('‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ñ‡¶® ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶Ü‡¶õ‡ßá‡¶®‡•§', 'warning');
                        showApp();
                    } else {
                        showLogin();
                    }
                }
            });
        });
        
        function showApp() {
            document.getElementById('main-app-wrapper').style.display = 'block';
            document.documentElement.style.overflow = '';
            document.body.style.overflow = '';
            document.getElementById('auth-modal-overlay').style.display = 'none';
            document.getElementById('main-app-wrapper').style.filter = 'none';
            document.getElementById('main-app-wrapper').style.pointerEvents = 'auto';
        
            if (currentUser && getDbPath()) {
                listenForLiveUpdates();
            } else {
                offlineDB.init();
            }
        }
        
        function showLogin() {
            document.getElementById('main-app-wrapper').style.display = 'block';
            document.documentElement.style.overflow = 'hidden';
            document.body.style.overflow = 'hidden';
            document.getElementById('auth-modal-overlay').style.display = 'flex';
            document.getElementById('main-app-wrapper').style.filter = 'blur(5px)';
            document.getElementById('main-app-wrapper').style.pointerEvents = 'none';
            detachListeners();
            allItems = [], sections = [], users = [], ledger = [], archivedReports = [];
            renderInventoryPage();
            renderUsersPage();
            renderArchivedReports();
            updateSlidingNotifications();
        }

    </script>
</body>
</html>
